(()=>{var e={82(e){"use strict";e.exports=async(e,t)=>{e.postMessage(t)}},119(e){"use strict";e.exports={workerBlobURL:!0,logger:()=>{}}},171(e){"use strict";e.exports={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3}},243(e){"use strict";e.exports=({workerPath:e,workerBlobURL:t})=>{let n;if(Blob&&URL&&t){const t=new Blob([`importScripts("${e}");`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(t))}else n=new Worker(e);return n}},294(e,t,n){"use strict";const o="browser"===n(359)("type")?e=>new URL(e,window.location.href).href:e=>e;e.exports=e=>{const t={...e};return["corePath","workerPath","langPath"].forEach(n=>{e[n]&&(t[n]=o(t[n]))}),t}},359(e){"use strict";e.exports=e=>{const t={};return"undefined"!=typeof WorkerGlobalScope?t.type="webworker":"object"==typeof document?t.type="browser":"object"==typeof process&&(t.type="node"),void 0===e?t:t[e]}},362(e){"use strict";e.exports=(e,t)=>{e.onmessage=({data:e})=>{t(e)}}},397(e){"use strict";e.exports=(e,t)=>`${e}-${t}-${Math.random().toString(16).slice(3,8)}`},398(e,t,n){"use strict";n(473);const o=n(811),a=n(886),r=n(456),i=n(639),s=n(171),l=n(928),{setLogging:c}=n(866);e.exports={languages:i,OEM:s,PSM:l,createScheduler:o,createWorker:a,setLogging:c,...r}},403(e){"use strict";e.exports=e=>{e.terminate()}},456(e,t,n){"use strict";const o=n(886);e.exports={recognize:async(e,t,n)=>{const a=await o(t,1,n);return a.recognize(e).finally(async()=>{await a.terminate()})},detect:async(e,t)=>{const n=await o("osd",0,t);return n.detect(e).finally(async()=>{await n.terminate()})}}},473(e){var t=function(e){"use strict";var t,n=Object.prototype,o=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",s=r.asyncIterator||"@@asyncIterator",l=r.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function d(e,t,n,o){var r=t&&t.prototype instanceof y?t:y,i=Object.create(r.prototype),s=new R(o||[]);return a(i,"_invoke",{value:S(e,n,s)}),i}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u="suspendedStart",g="suspendedYield",h="executing",f="completed",m={};function y(){}function b(){}function x(){}var w={};c(w,i,function(){return this});var C=Object.getPrototypeOf,v=C&&C(C(O([])));v&&v!==n&&o.call(v,i)&&(w=v);var _=x.prototype=y.prototype=Object.create(w);function E(e){["next","throw","return"].forEach(function(t){c(e,t,function(e){return this._invoke(t,e)})})}function k(e,t){function n(a,r,i,s){var l=p(e[a],e,r);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==typeof d&&o.call(d,"__await")?t.resolve(d.__await).then(function(e){n("next",e,i,s)},function(e){n("throw",e,i,s)}):t.resolve(d).then(function(e){c.value=e,i(c)},function(e){return n("throw",e,i,s)})}s(l.arg)}var r;a(this,"_invoke",{value:function(e,o){function a(){return new t(function(t,a){n(e,o,t,a)})}return r=r?r.then(a,a):a()}})}function S(e,t,n){var o=u;return function(a,r){if(o===h)throw new Error("Generator is already running");if(o===f){if("throw"===a)throw r;return T()}for(n.method=a,n.arg=r;;){var i=n.delegate;if(i){var s=L(i,n);if(s){if(s===m)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===u)throw o=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=h;var l=p(e,t,n);if("normal"===l.type){if(o=n.done?f:g,l.arg===m)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(o=f,n.method="throw",n.arg=l.arg)}}}function L(e,n){var o=n.method,a=e.iterator[o];if(a===t)return n.delegate=null,"throw"===o&&e.iterator.return&&(n.method="return",n.arg=t,L(e,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),m;var r=p(a,e.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,m;var i=r.arg;return i?i.done?(n[e.resultName]=i.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function O(e){if(e){var n=e[i];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,r=function n(){for(;++a<e.length;)if(o.call(e,a))return n.value=e[a],n.done=!1,n;return n.value=t,n.done=!0,n};return r.next=r}}return{next:T}}function T(){return{value:t,done:!0}}return b.prototype=x,a(_,"constructor",{value:x,configurable:!0}),a(x,"constructor",{value:b,configurable:!0}),b.displayName=c(x,l,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,c(e,l,"GeneratorFunction")),e.prototype=Object.create(_),e},e.awrap=function(e){return{__await:e}},E(k.prototype),c(k.prototype,s,function(){return this}),e.AsyncIterator=k,e.async=function(t,n,o,a,r){void 0===r&&(r=Promise);var i=new k(d(t,n,o,a),r);return e.isGeneratorFunction(n)?i:i.next().then(function(e){return e.done?e.value:i.next()})},E(_),c(_,l,"Generator"),c(_,i,function(){return this}),c(_,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},e.values=O,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(A),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function a(o,a){return s.type="throw",s.arg=e,n.next=o,a&&(n.method="next",n.arg=t),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],s=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var l=o.call(i,"catchLoc"),c=o.call(i,"finallyLoc");if(l&&c){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&o.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var r=a;break}}r&&("break"===e||"continue"===e)&&r.tryLoc<=t&&t<=r.finallyLoc&&(r=null);var i=r?r.completion:{};return i.type=e,i.arg=t,r?(this.method="next",this.next=r.finallyLoc,m):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var a=o.arg;A(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,o){return this.delegate={iterator:O(e),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=t),m}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}},502(e,t,n){"use strict";const o=n(561),a=n(243),r=n(403),i=n(362),s=n(82),l=n(835);e.exports={defaultOptions:o,spawnWorker:a,terminateWorker:r,onMessage:i,send:s,loadImage:l}},539(e){"use strict";e.exports={rE:"7.0.0"}},561(e,t,n){"use strict";const o=n(539).rE,a=n(119);e.exports={...a,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${o}/dist/worker.min.js`}},633(e,t,n){"use strict";const o=n(397);let a=0;e.exports=({id:e,action:t,payload:n={}})=>{let r=e;return void 0===r&&(r=o("Job",a),a+=1),{id:r,action:t,payload:n}}},639(e){"use strict";e.exports={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"}},811(e,t,n){"use strict";const o=n(633),{log:a}=n(866),r=n(397);let i=0;e.exports=()=>{const e=r("Scheduler",i),t={},n={};let s=[];i+=1;const l=()=>Object.keys(t).length,c=()=>{if(0!==s.length){const e=Object.keys(t);for(let o=0;o<e.length;o+=1)if(void 0===n[e[o]]){s[0](t[e[o]]);break}}},d=(t,r)=>new Promise((i,l)=>{const d=o({action:t,payload:r});s.push(async e=>{s.shift(),n[e.id]=d;try{i(await e[t].apply(this,[...r,d.id]))}catch(e){l(e)}finally{delete n[e.id],c()}}),a(`[${e}]: Add ${d.id} to JobQueue`),a(`[${e}]: JobQueue length=${s.length}`),c()});return{addWorker:n=>(t[n.id]=n,a(`[${e}]: Add ${n.id}`),a(`[${e}]: Number of workers=${l()}`),c(),n.id),addJob:async(t,...n)=>{if(0===l())throw Error(`[${e}]: You need to have at least one worker before adding jobs`);return d(t,n)},terminate:async()=>{Object.keys(t).forEach(async e=>{await t[e].terminate()}),s=[]},getQueueLen:()=>s.length,getNumWorkers:l}}},835(e){"use strict";const t=e=>new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{t(o.result)},o.onerror=({target:{error:{code:e}}})=>{n(Error(`File could not be read! Code=${e}`))},o.readAsArrayBuffer(e)}),n=async e=>{let o=e;if(void 0===e)return"undefined";if("string"==typeof e)if(/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(e))o=atob(e.split(",")[1]).split("").map(e=>e.charCodeAt(0));else{const t=await fetch(e);o=await t.arrayBuffer()}else if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)"IMG"===e.tagName&&(o=await n(e.src)),"VIDEO"===e.tagName&&(o=await n(e.poster)),"CANVAS"===e.tagName&&await new Promise(n=>{e.toBlob(async e=>{o=await t(e),n()})});else if("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){const n=await e.convertToBlob();o=await t(n)}else(e instanceof File||e instanceof Blob)&&(o=await t(e));return new Uint8Array(o)};e.exports=n},866(e,t){"use strict";let n=!1;t.logging=n,t.setLogging=e=>{n=e},t.log=(...e)=>n?console.log.apply(this,e):null},886(e,t,n){"use strict";const o=n(294),a=n(633),{log:r}=n(866),i=n(397),s=n(171),{defaultOptions:l,spawnWorker:c,terminateWorker:d,onMessage:p,loadImage:u,send:g}=n(502);let h=0;e.exports=async(e="eng",t=s.LSTM_ONLY,n={},f={})=>{const m=i("Worker",h),{logger:y,errorHandler:b,...x}=o({...l,...n}),w={},C="string"==typeof e?e.split("+"):e;let v=t,_=f;const E=[s.DEFAULT,s.LSTM_ONLY].includes(t)&&!x.legacyCore;let k,S;const L=new Promise((e,t)=>{S=e,k=t});let I=c(x);I.onerror=e=>{k(e.message)},h+=1;const A=({id:e,action:t,payload:n})=>new Promise((o,a)=>{r(`[${m}]: Start ${e}, action=${t}`),w[`${t}-${e}`]={resolve:o,reject:a},g(I,{workerId:m,jobId:e,action:t,payload:n})}),R=(e,t)=>A(a({id:t,action:"loadLanguage",payload:{langs:e,options:{langPath:x.langPath,dataPath:x.dataPath,cachePath:x.cachePath,cacheMethod:x.cacheMethod,gzip:x.gzip,lstmOnly:[s.DEFAULT,s.LSTM_ONLY].includes(v)&&!x.legacyLang}}})),O=(e,t,n,o)=>A(a({id:o,action:"initialize",payload:{langs:e,oem:t,config:n}}));p(I,({workerId:e,jobId:t,status:n,action:o,data:a})=>{const i=`${o}-${t}`;if("resolve"===n)r(`[${e}]: Complete ${t}`),w[i].resolve({jobId:t,data:a}),delete w[i];else if("reject"===n){if(w[i].reject(a),delete w[i],"load"===o&&k(a),!b)throw Error(a);b(a)}else"progress"===n&&y({...a,userJobId:t})});const T={id:m,worker:I,load:()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),writeText:(e,t,n)=>A(a({id:n,action:"FS",payload:{method:"writeFile",args:[e,t]}})),readText:(e,t)=>A(a({id:t,action:"FS",payload:{method:"readFile",args:[e,{encoding:"utf8"}]}})),removeFile:(e,t)=>A(a({id:t,action:"FS",payload:{method:"unlink",args:[e]}})),FS:(e,t,n)=>A(a({id:n,action:"FS",payload:{method:e,args:t}})),reinitialize:(e="eng",t,n,o)=>{if(E&&[s.TESSERACT_ONLY,s.TESSERACT_LSTM_COMBINED].includes(t))throw Error("Legacy model requested but code missing.");const a=t||v;v=a;const r=n||_;_=r;const i=("string"==typeof e?e.split("+"):e).filter(e=>!C.includes(e));return C.push(...i),i.length>0?R(i,o).then(()=>O(e,a,r,o)):O(e,a,r,o)},setParameters:(e={},t)=>A(a({id:t,action:"setParameters",payload:{params:e}})),recognize:async(e,t={},n={text:!0},o)=>A(a({id:o,action:"recognize",payload:{image:await u(e),options:t,output:n}})),detect:async(e,t)=>{if(E)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return A(a({id:t,action:"detect",payload:{image:await u(e)}}))},terminate:async()=>(null!==I&&(d(I),I=null),Promise.resolve())};return A(a({id:undefined,action:"load",payload:{options:{lstmOnly:E,corePath:x.corePath,logging:x.logging}}})).then(()=>R(e)).then(()=>O(e,t,f)).then(()=>S(T)).catch(()=>{}),L}},928(e){"use strict";e.exports={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"}}},t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports}(()=>{"use strict";var e=n(398);async function t(e,t={}){const n=t.scale||2;let o,a,r;if(e instanceof ImageData){a=e.width,r=e.height;const t=document.createElement("canvas");t.width=a,t.height=r;const n=t.getContext("2d");try{n.putImageData(e,0,0)}catch(t){try{const t=n.createImageData(e.width,e.height);t.data.set(new Uint8ClampedArray(e.data)),n.putImageData(t,0,0)}catch(e){throw console.error("Resize stage failed to process image data",e),e}}o=t}else{if(!(e instanceof HTMLCanvasElement))throw new Error("Invalid input type for resizeStage");o=e,a=o.width,r=o.height}const i=a*n,s=r*n,l=document.createElement("canvas");l.width=i,l.height=s;const c=l.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(o,0,0,i,s);try{return c.getImageData(0,0,i,s)}catch(e){return console.warn("Resize stage output tainted. Returning canvas reference (unsafe).",e),l}}function o(e){if(!(e&&"object"==typeof e&&"data"in e&&"width"in e&&"height"in e))throw console.error("Invalid input to getSafeImageData",e),new Error("Input must be ImageData (or have data/width/height)");try{return structuredClone(e)}catch(e){}try{const t=new Uint8ClampedArray(e.data);return new ImageData(t,e.width,e.height)}catch(e){}try{const t=e.data.slice(0);return new ImageData(t,e.width,e.height)}catch(e){throw console.error("Failed to clean ImageData",e),e}}async function a(e,t={}){let n,a,r;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)a=e.width,r=e.height,n=o(e.getContext("2d").getImageData(0,0,a,r)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for contrast stage");a=e.width,r=e.height,n=e instanceof ImageData?o(e).data:new Uint8ClampedArray(e.data)}const i=new Uint8ClampedArray(n),s=new Array(256).fill(0);for(let e=0;e<n.length;e+=4){if(0===n[e+3])continue;const t=n[e],o=n[e+1],a=n[e+2],r=Math.round(.299*t+.587*o+.114*a);s[Math.min(255,Math.max(0,r))]++}const l=a*r;let c=0,d=0,p=255;for(let e=0;e<256;e++)if(c+=s[e],c>.01*l){d=e;break}c=0;for(let e=255;e>=0;e--)if(c+=s[e],c>.01*l){p=e;break}p=p<200?255:Math.max(p,240);const u=p-d;if(u<=0)return new ImageData(i,a,r);const g=255/u;for(let e=0;e<i.length;e+=4)0!==i[e+3]&&(i[e]=Math.max(0,Math.min(255,(i[e]-d)*g)),i[e+1]=Math.max(0,Math.min(255,(i[e+1]-d)*g)),i[e+2]=Math.max(0,Math.min(255,(i[e+2]-d)*g)));return new ImageData(i,a,r)}function r(e){let t,n,a;try{if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName){n=e.width,a=e.height;try{t=o(e.getContext("2d").getImageData(0,0,n,a)).data}catch(t){return console.error("Grayscale Stage: Failed to extract ImageData",t),e}}else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))return console.warn("Invalid input type for grayscale stage:",e),e;n=e.width,a=e.height;try{t=e instanceof ImageData?o(e).data:new Uint8ClampedArray(e.data)}catch(t){return console.error("Grayscale Stage: Failed to copy ImageData",t),e}}if(!t)return e;const r=new Uint8ClampedArray(t.length);for(let e=0;e<t.length;e+=4){const n=.299*t[e]+.587*t[e+1]+.114*t[e+2];r[e]=n,r[e+1]=n,r[e+2]=n,r[e+3]=t[e+3]}return new ImageData(r,n,a)}catch(t){return console.error("Grayscale critical error:",t),e}}function i(e){let t,n,a;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)n=e.width,a=e.height,t=o(e.getContext("2d").getImageData(0,0,n,a)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for blur stage");n=e.width,a=e.height,t=e instanceof ImageData?o(e).data:new Uint8ClampedArray(e.data)}const r=new Uint8ClampedArray(t.length);r.fill(0),r.set(t);const i=(e,t)=>4*(t*n+e);for(let e=1;e<a-1;e++)for(let o=1;o<n-1;o++){const n=i(o,e),a=[],s=[],l=[];for(let n=-1;n<=1;n++)for(let r=-1;r<=1;r++){const c=i(o+r,e+n);a.push(t[c]),s.push(t[c+1]),l.push(t[c+2])}a.sort((e,t)=>e-t),s.sort((e,t)=>e-t),l.sort((e,t)=>e-t),r[n]=a[4],r[n+1]=s[4],r[n+2]=l[4]}return new ImageData(r,n,a)}function s(e,t={}){const{blockSize:n=15,constant:a=10}=t;let r,i,s;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)r=e.width,i=e.height,s=o(e.getContext("2d").getImageData(0,0,r,i)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for threshold stage");r=e.width,i=e.height,s=e instanceof ImageData?o(e).data:new Uint8ClampedArray(e.data)}const l=new Uint8ClampedArray(s.length),c=new Int32Array(r*i);let d=0;for(let e=0;e<r;e++)d+=s[4*e],c[e]=d;for(let e=1;e<i;e++){d=0;for(let t=0;t<r;t++)d+=s[4*(e*r+t)],c[e*r+t]=c[(e-1)*r+t]+d}const p=(e,t,n,o)=>(e=Math.max(0,e),t=Math.max(0,t),n=Math.min(r-1,n),o=Math.min(i-1,o),e>0&&t>0&&c[(t-1)*r+(e-1)],t>0&&c[(t-1)*r+o],c[o*r+n]-(t>0?c[(t-1)*r+n]:0)-(e>0?c[o*r+(e-1)]:0)+(e>0&&t>0?c[(t-1)*r+(e-1)]:0)),u=Math.floor(n/2);for(let e=0;e<i;e++)for(let t=0;t<r;t++){const n=4*(e*r+t),o=t-u,c=e-u,d=t+u,g=e+u,h=(Math.min(r-1,d)-Math.max(0,o)+1)*(Math.min(i-1,g)-Math.max(0,c)+1),f=p(o,c,d,g)/h;s[n]<f-a?(l[n]=0,l[n+1]=0,l[n+2]=0):(l[n]=255,l[n+1]=255,l[n+2]=255),l[n+3]=255}return new ImageData(l,r,i)}function l(e,t={}){const{type:n="open",kernelSize:a=1}=t;let r,i,s;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)i=e.width,s=e.height,r=o(e.getContext("2d").getImageData(0,0,i,s));else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for morphology stage");r=e instanceof ImageData?o(e):new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}return"open"===n&&(r=function(e,t){const n=e.width,o=e.height,a=e.data,r=new Uint8ClampedArray(a.length);r.fill(255);for(let e=0;e<o;e++)for(let i=0;i<n;i++){let s=!0;for(let r=-t;r<=t;r++){for(let l=-t;l<=t;l++){const t=i+l,c=e+r;if(!(t>=0&&t<n&&c>=0&&c<o)){s=!1;break}if(a[4*(c*n+t)]>128){s=!1;break}}if(!s)break}if(s){const t=4*(e*n+i);r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=255}}return new ImageData(r,n,o)}(r,a),r=function(e,t){const n=e.width,o=e.height,a=e.data,r=new Uint8ClampedArray(a.length);r.fill(255);for(let e=0;e<o;e++)for(let i=0;i<n;i++){let s=!1;for(let r=-t;r<=t;r++){for(let l=-t;l<=t;l++){const t=i+l,c=e+r;if(t>=0&&t<n&&c>=0&&c<o&&a[4*(c*n+t)]<128){s=!0;break}}if(s)break}if(s){const t=4*(e*n+i);r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=255}}return new ImageData(r,n,o)}(r,a)),r}function c(e){let t,n,a;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)t=e.width,n=e.height,a=o(e.getContext("2d").getImageData(0,0,t,n)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for region stage");t=e.width,n=e.height,a=e instanceof ImageData?o(e).data:new Uint8ClampedArray(e.data)}const r=new Uint8ClampedArray(a.length);r.fill(255);const i=new Uint8Array(t*n),s=[],l=(e,n)=>n*t+e;for(let e=0;e<n;e++)for(let o=0;o<t;o++){const r=l(o,e);if(i[r])continue;if(!(a[4*r]>128)){i[r]=1;continue}const c=[],d=[r];i[r]=1,c.push(r);let p=0;for(;p<d.length;){const e=d[p++],o=e%t,r=Math.floor(e/t),s=[{x:o+1,y:r},{x:o-1,y:r},{x:o,y:r+1},{x:o,y:r-1}];for(const e of s)if(e.x>=0&&e.x<t&&e.y>=0&&e.y<n){const t=l(e.x,e.y);i[t]||a[4*t]>128&&(i[t]=1,d.push(t),c.push(t))}}s.push(c)}if(0===s.length)return e;s.sort((e,t)=>t.length-e.length);const c=s[0],d=new Uint8Array(t*n);for(const e of c)d[e]=1;const p=new Uint8Array(t*n);for(let e=0;e<n;e++)for(let o=0;o<t;o++){const a=l(o,e);if(1===d[a]||p[a])continue;const r=[],i=[a];p[a]=1,r.push(a);let s=!1;0!==o&&o!==t-1&&0!==e&&e!==n-1||(s=!0);let c=0;for(;c<i.length;){const e=i[c++],o=e%t,a=Math.floor(e/t),u=[{x:o+1,y:a},{x:o-1,y:a},{x:o,y:a+1},{x:o,y:a-1}];for(const e of u)if(e.x>=0&&e.x<t&&e.y>=0&&e.y<n){const o=l(e.x,e.y);p[o]||0!==d[o]||(p[o]=1,i.push(o),r.push(o),0!==e.x&&e.x!==t-1&&0!==e.y&&e.y!==n-1||(s=!0))}}if(!s)for(const e of r)d[e]=1}for(let e=0;e<t*n;e++)1===d[e]?(r[4*e]=a[4*e],r[4*e+1]=a[4*e+1],r[4*e+2]=a[4*e+2],r[4*e+3]=255):(r[4*e]=255,r[4*e+1]=255,r[4*e+2]=255,r[4*e+3]=255);return new ImageData(r,t,n)}const d=new Set(["the","be","to","of","and","a","in","that","have","i","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from","they","we","say","her","she","or","an","will","my","one","all","would","there","their","what","so","up","out","if","about","who","get","which","go","me","when","make","can","like","time","no","just","him","know","take","people","into","year","your","good","some","could","them","see","other","than","then","now","look","only","come","its","over","think","also","back","after","use","two","how","our","work","first","well","way","even","new","want","because","any","these","give","day","most","us","is","was","are","were","been","has","had","did","does","said","made","went","got","took","came","gave","thought","saw","knew","told","asked","found","left","ran","sat","stood","fell","kept","held","let","hello","world"]),p=new class{constructor(){this.dictionaries=new Map,this.loaded=!1}async load(e="eng"){this.dictionaries.has(e)||(this.dictionaries.set("eng",new Set(d)),this.loaded=!0)}has(e,t="eng"){const n=this.dictionaries.get(t);return!!n&&n.has(e.toLowerCase())}get(e="eng"){return this.dictionaries.get(e)}};function u(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let o=1;o<=t.length;o++)for(let a=1;a<=e.length;a++)t.charAt(o-1)===e.charAt(a-1)?n[o][a]=n[o-1][a-1]:n[o][a]=Math.min(n[o-1][a-1]+1,n[o][a-1]+1,n[o-1][a]+1);return n[t.length][e.length]}function g(e){return"string"!=typeof e?"":e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function h(e,t={}){if(!e)return e;let n=e;return!1!==t.noiseCleaning&&(n=function(e,t={}){if(!e)return e;const n=t.noiseAggression||"medium";let o=e.split("\n");return o=o.map(e=>{let t=e.trim();return t=t.replace(/^[|_=\u2014\-]+/,""),t=t.replace(/[|_=\u2014\-]+$/,""),/^[^a-zA-Z0-9]+$/.test(t)?/^[.?!]+$/.test(t)||t.includes("~")||"low"===n&&t.includes("-")?t:"":(t=t.split(" ").map(e=>1===e.length?/[a-zA-Z0-9]/.test(e)||/[.,;?!'"~]/.test(e)?e:/[|\\/=_\-]/.test(e)?"":"low"===n&&/[$â‚¬Â£%&+]/.test(e)?e:"":/^[|\\/=_\-]+$/.test(e)?"":e).join(" "),t.trim())}),o.filter(e=>e.length>0).join("\n")}(n,{noiseAggression:t.noiseAggression})),!1!==t.normalizeText&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/[ \t]+/g," "),t=t.replace(/\s+([.,!?:;)}\]])/g,"$1"),t=t.replace(/([({[])\s+/g,"$1"),t=t.replace(/([.,!?:;])([a-zA-Z])/g,"$1 $2"),t=t.trim(),t}(n)),!0===t.manhwaMode&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/\b[A-Z](?: [A-Z])+\b/g,e=>e.replace(/ /g,"")),t.split(/\n\s*\n/).map(e=>{let t=e;return t=t.replace(/-\n/g,""),t=t.replace(/\n/g," "),t=t.replace(/\s+/g," ").trim(),t=t.replace(/\s+([.,;?!])/g,"$1"),t}).join("\n\n")}(n)),!1!==t.regexCorrection&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/[ \t]+/g," "),t=t.replace(/ ([.,;:!?])/g,"$1"),t=t.replace(/\( /g,"(").replace(/ \)/g,")"),t=t.replace(/\b[l1]\b(?= am| have| don't| will)/g,"I"),t=t.replace(/^\|\s*/gm,"").replace(/\s*\|$/gm,""),t.trim()}(n)),!0===t.dictionaryCorrection&&(n=function(e,t={}){if(!e)return e;const n=!1!==t.ignoreAllCaps,o=t.dictionaryStrength||1;if(!p.loaded)return e;const a=p.get("eng");return e.replace(/[a-zA-Z]+/g,e=>{if(e.length<3)return e;const t=/^[A-Z]+$/.test(e);if(n&&t)return e;if(p.has(e))return e;const r=function(e,t,n=2){let o=null,a=1/0;const r=(Set,t);for(const t of r){if(Math.abs(t.length-e.length)>n)continue;if(t===e)return e;const r=u(e,t);r<=n&&r<a&&(a=r,o=t)}return o}(e.toLowerCase(),a,o);return r?function(e,t){return e===e.toUpperCase()?t.toUpperCase():e[0]===e[0].toUpperCase()?t.charAt(0).toUpperCase()+t.slice(1):t}(e,r):e})}(n,{ignoreAllCaps:t.dictionaryIgnoreCaps,dictionaryStrength:t.dictionaryStrength})),!1!==t.userRules&&(n=function(e,t={}){if(!e)return e;let n=e;const o=Array.isArray(t.deletions)?t.deletions:[],a=Array.isArray(t.replacements)?t.replacements:[];return o.length>0&&o.forEach(e=>{let t,o,a,r;if("object"==typeof e&&null!==e){if(t=e.char,!t)return;o=!0===e.ignoreBetweenLetters,a=!0===e.ignoreBetweenNumbers,r=!0===e.ignoreInsideWords}else{if("string"!=typeof e)return;t=e,o=!1,a=!1,r=!1}if(!o&&!a&&!r)return void(n=n.split(t).join(""));const i=g(t),s=new RegExp(i,"g");n=n.replace(s,(e,t,n)=>{const i=n[t-1]||"",s=n[t+e.length]||"",l=/[a-zA-Z\u00C0-\u00FF]/.test(i),c=/[a-zA-Z\u00C0-\u00FF]/.test(s),d=/[0-9]/.test(i),p=/[0-9]/.test(s);return o&&l&&c||a&&d&&p||r&&(l||d)&&(c||p)?e:""})}),a.length>0&&a.forEach(e=>{if(!1!==e.enabled&&e.find)try{let t,o=e.find,a="g";if(e.caseSensitive||(a+="i"),e.isRegex)t=new RegExp(o,a);else{let n=g(o);if(e.wholeWord){const e=/\w/.test(o[0]),t=/\w/.test(o[o.length-1]);e&&(n=`\\b${n}`),t&&(n=`${n}\\b`)}t=new RegExp(n,a)}const r=e.replace||"";n=n.replace(t,r)}catch(t){console.warn(`Text Processing: Invalid regex rule "${e.find}"`,t)}}),n}(n,{deletions:t.deletions,replacements:t.replacements})),!1!==t.textReconstruction&&(n=function(e,t={}){if(!e)return e;let n=e;if(!1!==t.mergeLines){const e=n.split(/\n\s*\n/);n=e.map(e=>e.replace(/\n/g," ")).join("\n\n")}return!1!==t.stabilizeSentences&&(n=n.replace(/(\w+)-\s+(\w+)/g,"$1$2")),n}(n,{mergeLines:t.reconstructMergeLines,stabilizeSentences:t.reconstructStabilize})),n}const f="ocr_settings_data_v3",m={name:"Default",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,preprocess_morphology:!1,preprocess_borders:!1,tess_psm:"3",tess_oem:"1",tess_lang:"eng",tess_whitelist:"",auto_psm:!1,clean_noise:!0,noise_aggression:"medium",clean_normalize:!0,clean_regex:!0,clean_dict:!1,dict_strength:1,dict_ignore_caps:!0,clean_user:!0,manhwa_mode:!1,reconstruct_text:!0,reconstruct_merge:!0,reconstruct_stabilize:!0,debug_mode:!1,popup_hidden_buttons:[],user_replacements:[],user_deletions:[]},y={...m,name:"Manhwa Mode",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,clean_dict:!1,manhwa_mode:!0,reconstruct_merge:!0,reconstruct_stabilize:!0},b={active_profile_id:"default",floating_button_enabled:!0,floating_button_mode:"blacklist",floating_button_blacklist:[],floating_button_whitelist:[],enable_multiselect:!1};async function x(e=null){const t=await E(),n=t.global.active_profile_id;let o=t.profiles[n];o||(o=t.profiles.default||{...m});const a={...t.global,...o,_profileId:n};return Array.isArray(e)?e.reduce((e,t)=>(e[t]=a[t],e),{}):a}async function w(e){const t=await E(),n=t.global.active_profile_id,o=Object.keys(b);let a=!1,r=!1;for(const[i,s]of Object.entries(e))o.includes(i)||"active_profile_id"===i?(t.global[i]=s,r=!0):(t.profiles[n]||(t.profiles[n]={...m}),t.profiles[n][i]=s,a=!0);return await browser.storage.local.set({[f]:t}),t}async function C(e,t=null){const n=await E(),o=`profile_${Date.now()}`;let a=m;return t&&n.profiles[t]&&(a=n.profiles[t]),n.profiles[o]={...a,name:e},await browser.storage.local.set({[f]:n}),o}async function v(e){const t=await E();return!!t.profiles[e]&&(t.global.active_profile_id=e,await browser.storage.local.set({[f]:t}),!0)}async function _(e){if("global"===e){const e=await x(["user_replacements","user_deletions"]);return{replacements:e.user_replacements||[],deletions:e.user_deletions||[]}}{const t=`user_replacements_${e}`,n=`user_deletions_${e}`,o=await browser.storage.local.get([t,n]);return{replacements:o[t]||[],deletions:o[n]||[]}}}async function E(){let e=(await browser.storage.local.get(f))[f];return e.profiles||(e={global:{...b},profiles:{default:{...m},manhwa:{...y}}}),e.profiles.manhwa||e.profiles.manhwa_v1||(e.profiles.manhwa={...y},await browser.storage.local.set({[f]:e})),e}const k={tess_psm:"3",tess_oem:"1",tess_whitelist:"",tess_lang:"eng",auto_psm:!1},S=new class{constructor(){this.cache={...k},this.listeners=[],this.loaded=!1}async load(){const e=Object.keys(k),t=await x(e);return this.cache={...k,...t},this.loaded=!0,this.cache}get(e){return this.cache[e]}async set(e,t){this.cache[e]=t,await w({[e]:t}),this.notifyListeners()}async setConfig(e){this.cache={...this.cache,...e},await w(e),this.notifyListeners()}onChange(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>e(this.cache))}getOptimalPSM(e,t){if(!this.cache.auto_psm)return this.cache.tess_psm;const n=e/t;return n>3?"7":n<.2?"5":"6"}},L={container:null,show(){this.container||this.create(),this.container.style.display="block"},hide(){this.container&&(this.container.style.display="none")},clear(){if(this.container){const e=this.container.querySelector(".debug-list");e&&(e.innerHTML="")}},create(){const e=document.createElement("div");e.id="ocr-debug-viewer",e.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            width: 350px;\n            max-height: 80vh;\n            background: rgba(30, 30, 30, 0.95);\n            border: 1px solid #444;\n            border-radius: 8px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n            z-index: 1000000;\n            display: flex;\n            flex-direction: column;\n            color: #eee;\n            font-family: sans-serif;\n            overflow: hidden;\n        ";const t=document.createElement("div");t.style.cssText="\n            padding: 10px;\n            background: #252526;\n            border-bottom: 1px solid #444;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        ",t.innerHTML="<strong>Preprocessing Debug</strong>";const n=document.createElement("button");n.textContent="Ã—",n.style.cssText="\n            background: none;\n            border: none;\n            color: #aaa;\n            font-size: 18px;\n            cursor: pointer;\n        ",n.onclick=()=>this.hide(),t.appendChild(n),e.appendChild(t);const o=document.createElement("div");o.className="debug-list",o.style.cssText="\n            flex: 1;\n            overflow-y: auto;\n            padding: 10px;\n        ",e.appendChild(o),document.body.appendChild(e),this.container=e},addStep(e,t){if(!this.container)return;const n=this.container.querySelector(".debug-list"),o=document.createElement("div");o.style.marginBottom="15px";const a=document.createElement("div");let r;if(a.textContent=e,a.style.fontSize="12px",a.style.marginBottom="5px",a.style.color="#ccc",o.appendChild(a),t instanceof HTMLCanvasElement){r=t;const e=document.createElement("canvas");e.width=r.width,e.height=r.height,e.getContext("2d").drawImage(r,0,0),r=e}else if(t instanceof ImageData){r=document.createElement("canvas"),r.width=t.width,r.height=t.height;try{r.getContext("2d").putImageData(t,0,0)}catch(e){const n=r.getContext("2d"),o=n.createImageData(t.width,t.height);o.data.set(new Uint8ClampedArray(t.data)),n.putImageData(o,0,0)}}r&&(r.style.maxWidth="100%",r.style.height="auto",r.style.border="1px solid #555",o.appendChild(r)),n.appendChild(o),n.scrollTop=n.scrollHeight}};async function I(n,d={}){try{const p=n.getContext("2d"),u=n.width,g=n.height;let f;try{f=o(p.getImageData(0,0,u,g))}catch(e){if("SecurityError"===e.name||e.message.includes("insecure"))throw console.warn("Canvas tainted. Attempting workaround via data URL."),new Error("Canvas tainted. Cannot extract image data for OCR.");throw e}await S.load();const m=await x(["preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","preprocess_borders","debug_mode","clean_noise","noise_aggression","clean_normalize","clean_regex","clean_dict","dict_strength","dict_ignore_caps","clean_user","manhwa_mode","reconstruct_text","reconstruct_merge","reconstruct_stabilize"]),y=!0===m.debug_mode;y&&(L.show(),L.clear(),L.addStep("Original",n));const b={resize:!1!==m.preprocess_resize,grayscale:!1!==m.preprocess_grayscale,contrast:!1!==m.preprocess_contrast,medianBlur:!1!==m.preprocess_blur,adaptiveThreshold:!1!==m.preprocess_threshold,morphology:!1!==m.preprocess_morphology,removeBorders:!1!==m.preprocess_borders,debug:y,onStep:(e,t)=>L.addStep(e,t),...d.image},w=await async function(e,n={}){const o=function(e){const n=[],o=(t,n)=>{e.debug&&e.onStep&&e.onStep(t,n)};return!1!==e.resize&&n.push({stage:t,options:{scale:e.scale||2},name:"resize",onComplete:o}),e.grayscale&&n.push({stage:r,name:"grayscale",onComplete:o}),e.medianBlur&&n.push({stage:i,name:"blur",onComplete:o}),e.contrast&&n.push({stage:a,options:{val:e.contrastVal||50},name:"contrast",onComplete:o}),e.adaptiveThreshold&&n.push({stage:s,options:{blockSize:15,constant:10},name:"threshold",onComplete:o}),e.morphology&&n.push({stage:l,options:{type:"open",kernelSize:1},name:"morphology",onComplete:o}),e.removeBorders&&n.push({stage:c,name:"region",onComplete:o}),n}(n);let d=await async function(e,t){let n=e;const o=e=>(ImageData,e);for(const e of t)try{"function"==typeof e?n=await e(n):e&&"function"==typeof e.stage&&(n=await e.stage(n,e.options||{}),e.onComplete&&e.onComplete(e.name||"Stage",o(n)))}catch(t){throw console.error(`Pipeline stage failed: ${e.name||("function"==typeof e?e.name:"unknown")}`,t),t}return n}(e,o);if(d instanceof HTMLCanvasElement){const e=d.getContext("2d");d=e.getImageData(0,0,d.width,d.height)}return d}(f,b),C=document.createElement("canvas");if(w instanceof ImageData){C.width=w.width,C.height=w.height;const e=C.getContext("2d");try{e.putImageData(w,0,0)}catch(t){try{const t=o(w);e.putImageData(t,0,0)}catch(e){throw console.error("Critical: Failed to process image data config for OCR engine",e),e}}}else if(w instanceof HTMLCanvasElement){C.width=w.width,C.height=w.height;const e=C.getContext("2d");try{e.drawImage(w,0,0)}catch(e){throw console.error("Critical: Failed to draw processed canvas to Tesseract input",e),e}}else{console.warn("Pipeline returned unknown object.");try{C.width=u,C.height=g,C.getContext("2d").putImageData(f,0,0)}catch(e){throw console.error("Critical: Failed to fallback to original image",e),e}}const v=await(0,e.createWorker)("eng");let E=3;try{S&&S.getOptimalPSM&&(E=S.getOptimalPSM(u,g))}catch(e){console.warn("Config PSM failed",e)}await v.setParameters({tessedit_pageseg_mode:E});let k={data:{text:"",confidence:0}};try{k=await v.recognize(C)}catch(e){throw console.error("Tesseract recognition failed",e),e}finally{await v.terminate()}const{data:{text:I,confidence:A}}=k,R=I?I.trim():"";let O="global";try{const e=window.location.origin;e&&"null"!==e&&(O=`site:${e}`)}catch(e){console.warn("Could not determine origin for rules scope")}const T=await async function(e){const t=await _("global");if(!e||"global"===e)return t;const n=await _(e);return{replacements:[...t.replacements,...n.replacements],deletions:[...t.deletions,...n.deletions]}}(O);return{text:h(R,{noiseCleaning:!1!==m.clean_noise,noiseAggression:m.noise_aggression||"medium",normalizeText:!1!==m.clean_normalize,textReconstruction:!0===m.reconstruct_text,reconstructMergeLines:!1!==m.reconstruct_merge,reconstructStabilize:!1!==m.reconstruct_stabilize,regexCorrection:!1!==m.clean_regex,dictionaryCorrection:!0===m.clean_dict,dictionaryStrength:void 0!==m.dict_strength?m.dict_strength:1,dictionaryIgnoreCaps:!1!==m.dict_ignore_caps,userRules:!1!==m.clean_user,replacements:T.replacements,deletions:T.deletions,manhwaMode:!0===m.manhwa_mode,...d}),originalText:R,confidence:A}}catch(e){throw console.error("OCR/Pipeline processing failed:",e),e}}function A(e,t="110px",n="32px",o=null){const a=document.createElement("button");return a.textContent=e,a.style.width=t,a.style.height=n,a.style.padding="4px 8px",a.style.backgroundColor="#374151",a.style.color="#f9fafb",a.style.border="1px solid #4b5563",a.style.borderRadius="6px",a.style.cursor="pointer",a.style.fontSize="14px",a.style.fontWeight="600",a.style.fontFamily="Inter, sans-serif",a.style.transition="all 0.2s ease",a.style.whiteSpace="nowrap",a.style.overflow="hidden",a.style.textOverflow="ellipsis",a.dataset.origBg=a.style.backgroundColor,a.addEventListener("mouseenter",()=>{a.style.backgroundColor="#4b5563",a.style.transform="translateY(-1px)",a.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor=a.dataset.origBg||a.style.backgroundColor,a.style.transform="translateY(0)",a.style.boxShadow="none"}),a.addEventListener("mousedown",()=>{a.style.transform="translateY(1px) scale(0.98)"}),a.addEventListener("mouseup",()=>{a.style.transform="translateY(-1px)"}),o&&a.addEventListener("click",o),a}function R(e){return e.replace(/1/g,"I").replace(/5/g,"S").replace(/0/g,"O").replace(/2/g,"Z").replace(/3/g,"E").replace(/4/g,"A").replace(/6/g,"G").replace(/7/g,"T").replace(/8/g,"B").replace(/9/g,"g")}async function O(){if(document.getElementById("ocr-settings-panel"))return;const e=document.createElement("div");e.id="ocr-settings-backdrop",Object.assign(e.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",backgroundColor:"rgba(0,0,0,0.45)",zIndex:"2147483646",opacity:"0",transition:"opacity 220ms ease"});const t=document.createElement("aside");t.id="ocr-settings-panel",Object.assign(t.style,{position:"fixed",top:"0",left:"0",height:"100vh",width:"min(480px, 90vw)",backgroundColor:"#0f1724",color:"#f9fafb",boxShadow:"2px 0 30px rgba(0,0,0,0.6)",zIndex:"2147483647",transform:"translateX(-100%)",transition:"transform 320ms cubic-bezier(.2,.9,.2,1)",overflowY:"auto",padding:"20px",boxSizing:"border-box",fontFamily:"Inter, sans-serif"});const n=()=>{t.style.transform="translateX(-100%)",e.style.opacity="0",setTimeout(()=>{t.parentElement&&t.remove(),e.parentElement&&e.remove()},340),location.reload()};e.addEventListener("click",n);const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.marginBottom="12px";const a=document.createElement("h2");a.textContent="Settings",a.style.margin="0",a.style.fontSize="18px";const r=document.createElement("button");r.textContent="âœ•",Object.assign(r.style,{background:"transparent",border:"none",color:"#f9fafb",fontSize:"20px",cursor:"pointer"}),r.onclick=n;const i=document.createElement("div");i.style.color="#9ca3af",i.style.fontSize="12px",i.style.marginLeft="8px";try{i.textContent=new URL(window.location.href).hostname||"current site"}catch(e){i.textContent="current site"}const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="12px",s.appendChild(a),s.appendChild(i),o.appendChild(s),o.appendChild(r),t.appendChild(o);let l="global";try{window.location&&window.location.origin&&"null"!==window.location.origin&&(l=`site:${window.location.origin}`)}catch(e){}await async function(e,t,n){const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.gap="8px",o.style.margin="8px 0 12px 0";const a=document.createElement("div");a.style.display="flex",a.style.margin="8px 0 0 ",a.style.alignItems="center",a.style.gap="6px",a.style.flex="1";const r=document.createElement("label");r.textContent="Rule Scope",r.style.color="#e6eef8",r.style.fontSize="13px";const i=document.createElement("select");i.id="rule_scope",Object.assign(i.style,{padding:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",minWidth:"160px",margin:"0 auto"});const s=["global"];let l=null;try{window.location.origin&&"null"!==window.location.origin&&(l=`site:${window.location.origin}`)}catch(e){}l&&!s.includes(l)&&s.push(l);const c=()=>{i.innerHTML="",s.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent="global"===e?"Global Rules":e.replace("site:","")+" (This Site)",i.appendChild(t)}),i.value=t};c(),a.appendChild(r),a.appendChild(i);const d=document.createElement("div");d.style.display="flex",d.style.alignItems="center",d.style.gap="8px";const p=document.createElement("button");p.textContent="+",Object.assign(p.style,{padding:"6px 8px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"});const u=document.createElement("button");u.textContent="ðŸ—‘ï¸",Object.assign(u.style,{padding:"6px 8px",borderRadius:"6px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer"}),d.appendChild(p),d.appendChild(u),o.appendChild(a),o.appendChild(d),e.appendChild(o),i.onchange=()=>h(i.value),p.onclick=()=>{l&&!s.includes(l)?(s.push(l),c(),i.value=l,h(l)):alert("You are already on the current site scope or it is invalid.")},u.onclick=async()=>{const e=i.value;if("global"===e)return alert("Cannot delete Global scope.");if(confirm(`Delete rules for "${e}"?`)){await j(e,[]),await z(e,[]);const t=s.indexOf(e);t>-1&&s.splice(t,1),c(),i.value="global",h("global")}};const g=document.createElement("div");g.style.display="flex",g.style.flexDirection="column",g.style.gap="14px",e.appendChild(g);const h=async e=>{if(g.innerHTML="","global"===e){const e=T("Profile Management");await async function(e){const t=await x(["active_profile_id"]),n=await async function(){const e=await E(),t=[],n=[];return Object.entries(e.profiles).forEach(([e,o])=>{const a={id:e,name:o.name||"Unnamed"};"default"===e?t.unshift(a):"manhwa"===e?t.push(a):n.push(a)}),n.sort((e,t)=>e.name.localeCompare(t.name)),[...t,...n]}(),o=t.active_profile_id;Object.assign(e.style,{display:"flex",flexDirection:"column",gap:"10px"});const a=document.createElement("div");Object.assign(a.style,{display:"flex",gap:"8px",flexWrap:"wrap",alignItems:"center"});const r=document.createElement("select");Object.assign(r.style,{padding:"8px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",minWidth:"180px",flex:"1"}),n.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name+(e.id===o?" (Active)":"")+(["default","manhwa"].includes(e.id)?" [System]":""),r.appendChild(t)}),r.value=o,r.onchange=async()=>{await v(r.value),location.reload()},a.appendChild(r);const i=document.createElement("div");Object.assign(i.style,{display:"flex",gap:"6px"});const s=(e,t,n,o="primary")=>{const a=document.createElement("button");return a.textContent=e,a.title=t,Object.assign(a.style,{padding:"8px 12px",borderRadius:"6px",border:"none",cursor:"pointer",background:"danger"===o?"#7f1d1d":"#374151",color:"white"}),a.onclick=n,a};i.appendChild(s("ðŸ“‹","Duplicate Profile",async()=>{const e=prompt("New profile name (copy of current):",n.find(e=>e.id===o).name+" Copy");if(e){const t=await C(e,o);await v(t),location.reload()}})),i.appendChild(s("âž•","New Empty Profile",async()=>{const e=prompt("New profile name:");if(e){const t=await C(e);await v(t),location.reload()}}));const l=["default","manhwa"].includes(o);l||i.appendChild(s("âœï¸","Rename Profile",async()=>{const e=n.find(e=>e.id===o).name,t=prompt("Rename profile:",e);t&&t!==e&&(await async function(e,t){const n=await E();return!!n.profiles[e]&&(n.profiles[e].name=t,await browser.storage.local.set({[f]:n}),!0)}(o,t),location.reload())})),i.appendChild(s("â†º","Reset Profile to Defaults",async()=>{confirm(`Reset "${n.find(e=>e.id===o).name}" to factory defaults?`)&&(await async function(e){const t=await E();if(!t.profiles[e])return!1;const n=t.profiles[e].name;return t.profiles[e]={...m,name:n},await browser.storage.local.set({[f]:t}),!0}(o),location.reload())},"danger"));const c=s("ðŸ—‘ï¸","Delete Profile",async()=>{confirm("Delete this profile permanently?")&&(await async function(e){const t=await E();return"default"!==e&&"manhwa"!==e&&(delete t.profiles[e],t.global.active_profile_id===e&&(t.global.active_profile_id="default"),await browser.storage.local.set({[f]:t}),!0)}(o),location.reload())},"danger");l&&(c.disabled=!0),l&&(c.style.opacity="0.5"),i.appendChild(c),a.appendChild(i),e.appendChild(a)}(e),g.appendChild(e)}const t=T("Find & Replace Rules"),o=document.createElement("div");o.textContent="Characters/words to replace in the OCR text",o.style.color="#9ca3af",o.style.fontSize="13px",o.style.marginBottom="10px",t.insertBefore(o,t.children[1]);const a=await _(e);if(function(e,t,n){const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="8px";const a=document.createElement("div");a.style.display="flex",a.style.gap="12px",a.style.alignItems="center",a.style.flexWrap="wrap",a.style.margin="0 auto";const r=document.createElement("input");r.placeholder="Character to Find",Object.assign(r.style,{width:"150px",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const i=document.createElement("input");i.placeholder="Replace With",Object.assign(i.style,{width:"150px",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const s=document.createElement("div");s.textContent="â†’",s.style.color="#9ca3af",s.style.fontSize="18px",s.style.display="flex",s.style.alignItems="center",s.style.padding="0 4px",a.appendChild(r),a.appendChild(s),a.appendChild(i);const l=document.createElement("div");l.style.display="flex",l.style.gap="10px",l.style.justifyContent="center",l.style.fontSize="12px",l.innerHTML='\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_rgx"> Regex</label>\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_case"> Case</label>\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_word"> Word</label>\n    ';const c=document.createElement("button");c.textContent="Add",Object.assign(c.style,{padding:"8px 10px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer",width:"72px",alignSelf:"center"}),o.appendChild(a),o.appendChild(l),o.appendChild(c),e.appendChild(o);const d=document.createElement("div");d.style.marginTop="12px",d.style.display="grid",d.style.gridTemplateColumns="1fr 1fr",d.style.gap="8px";const p=()=>{d.innerHTML="",t.forEach((e,o)=>{const a=document.createElement("div");Object.assign(a.style,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",padding:"6px 8px",background:"#071022",borderRadius:"8px",minHeight:"36px",boxSizing:"border-box"});const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="2px",r.style.marginRight="6px";const i=document.createElement("button");i.textContent="â–²",i.onclick=()=>u(o,o-1);const s=document.createElement("button");s.textContent="â–¼",s.onclick=()=>u(o,o+1),[i,s].forEach(e=>{Object.assign(e.style,{fontSize:"8px",padding:"0",background:"transparent",border:"none",color:"#6b7280",cursor:"pointer"})}),o>0&&r.appendChild(i),o<t.length-1&&r.appendChild(s),a.appendChild(r);const l=document.createElement("div"),c=[];e.isRegex&&c.push("R"),e.caseSensitive&&c.push("C"),e.wholeWord&&c.push("W");const g=c.length?`<sup style="color:#f59e0b; margin-left:2px">${c.join("")}</sup>`:"";l.innerHTML=`<span style="color:#e6eef8">${e.find}</span> <span style="color:#6b7280">â†’</span> <span style="color:#a5f3fc">${e.replace}</span> ${g}`,Object.assign(l.style,{fontSize:"13px",flex:"1",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",userSelect:"none"}),l.style.cursor="pointer",l.style.opacity=!1!==e.enabled?"1":"0.5",l.onclick=async()=>{t[o].enabled=!(!1!==t[o].enabled),await z(n,t),p()},a.appendChild(l);const h=document.createElement("button");h.textContent="âœ•",Object.assign(h.style,{padding:"4px",borderRadius:"4px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer",marginLeft:"8px",fontSize:"12px",width:"24px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center"}),h.onclick=async e=>{e.preventDefault(),t.splice(o,1),await z(n,t),p()},a.appendChild(h),d.appendChild(a)})},u=async(e,o)=>{if(o<0||o>=t.length)return;const a=t.splice(e,1)[0];t.splice(o,0,a),await z(n,t),p()};p(),e.appendChild(d),c.onclick=async()=>{const e=r.value,o=i.value;if(!e)return;const a={find:e,replace:o,isRegex:document.getElementById("adv_rgx").checked,caseSensitive:document.getElementById("adv_case").checked,wholeWord:document.getElementById("adv_word").checked,enabled:!0};t.push(a),await z(n,t),p(),r.value="",i.value=""}}(t,a.replacements,e),function(e,t,n){const o=document.createElement("h4");o.textContent="Characters to Delete",o.style.margin="12px 0 6px 0",o.style.fontSize="15px",e.appendChild(o);const a=document.createElement("div");a.textContent="These characters will be removed from the OCR text",a.style.color="#9ca3af",a.style.fontSize="13px",e.appendChild(a);const r=document.createElement("div");r.style.display="flex",r.style.gap="8px",r.style.alignItems="center",r.style.marginTop="8px";const i=document.createElement("input");i.placeholder="Character to Delete",Object.assign(i.style,{flex:"1",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const s=document.createElement("button");s.textContent="Add",Object.assign(s.style,{padding:"8px 10px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer",width:"72px",flex:"0 0 auto"}),r.appendChild(i),r.appendChild(s),e.appendChild(r);const l=document.createElement("div");l.style.display="flex",l.style.gap="10px",l.style.marginTop="6px",l.style.fontSize="11px",l.style.color="#9ca3af",l.innerHTML='\n        <span>Safe if between: </span>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_let">Letters</label>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_num">Numbers</label>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_wrd">Inside Words</label>\n    ',e.appendChild(l);const c=document.createElement("div");c.style.marginTop="8px",c.style.display="flex",c.style.flexWrap="wrap",c.style.gap="6px";const d=()=>{c.innerHTML="",t.forEach((e,o)=>{const a="string"==typeof e?e:e.char,r=document.createElement("div");Object.assign(r.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:"6px 8px",background:"#07202a",color:"#e6eef8",borderRadius:"8px",border:"1px solid rgba(255,255,255,0.03)"});let i=a;"string"!=typeof e&&(e.ignoreBetweenLetters||e.ignoreBetweenNumbers||e.ignoreInsideWords)&&(i+="*");const s=document.createElement("span");s.textContent=i,s.style.fontSize="13px",s.style.marginRight="4px",i.endsWith("*")&&(s.title="Has context protection rules");const l=document.createElement("button");l.textContent="âœ•",Object.assign(l.style,{padding:"2px 4px",borderRadius:"4px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer",fontSize:"10px"}),l.onclick=async()=>{t.splice(o,1),await j(n,t),d()},r.appendChild(s),r.appendChild(l),c.appendChild(r)})};d(),e.appendChild(c),s.onclick=async()=>{const e=i.value;if(!e)return;const o={char:e,ignoreBetweenLetters:document.getElementById("del_let").checked,ignoreBetweenNumbers:document.getElementById("del_num").checked,ignoreInsideWords:document.getElementById("del_wrd").checked};t.push(o),await j(n,t),d(),i.value=""}}(t,a.deletions,e),g.appendChild(t),"global"===e){const t=T("Pipeline Configuration");await async function(e){const t=document.createElement("h3");t.textContent="Image Preprocessing",Object.assign(t.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(t);const n=await x(["preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","preprocess_borders"]);[{key:"preprocess_resize",label:"Resize Image (2x)",default:!0},{key:"preprocess_grayscale",label:"Grayscale",default:!0},{key:"preprocess_contrast",label:"Enhance Contrast",default:!0},{key:"preprocess_blur",label:"Median Blur",default:!1},{key:"preprocess_threshold",label:"Adaptive Threshold",default:!1},{key:"preprocess_morphology",label:"Morphology (Clean)",default:!1}].forEach(t=>{e.appendChild(M(t.label,void 0!==n[t.key]?n[t.key]:t.default,async e=>await w({[t.key]:e})))})}(t);const n=document.createElement("div");n.style.borderTop="1px solid #374151",n.style.margin="12px 0",t.appendChild(n),await async function(e,t){if("global"!==t)return;const n=document.createElement("h3");n.textContent="Text Cleaning Pipeline",Object.assign(n.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(n);const o=await x(["clean_noise","noise_aggression","clean_normalize","clean_dict","dict_strength","dict_ignore_caps","manhwa_mode"]);[{key:"clean_noise",label:"Noise Cleaning (Remove Artifacts)",default:!0},{key:"clean_normalize",label:"Normalize Whitespace (Fix spaces)",default:!0},{key:"clean_dict",label:"Dictionary Correction (Levenshtein)",default:!1},{key:"dict_ignore_caps",label:"Dictionary: Ignore ALL CAPS",default:!0},{key:"manhwa_mode",label:"Manhwa Mode (Vertical Text Fixes)",default:!1}].forEach(t=>{e.appendChild(M(t.label,void 0!==o[t.key]?o[t.key]:t.default,async e=>await w({[t.key]:e})))});const a=document.createElement("div");Object.assign(a.style,{display:"flex",alignItems:"center",justifyContent:"space-between",background:"#1f2937",padding:"8px",borderRadius:"6px",marginTop:"8px"}),a.innerHTML='<span style="font-size:14px">Noise Aggression</span>';const r=document.createElement("select");Object.assign(r.style,{background:"#374151",color:"white",border:"none",padding:"4px"}),["low","medium","high"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),r.value=o.noise_aggression||"medium",r.onchange=async()=>await w({noise_aggression:r.value}),a.appendChild(r),e.appendChild(a);const i=document.createElement("div");Object.assign(i.style,{display:"flex",alignItems:"center",justifyContent:"space-between",background:"#1f2937",padding:"8px",borderRadius:"6px",marginTop:"8px"}),i.innerHTML='<span style="font-size:14px">Dict Strength (Distance)</span>';const s=document.createElement("select");Object.assign(s.style,{background:"#374151",color:"white",border:"none",padding:"4px"}),["1","2","3"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}),s.value=o.dict_strength||1,s.onchange=async()=>await w({dict_strength:parseInt(s.value)}),i.appendChild(s),e.appendChild(i)}(t,e);const o=document.createElement("div");o.style.borderTop="1px solid #374151",o.style.margin="12px 0",t.appendChild(o),await async function(e,t){if("global"!==t)return;const n=document.createElement("h3");n.textContent="Text Reconstruction",Object.assign(n.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(n);const o=await x(["reconstruct_text","reconstruct_merge","reconstruct_stabilize"]);e.appendChild(M("Enable Reconstruction",!0===o.reconstruct_text,async e=>await w({reconstruct_text:e})));const a=document.createElement("div");a.style.marginLeft="20px",a.style.marginTop="8px",a.appendChild(M("Merge Broken Lines",!1!==o.reconstruct_merge,async e=>await w({reconstruct_merge:e}))),a.appendChild(M("Stabilize Sentences",!1!==o.reconstruct_stabilize,async e=>await w({reconstruct_stabilize:e}))),e.appendChild(a)}(t,e),g.appendChild(t);const a=T("UI & Behavior");await async function(e){const t=document.createElement("h3");t.textContent="UI Settings",Object.assign(t.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(t);const n=await x(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist","debug_mode"]);e.appendChild(M("Show Floating Button",!1!==n.floating_button_enabled,async e=>await w({floating_button_enabled:e})));const o=document.createElement("div");o.style.marginLeft="20px",o.style.marginBottom="20px",o.style.display=!1!==n.floating_button_enabled?"block":"none";const a=document.createElement("div");Object.assign(a.style,{display:"flex",alignItems:"center",marginBottom:"10px",gap:"10px"}),a.innerHTML='<span style="font-size:14px; color:#d1d5db">Filter Mode:</span>';const r=document.createElement("select");Object.assign(r.style,{padding:"4px 8px",borderRadius:"4px",background:"#374151",color:"white",border:"none"});const i=document.createElement("option");i.value="blacklist",i.textContent="Show Everywhere (Excluded Sites)";const s=document.createElement("option");s.value="whitelist",s.textContent="Hide Everywhere (Allowed Sites)",r.appendChild(i),r.appendChild(s),r.value=n.floating_button_mode||"blacklist",r.onchange=async()=>{await w({floating_button_mode:r.value}),c(r.value)},a.appendChild(r),o.appendChild(a);const l=document.createElement("div");o.appendChild(l);const c=async e=>{l.innerHTML="";const t=(await x("blacklist"===e?["floating_button_blacklist"]:["floating_button_whitelist"]))["blacklist"===e?"floating_button_blacklist":"floating_button_whitelist"]||[],n=document.createElement("p");n.style.fontSize="12px",n.style.color="#9ca3af",n.style.marginBottom="8px",n.textContent="blacklist"===e?"Button will NOT appear on these URLs (one per line):":"Button WILL appear ONLY on these URLs (one per line):",l.appendChild(n);const o=document.createElement("textarea");o.rows=5,Object.assign(o.style,{width:"100%",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"4px",padding:"8px",fontFamily:"monospace",boxSizing:"border-box"}),o.value=t.join("\n"),o.onchange=async()=>{const t=o.value.split("\n").map(e=>e.trim()).filter(e=>e),n="blacklist"===e?"floating_button_blacklist":"floating_button_whitelist";await w({[n]:t})},l.appendChild(o)};await c(n.floating_button_mode||"blacklist"),e.appendChild(o),e.appendChild(M("Debug Mode",!0===n.debug_mode,async e=>await w({debug_mode:e})));const d=e.querySelector('input[type="checkbox"]');if(d){const e=d.onchange;d.onchange=t=>{o.style.display=t.target.checked?"block":"none",e&&e(t)}}}(a),g.appendChild(a)}if("global"===e){const e=document.createElement("section");Object.assign(e.style,{background:"#111827",padding:"12px",borderRadius:"8px",display:"flex",gap:"8px",justifyContent:"center"}),await async function(e){const t=document.createElement("button");t.textContent="ðŸ“¥ Import Settings";const n=document.createElement("button");n.textContent="ðŸ“¤ Export Settings";const o=document.createElement("button");o.textContent="âš ï¸ Reset",[t,n,o].forEach(e=>Object.assign(e.style,{padding:"8px 12px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"})),o.style.background="#7f1d1d",n.onclick=()=>{(async function(e="full",t={}){const n=await E();if("full"===e){const e={version:1,timestamp:Date.now(),type:"full_backup",data:n,site_replacements:{},site_deletions:{}},t=await browser.storage.local.get(null);return Object.keys(t).forEach(n=>{n.startsWith("user_replacements_site:")&&(e.site_replacements[n]=t[n]),n.startsWith("user_deletions_site:")&&(e.site_deletions[n]=t[n])}),JSON.stringify(e,null,2)}if("profile"===e){const e=t.id||n.global.active_profile_id,o=n.profiles[e];if(!o)throw new Error("Profile not found");const a={version:1,timestamp:Date.now(),type:"profile_export",name:o.name,data:o};return JSON.stringify(a,null,2)}})("full").then(e=>{const t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="ocr-settings-all.json",o.click()})},t.onclick=()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();try{JSON.parse(n),confirm("Import settings? This will overwrite existing configuration.")&&(await async function(e,t="merge"){let n;try{n=JSON.parse(e)}catch(e){throw new Error("Invalid JSON format")}if(!n.version||!n.type)throw new Error("Invalid settings file (missing metadata)");const o=await E();if("profile_export"===n.type){const e=`profile_${Date.now()}_imp`,a=n.name+("merge"===t?" (Imported)":"");return o.profiles[e]={...m,...n.data},o.profiles[e].name=a,await browser.storage.local.set({[f]:o}),{success:!0,message:`Imported profile "${a}"`}}if("full_backup"===n.type){const e=n.data;if("replace"===t)return await browser.storage.local.set({[f]:e}),n.site_replacements&&await browser.storage.local.set(n.site_replacements),n.site_deletions&&await browser.storage.local.set(n.site_deletions),{success:!0,message:"Settings fully restored."};if("merge"===t){let t=0;for(const[n,a]of Object.entries(e.profiles))if(o.profiles[n]){const e=`${n}_merge_${Date.now()}`;o.profiles[e]={...a,name:a.name+" (Imported)"},t++}else o.profiles[n]=a,t++;return await browser.storage.local.set({[f]:o}),{success:!0,message:`Merged ${t} profiles.`}}}throw new Error("Unknown import type")}(n,"merge"),location.reload())}catch(e){alert(" invalid file ")}},e.click()},o.onclick=()=>{confirm("Factory Reset? This cannot be undone.")&&async function(e,t){const n=await E();if("profile"===e){const e=n.global.active_profile_id,t=n.profiles[e].name;return n.profiles[e]={...m,name:t},await browser.storage.local.set({[f]:n}),!0}if("full"===e){await browser.storage.local.clear();const e={global:{...b},profiles:{default:{...m}}};return await browser.storage.local.set({[f]:e}),!0}if("section"===e){if(!Array.isArray(t))return!1;const e=n.global.active_profile_id;return t.forEach(t=>{m.hasOwnProperty(t)&&(n.profiles[e][t]=m[t])}),await browser.storage.local.set({[f]:n}),!0}}("full").then(()=>location.reload())},e.appendChild(t),e.appendChild(n),e.appendChild(o)}(e),g.appendChild(e)}const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="center",r.style.marginTop="6px",r.style.alignItems="center",r.style.gap="8px";const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i.style.gap="8px",i.style.marginTop="6px";const s=document.createElement("input");s.type="checkbox",s.checked=!0,s.disabled=!0;const l=document.createElement("label");l.textContent="Auto-save (Always On)",l.style.color="#e6eef8",l.style.fontSize="13px",i.appendChild(s),i.appendChild(l),g.appendChild(i);const c=document.createElement("button");c.textContent="Close",Object.assign(c.style,{padding:"10px 14px",borderRadius:"8px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"}),c.onclick=()=>{n&&n()},r.appendChild(c),g.appendChild(r)};await h(t)}(t,l,n),document.body.appendChild(e),document.body.appendChild(t),requestAnimationFrame(()=>{e.style.opacity="1",t.style.transform="translateX(0)"})}function T(e){const t=document.createElement("section");if(Object.assign(t.style,{background:"#111827",padding:"12px",borderRadius:"8px"}),e){const n=document.createElement("h3");n.textContent=e,n.style.margin="0 0 8px 0",n.style.fontSize="16px",t.appendChild(n)}return t}function M(e,t,n){const o=document.createElement("label");Object.assign(o.style,{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer",background:"#1f2937",padding:"8px",borderRadius:"6px",marginBottom:"8px"});const a=document.createElement("input");return a.type="checkbox",a.checked=t,a.onchange=e=>n(e.target.checked),o.appendChild(a),o.appendChild(document.createTextNode(e)),o}async function j(e,t){if("global"===e)await w({user_deletions:t});else{const n=`user_deletions_${e}`;await browser.storage.local.set({[n]:t})}}async function z(e,t){if("global"===e)await w({user_replacements:t});else{const n=`user_replacements_${e}`;await browser.storage.local.set({[n]:t})}}function D(){const e=function(e,t="32px",n="32px",o=null){const a=document.createElement("button");return a.textContent=e,a.style.width=t,a.style.height=n,a.style.padding="4px",a.style.backgroundColor="#374151",a.style.color="#9ca3af",a.style.border="1px solid #4b5563",a.style.borderRadius="6px",a.style.cursor="pointer",a.style.fontSize="16px",a.style.fontFamily="Inter, sans-serif",a.style.transition="all 0.2s ease",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.addEventListener("mouseenter",()=>{a.style.backgroundColor="#4b5563",a.style.transform="translateY(-1px)",a.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="#374151",a.style.transform="translateY(0)",a.style.boxShadow="none"}),a.addEventListener("mousedown",()=>{a.style.transform="translateY(1px) scale(0.98)"}),a.addEventListener("mouseup",()=>{a.style.transform="translateY(-1px)"}),o&&a.addEventListener("click",o),a}("âš™","32px","32px");return e.title="Settings",e.addEventListener("click",()=>{try{return void O()}catch(e){}try{if("undefined"!=typeof chrome&&chrome.tabs&&"function"==typeof chrome.tabs.create)return void chrome.tabs.create({url:chrome.runtime.getURL("settings.html"),active:!0})}catch(e){}window.dispatchEvent(new CustomEvent("ocr:openSettings"))}),e}function N(e,t){console.log("Showing popup with state:",e,"text:",t),document.querySelectorAll('div[style*="position: fixed"][style*="bottom: 10px"][style*="right: 10px"]').forEach(e=>{document.body.contains(e)&&document.body.removeChild(e)});const n=document.createElement("div");n.style.position="fixed",n.style.bottom="10px",n.style.right="10px",n.style.width="min(450px, 90vw)",n.style.backgroundColor="#1f2937",n.style.color="#f9fafb",n.style.border="1px solid #374151",n.style.borderRadius="12px",n.style.boxShadow="0 10px 25px rgba(0,0,0,0.3)",n.style.zIndex="1000000",n.style.fontFamily="Inter, sans-serif",n.style.padding="20px",n.style.maxHeight="min(500px, 80vh)",n.style.overflowY="auto";const o=document.createElement("div");o.className="progress-container",o.style.marginBottom="20px";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center";const r=document.createElement("label");r.textContent="Recognizing",r.style.width="100px",r.style.fontSize="14px",r.style.color="#9ca3af",a.appendChild(r);const i=document.createElement("div");i.style.flex="1",i.style.height="8px",i.style.backgroundColor="#374151",i.style.borderRadius="4px",i.style.overflow="hidden";const s=document.createElement("div");s.style.height="100%",s.style.backgroundColor="#4f46e5",s.style.width="0%",i.appendChild(s),a.appendChild(i),o.appendChild(a),n.appendChild(o);const l=document.createElement("div");l.style.position="relative",l.style.marginBottom="18px";const c=document.createElement("textarea");c.value=t,c.style.width="100%",c.style.height="120px",c.style.padding="12px",c.style.backgroundColor="#374151",c.style.color="#f9fafb",c.style.border="1px solid #4b5563",c.style.borderRadius="8px",c.style.resize="vertical",c.style.fontFamily="Inter, sans-serif",c.style.minHeight="32px",c.style.maxHeight="200px",c.addEventListener("keydown",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","PageUp","PageDown"].includes(e.code)&&e.stopPropagation()}),l.appendChild(c);const d=document.createElement("div");d.style.display="flex",d.style.justifyContent="space-between",d.style.alignItems="center",d.style.marginBottom="8px";const p=document.createElement("select");["Korean","English","Turkish","Chinese"].forEach(e=>{const t=document.createElement("option");t.value=t.textContent=e,p.appendChild(t)}),Object.assign(p.style,{background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",padding:"6px",fontSize:"12px"});const u=D();Object.assign(u.style,{width:"34px",height:"34px",padding:"6px",borderRadius:"6px",background:"#374151"}),u.title="Settings",d.appendChild(p),d.appendChild(u),l.appendChild(d),l.appendChild(c),n.appendChild(l);const g=document.createElement("div");g.className="popup-footer",g.style.display="flex",g.style.justifyContent="center",g.style.alignItems="center",g.style.gap="0",g.style.padding="0",g.style.margin="0",g.style.width="100%";const h=document.createElement("div");h.style.display="flex",h.style.justifyContent="center",h.style.gap="8px",h.style.flexWrap="wrap",h.style.margin="0",h.style.padding="0",h.style.width="100%",h.style.boxSizing="border-box";const f=function(e){return A("Lower Case","120px","32px",()=>{const t=R(e.value);e.value=t.toLowerCase()})}(c);h.appendChild(f);const m=function(e){return A("Upper Case","120px","32px",()=>{e.value=e.value.toUpperCase()})}(c);h.appendChild(m);const y=function(e){return A("Single Line","120px","32px",()=>{const t=R(e.value);e.value=t.replace(/\n/g," ")})}(c);h.appendChild(y);const b=function(e){return A("Manhwa Mode","120px","32px",()=>{let t=e.value||"",n=[];try{window.manhwaDeleteChars&&Array.isArray(window.manhwaDeleteChars)&&(n=window.manhwaDeleteChars.slice())}catch(e){}if(0===n.length){const e=localStorage.getItem("charsToDelete")||"";try{const t=JSON.parse(e);n=Array.isArray(t)?t.slice():(e||"").split("")}catch{n=(e||"").split("")}}n.forEach(e=>{e&&(t=t.split(e).join(""))});let o=[];try{window.manhwaRules&&Array.isArray(window.manhwaRules)&&(o=window.manhwaRules.map(e=>({find:e.find+"",replace:e.replace+""})))}catch(e){}if(0===o.length){try{const e=window.location&&window.location.origin?window.location.origin:null;if(e){const t="manhwa_rules::"+encodeURIComponent("site:"+e),n=localStorage.getItem(t);if(n){const e=JSON.parse(n);Array.isArray(e)&&(o=e.map(e=>({find:String(e.find||""),replace:String(e.replace||"")})))}}}catch(e){}if(0===o.length){const e=localStorage.getItem("replacementsText")||"";try{const t=JSON.parse(e);if(Array.isArray(t))o=t.map(e=>({find:String(e.find||""),replace:String(e.replace||"")}));else{const t=String(e||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),n=[];t.forEach(e=>{const t=e.indexOf("â†’")>=0?"â†’":e.indexOf("=>")>=0?"=>":null;if(t){const o=e.split(t);n.push({find:o[0],replace:o.slice(1).join(t)})}}),o=n}}catch(t){const n=String(e||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),a=[];n.forEach(e=>{const t=e.indexOf("â†’")>=0?"â†’":e.indexOf("=>")>=0?"=>":null;if(t){const n=e.split(t);a.push({find:n[0],replace:n.slice(1).join(t)})}}),o=a}}}o.forEach(e=>{if(e&&e.find)try{const n=`(?<!\\w)${e.find.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(?!\\w)`,o=new RegExp(n,"gi");t=t.replace(o,e.replace||"")}catch(n){try{t=t.split(e.find).join(e.replace||"")}catch(e){}}}),e.value=t.replace(/\n/g," ").toLowerCase()})}(c);h.appendChild(b);const w=function(e,t){const n=A("Copy","120px","32px");return n.handler=async()=>(await t(e.value),!0),n.addEventListener("click",function(e){return async()=>{await e.handler()&&(e.textContent="Copied!",setTimeout(()=>e.textContent="Copy",2e3))}}(n)),n}(c,B);h.appendChild(w),x(["popup_hidden_buttons"]).then(e=>{const t=e.popup_hidden_buttons||[];t.includes("Lowercase")&&(f.style.display="none"),t.includes("Uppercase")&&(m.style.display="none"),t.includes("Single Line")&&(y.style.display="none"),t.includes("Manhwa Mode")&&(b.style.display="none"),t.includes("Copy")&&(w.style.display="none")});const C=function(e){return function(e,t="110px",n="32px",o=null){const a=A("Close",t,n,o);return a.style.backgroundColor="#4f46e5",a.style.border="none",a.style.color="#ffffff",a.dataset.origBg=a.style.backgroundColor,a}(0,"120px","32px",()=>{document.body.removeChild(e)})}(n);function v(e){const t=`copy_${e.replace(/\s+/g,"_").toLowerCase()}`,n=document.getElementById(t);if(n)return!!n.checked;try{return!!JSON.parse(localStorage.getItem("copyConfig")||"{}")[t]}catch(e){return!1}}function _(){const e=document.createElement("div");e.textContent="Copied!",Object.assign(e.style,{position:"absolute",bottom:"100%",left:"50%",transform:"translateX(-50%)",background:"#0b1220",color:"#e6eef8",padding:"6px 10px",borderRadius:"6px",border:"1px solid #25303a",zIndex:1000002,opacity:"0",transition:"opacity 160ms ease"}),n.appendChild(e),requestAnimationFrame(()=>e.style.opacity="1"),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),220)},900)}return h.appendChild(C),f.addEventListener("click",async()=>{v("Lowercase")&&await B(c.value)&&_()}),m.addEventListener("click",async()=>{v("Uppercase")&&await B(c.value)&&_()}),y.addEventListener("click",async()=>{v("Single Line")&&await B(c.value)&&_()}),b.addEventListener("click",async()=>{v("Manhwa Mode")&&await B(c.value)&&_()}),g.appendChild(h),n.appendChild(g),"processing"===e?(o.style.display="block",c.style.display="none",g.style.display="none",n.intervalId=setInterval(()=>{let e=parseFloat(s.style.width)||0;e+=10,e>90&&(e=90),s.style.width=e+"%"},300)):(o.style.display="none",c.style.display="block",g.style.display="flex"),document.body.appendChild(n),n}async function B(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){console.warn("Modern clipboard API failed, falling back to execCommand")}try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();const n=document.execCommand("copy");return document.body.removeChild(t),n}catch(e){return console.error("Clipboard copy failed:",e),!1}}let P=null,U=null;function $(e,t=[]){if(U&&P&&(U.clearRect(0,0,P.width,P.height),U.fillStyle="rgba(0, 0, 0, 0.35)",U.fillRect(0,0,P.width,P.height),t.forEach(e=>{U.clearRect(e.x,e.y,e.width,e.height),U.strokeStyle="#3b82f6",U.lineWidth=2,U.strokeRect(e.x,e.y,e.width,e.height)}),e)){const{x:t,y:n,width:o,height:a}=e;U.clearRect(t,n,o,a),U.strokeStyle="#ef4444",U.lineWidth=2,U.strokeRect(t,n,o,a)}}function F(){P&&document.body.contains(P)&&document.body.removeChild(P),P=null,U=null}async function H(){const e=await x(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist"]),t=!1!==e.floating_button_enabled,n=e.floating_button_mode||"blacklist",o=e.floating_button_blacklist||[],a=e.floating_button_whitelist||[],r=window.location.href,i=e=>{try{return e.startsWith("/")&&e.endsWith("/")?new RegExp(e.slice(1,-1)).test(r):r.includes(e)}catch(e){return!1}};let s=t;t&&("blacklist"===n?o.some(i)&&(s=!1):(s=!1,a.some(i)&&(s=!0)));const l=s,c=document.getElementById("ocr-settings-fab");if(l)if(c)c.style.display="flex";else try{!function(){if(document.getElementById("ocr-settings-fab"))return document.getElementById("ocr-settings-fab");const e=D();e.id="ocr-settings-fab",e.style.position="fixed",e.style.left="12px",e.style.bottom="12px",e.style.zIndex="1000002",e.style.boxShadow="0 8px 24px rgba(0,0,0,0.3)",e.style.borderRadius="8px",document.body.appendChild(e)}()}catch(e){console.warn("Button creation failed",e)}else c&&(c.style.display="none")}console.log("Content script loaded"),H(),browser.storage.onChanged.addListener((e,t)=>{"local"===t&&(e.floating_button_enabled||e.floating_button_blacklist)&&H()}),document.addEventListener("click",e=>{try{const t=e.target.closest&&e.target.closest("button");if(!t)return;if("ocr-settings-fab"!==t.id&&"Settings"!==t.title&&"âš™"!==t.textContent.trim())return;return e.stopImmediatePropagation(),e.preventDefault(),void O()}catch(e){console.warn("Settings click interceptor error",e)}},!0);let W,G,Y,J,K=!1,V=!1,Z=!1,q=[],X=null;function Q(){const e=X.querySelector("#toolbar-actions");if(e.innerHTML="",Z){const t=document.createElement("button");t.textContent=`Process (${q.length})`,Object.assign(t.style,{padding:"6px 12px",background:"#4f46e5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),t.onclick=()=>re();const n=document.createElement("button");n.textContent="Clear",Object.assign(n.style,{padding:"6px 12px",background:"#ef4444",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),n.onclick=()=>{q=[],$(null,[]),Q()},e.appendChild(t),e.appendChild(n)}const t=document.createElement("button");t.textContent="Cancel",Object.assign(t.style,{padding:"6px 12px",background:"#374151",color:"#9ca3af",border:"1px solid #4b5563",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),t.onclick=ae,e.appendChild(t)}function ee(e){X&&X.contains(e.target)||(V=!0,W=e.clientX,G=e.clientY,Y=W,J=G)}function te(e){if(!V)return;Y=e.clientX,J=e.clientY;const t=Math.abs(Y-W),n=Math.abs(J-G);$({x:Math.min(W,Y),y:Math.min(G,J),width:t,height:n},q)}function ne(e){if(!V)return;if(V=!1,X&&X.contains(e.target))return;const t=Math.abs(Y-W),n=Math.abs(J-G);if(t<5||n<5)return void $(null,q);const o={x:Math.min(W,Y),y:Math.min(G,J),width:t,height:n};Z?(q.push(o),$(null,q),Q()):(q=[o],re())}function oe(e){"Escape"===e.key&&ae(),"Enter"===e.key&&Z&&q.length>0&&re()}function ae(){K=!1,V=!1;try{browser.runtime.sendMessage({action:"selectionExited"})}catch(e){}document.removeEventListener("mousemove",te),document.removeEventListener("mouseup",ne),document.removeEventListener("keydown",oe),X&&X.remove(),X=null,F()}async function re(){if(0===q.length)return;const e=[...q];ae();const t=N("processing","");try{await new Promise(e=>setTimeout(e,100));const n=await browser.runtime.sendMessage({action:"captureViewport"});if(!n||!n.dataUrl)throw new Error("No capture data received");const o=new Image;o.src=n.dataUrl,await new Promise((e,t)=>{o.onload=e,o.onerror=t});let a="",r="";const i=window.devicePixelRatio||1;let s=0;for(const t of e){s++;const n=Math.round(t.x*i),l=Math.round(t.y*i),c=Math.round(t.width*i),d=Math.round(t.height*i);if(n+c>o.width)continue;if(l+d>o.height)continue;const p=document.createElement("canvas");p.width=c,p.height=d,p.getContext("2d").drawImage(o,n,l,c,d,0,0,p.width,p.height),console.log(`Processing selection ${s}/${e.length}`);const{text:u,originalText:g}=await I(p);a&&(a+="\n\n"),a+=u,r&&(r+="\n\n"),r+=g}!function(e,t,n){if(e.intervalId){clearInterval(e.intervalId);const t=e.querySelector('div[style*="backgroundColor: rgb(79, 70, 229)"]');t&&(t.style.width="100%")}const o=e.querySelector("textarea"),a=e.querySelector(".progress-container"),r=e.querySelector(".popup-footer");e.dataset.finalText=t,e.dataset.originalText=n||t,o&&(o.value=t),a&&(a.style.display="none"),o&&(o.style.display="block"),r&&(r.style.display="flex");const i=e.querySelector('div[style*="justify-content: space-between"]');if(i&&!e.querySelector("#btn-diff")){const t=document.createElement("button");t.id="btn-diff",t.textContent="Original",t.title="Show Original Text for Restoration",Object.assign(t.style,{border:"1px solid #374151",background:"#1f2937",color:"#9ca3af",borderRadius:"6px",padding:"6px 10px",fontSize:"12px",cursor:"pointer",marginLeft:"auto",marginRight:"8px"});const n=i.lastElementChild;i.insertBefore(t,n);let a=!1;const r=document.createElement("div");r.style.display="none",r.style.marginBottom="10px",r.style.padding="8px",r.style.background="#111827",r.style.border="1px dashed #6366f1",r.style.borderRadius="6px",r.style.fontSize="12px",r.style.color="#9ca3af",r.style.maxHeight="80px",r.style.overflowY="auto",o.parentElement.insertBefore(r,o),t.addEventListener("click",()=>{a=!a,a?(t.style.background="#4f46e5",t.style.color="#fff",r.innerHTML="",r.style.display="block",(e.dataset.originalText||"").split(/(\s+)/).forEach(e=>{const t=document.createElement("span");t.textContent=e,e.trim().length>0&&(t.style.cursor="pointer",t.style.borderBottom="1px dotted #6366f1",t.title="Click to insert into text",t.onmouseover=()=>t.style.color="white",t.onmouseout=()=>t.style.color="#9ca3af",t.onclick=()=>{const t=o.selectionStart,n=o.selectionEnd,a=o.value,r=a.substring(0,t),i=a.substring(n);o.value=r+e+i,o.selectionStart=o.selectionEnd=t+e.length,o.focus()}),r.appendChild(t)}),o.style.height="80px"):(t.style.background="#1f2937",t.style.color="#9ca3af",r.style.display="none",o.style.height="120px")})}}(t,a,r)}catch(e){console.error("OCR Batch failed:",e),N("done","Error processing: "+e.message)}}browser.runtime.onMessage.addListener(async e=>{var t;console.log("Content script received message:",e),"startSelection"===e.action&&(t=!0===(await x(["enable_multiselect"])).enable_multiselect,K||(K=!0,q=[],(F(),P=document.createElement("canvas"),P.style.position="fixed",P.style.top="0",P.style.left="0",P.style.width="100vw",P.style.height="100vh",P.style.zIndex="999998",P.style.cursor="crosshair",document.body.appendChild(P),P.width=window.innerWidth,P.height=window.innerHeight,U=P.getContext("2d"),U&&(U.fillStyle="rgba(0, 0, 0, 0.35)",U.fillRect(0,0,P.width,P.height)),P).addEventListener("mousedown",ee),document.addEventListener("mousemove",te),document.addEventListener("mouseup",ne),window.addEventListener("keydown",oe),function(e){if(X&&X.remove(),X=document.createElement("div"),Object.assign(X.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#1f2937",padding:"10px 16px",borderRadius:"8px",display:"flex",gap:"12px",alignItems:"center",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",zIndex:"1000002",color:"#f9fafb",fontFamily:"Inter, sans-serif"}),e){const e=document.createElement("label");e.style.display="flex",e.style.alignItems="center",e.style.cursor="pointer",e.style.gap="6px";const t=document.createElement("input");t.type="checkbox",t.checked=Z,Object.assign(t.style,{cursor:"pointer",accentColor:"#4f46e5"}),t.onchange=e=>{Z=e.target.checked,Q()},e.appendChild(t);const n=document.createElement("span");n.textContent="Multi-Select",n.style.fontSize="14px",e.appendChild(n),X.appendChild(e)}const t=document.createElement("div");t.id="toolbar-actions",Object.assign(t.style,{display:"flex",gap:"8px",alignItems:"center"}),X.appendChild(t),document.body.appendChild(X),Q()}(t)))})})()})();