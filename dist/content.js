(()=>{var e={82(e){"use strict";e.exports=async(e,t)=>{e.postMessage(t)}},119(e){"use strict";e.exports={workerBlobURL:!0,logger:()=>{}}},171(e){"use strict";e.exports={TESSERACT_ONLY:0,LSTM_ONLY:1,TESSERACT_LSTM_COMBINED:2,DEFAULT:3}},243(e){"use strict";e.exports=({workerPath:e,workerBlobURL:t})=>{let n;if(Blob&&URL&&t){const t=new Blob([`importScripts("${e}");`],{type:"application/javascript"});n=new Worker(URL.createObjectURL(t))}else n=new Worker(e);return n}},294(e,t,n){"use strict";const a="browser"===n(359)("type")?e=>new URL(e,window.location.href).href:e=>e;e.exports=e=>{const t={...e};return["corePath","workerPath","langPath"].forEach(n=>{e[n]&&(t[n]=a(t[n]))}),t}},359(e){"use strict";e.exports=e=>{const t={};return"undefined"!=typeof WorkerGlobalScope?t.type="webworker":"object"==typeof document?t.type="browser":"object"==typeof process&&(t.type="node"),void 0===e?t:t[e]}},362(e){"use strict";e.exports=(e,t)=>{e.onmessage=({data:e})=>{t(e)}}},397(e){"use strict";e.exports=(e,t)=>`${e}-${t}-${Math.random().toString(16).slice(3,8)}`},398(e,t,n){"use strict";n(473);const a=n(811),o=n(886),r=n(456),i=n(639),s=n(171),l=n(928),{setLogging:c}=n(866);e.exports={languages:i,OEM:s,PSM:l,createScheduler:a,createWorker:o,setLogging:c,...r}},403(e){"use strict";e.exports=e=>{e.terminate()}},432(e,t,n){"use strict";n.d(t,{performOCR:()=>v});var a=n(398);async function o(e,t={}){const n=t.scale||2;let a,o,r;if(e instanceof ImageData){o=e.width,r=e.height;const t=document.createElement("canvas");t.width=o,t.height=r;const n=t.getContext("2d");try{n.putImageData(e,0,0)}catch(t){try{const t=n.createImageData(e.width,e.height);t.data.set(new Uint8ClampedArray(e.data)),n.putImageData(t,0,0)}catch(e){throw console.error("Resize stage failed to process image data",e),e}}a=t}else{if(!(e instanceof HTMLCanvasElement))throw new Error("Invalid input type for resizeStage");a=e,o=a.width,r=a.height}const i=o*n,s=r*n,l=document.createElement("canvas");l.width=i,l.height=s;const c=l.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(a,0,0,i,s);try{return c.getImageData(0,0,i,s)}catch(e){return console.warn("Resize stage output tainted. Returning canvas reference (unsafe).",e),l}}function r(e){if(!(e&&"object"==typeof e&&"data"in e&&"width"in e&&"height"in e))throw console.error("Invalid input to getSafeImageData",e),new Error("Input must be ImageData (or have data/width/height)");try{return structuredClone(e)}catch(e){}try{const t=new Uint8ClampedArray(e.data);return new ImageData(t,e.width,e.height)}catch(e){}try{const t=e.data.slice(0);return new ImageData(t,e.width,e.height)}catch(e){throw console.error("Failed to clean ImageData",e),e}}async function i(e,t={}){let n,a,o;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)a=e.width,o=e.height,n=r(e.getContext("2d").getImageData(0,0,a,o)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for contrast stage");a=e.width,o=e.height,n=e instanceof ImageData?r(e).data:new Uint8ClampedArray(e.data)}const i=new Uint8ClampedArray(n),s=new Array(256).fill(0);for(let e=0;e<n.length;e+=4){if(0===n[e+3])continue;const t=n[e],a=n[e+1],o=n[e+2],r=Math.round(.299*t+.587*a+.114*o);s[Math.min(255,Math.max(0,r))]++}const l=a*o;let c=0,d=0,p=255;for(let e=0;e<256;e++)if(c+=s[e],c>.01*l){d=e;break}c=0;for(let e=255;e>=0;e--)if(c+=s[e],c>.01*l){p=e;break}p=p<200?255:Math.max(p,240);const u=p-d;if(u<=0)return new ImageData(i,a,o);const g=255/u;for(let e=0;e<i.length;e+=4)0!==i[e+3]&&(i[e]=Math.max(0,Math.min(255,(i[e]-d)*g)),i[e+1]=Math.max(0,Math.min(255,(i[e+1]-d)*g)),i[e+2]=Math.max(0,Math.min(255,(i[e+2]-d)*g)));return new ImageData(i,a,o)}function s(e){let t,n,a;try{if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName){n=e.width,a=e.height;try{t=r(e.getContext("2d").getImageData(0,0,n,a)).data}catch(t){return console.error("Grayscale Stage: Failed to extract ImageData",t),e}}else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))return console.warn("Invalid input type for grayscale stage:",e),e;n=e.width,a=e.height;try{t=e instanceof ImageData?r(e).data:new Uint8ClampedArray(e.data)}catch(t){return console.error("Grayscale Stage: Failed to copy ImageData",t),e}}if(!t)return e;const o=new Uint8ClampedArray(t.length);for(let e=0;e<t.length;e+=4){const n=.299*t[e]+.587*t[e+1]+.114*t[e+2];o[e]=n,o[e+1]=n,o[e+2]=n,o[e+3]=t[e+3]}return new ImageData(o,n,a)}catch(t){return console.error("Grayscale critical error:",t),e}}function l(e){let t,n,a;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)n=e.width,a=e.height,t=r(e.getContext("2d").getImageData(0,0,n,a)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for blur stage");n=e.width,a=e.height,t=e instanceof ImageData?r(e).data:new Uint8ClampedArray(e.data)}const o=new Uint8ClampedArray(t.length);o.fill(0),o.set(t);const i=(e,t)=>4*(t*n+e);for(let e=1;e<a-1;e++)for(let a=1;a<n-1;a++){const n=i(a,e),r=[],s=[],l=[];for(let n=-1;n<=1;n++)for(let o=-1;o<=1;o++){const c=i(a+o,e+n);r.push(t[c]),s.push(t[c+1]),l.push(t[c+2])}r.sort((e,t)=>e-t),s.sort((e,t)=>e-t),l.sort((e,t)=>e-t),o[n]=r[4],o[n+1]=s[4],o[n+2]=l[4]}return new ImageData(o,n,a)}function c(e,t={}){const{blockSize:n=15,constant:a=10}=t;let o,i,s;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)o=e.width,i=e.height,s=r(e.getContext("2d").getImageData(0,0,o,i)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for threshold stage");o=e.width,i=e.height,s=e instanceof ImageData?r(e).data:new Uint8ClampedArray(e.data)}const l=new Uint8ClampedArray(s.length),c=new Int32Array(o*i);let d=0;for(let e=0;e<o;e++)d+=s[4*e],c[e]=d;for(let e=1;e<i;e++){d=0;for(let t=0;t<o;t++)d+=s[4*(e*o+t)],c[e*o+t]=c[(e-1)*o+t]+d}const p=(e,t,n,a)=>(e=Math.max(0,e),t=Math.max(0,t),n=Math.min(o-1,n),a=Math.min(i-1,a),e>0&&t>0&&c[(t-1)*o+(e-1)],t>0&&c[(t-1)*o+a],c[a*o+n]-(t>0?c[(t-1)*o+n]:0)-(e>0?c[a*o+(e-1)]:0)+(e>0&&t>0?c[(t-1)*o+(e-1)]:0)),u=Math.floor(n/2);for(let e=0;e<i;e++)for(let t=0;t<o;t++){const n=4*(e*o+t),r=t-u,c=e-u,d=t+u,g=e+u,h=(Math.min(o-1,d)-Math.max(0,r)+1)*(Math.min(i-1,g)-Math.max(0,c)+1),m=p(r,c,d,g)/h;s[n]<m-a?(l[n]=0,l[n+1]=0,l[n+2]=0):(l[n]=255,l[n+1]=255,l[n+2]=255),l[n+3]=255}return new ImageData(l,o,i)}function d(e,t={}){const{type:n="open",kernelSize:a=1}=t;let o,i,s;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)i=e.width,s=e.height,o=r(e.getContext("2d").getImageData(0,0,i,s));else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for morphology stage");o=e instanceof ImageData?r(e):new ImageData(new Uint8ClampedArray(e.data),e.width,e.height)}return"open"===n&&(o=function(e,t){const n=e.width,a=e.height,o=e.data,r=new Uint8ClampedArray(o.length);r.fill(255);for(let e=0;e<a;e++)for(let i=0;i<n;i++){let s=!0;for(let r=-t;r<=t;r++){for(let l=-t;l<=t;l++){const t=i+l,c=e+r;if(!(t>=0&&t<n&&c>=0&&c<a)){s=!1;break}if(o[4*(c*n+t)]>128){s=!1;break}}if(!s)break}if(s){const t=4*(e*n+i);r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=255}}return new ImageData(r,n,a)}(o,a),o=function(e,t){const n=e.width,a=e.height,o=e.data,r=new Uint8ClampedArray(o.length);r.fill(255);for(let e=0;e<a;e++)for(let i=0;i<n;i++){let s=!1;for(let r=-t;r<=t;r++){for(let l=-t;l<=t;l++){const t=i+l,c=e+r;if(t>=0&&t<n&&c>=0&&c<a&&o[4*(c*n+t)]<128){s=!0;break}}if(s)break}if(s){const t=4*(e*n+i);r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=255}}return new ImageData(r,n,a)}(o,a)),o}function p(e){let t,n,a;if(e instanceof HTMLCanvasElement||e&&"CANVAS"===e.tagName)t=e.width,n=e.height,a=r(e.getContext("2d").getImageData(0,0,t,n)).data;else{if(!(e instanceof ImageData||e&&e.data&&e.width&&e.height))throw new Error("Invalid input type for region stage");t=e.width,n=e.height,a=e instanceof ImageData?r(e).data:new Uint8ClampedArray(e.data)}const o=new Uint8ClampedArray(a.length);o.fill(255);const i=new Uint8Array(t*n),s=[],l=(e,n)=>n*t+e;for(let e=0;e<n;e++)for(let o=0;o<t;o++){const r=l(o,e);if(i[r])continue;if(!(a[4*r]>128)){i[r]=1;continue}const c=[],d=[r];i[r]=1,c.push(r);let p=0;for(;p<d.length;){const e=d[p++],o=e%t,r=Math.floor(e/t),s=[{x:o+1,y:r},{x:o-1,y:r},{x:o,y:r+1},{x:o,y:r-1}];for(const e of s)if(e.x>=0&&e.x<t&&e.y>=0&&e.y<n){const t=l(e.x,e.y);i[t]||a[4*t]>128&&(i[t]=1,d.push(t),c.push(t))}}s.push(c)}if(0===s.length)return e;s.sort((e,t)=>t.length-e.length);const c=s[0],d=new Uint8Array(t*n);for(const e of c)d[e]=1;const p=new Uint8Array(t*n);for(let e=0;e<n;e++)for(let a=0;a<t;a++){const o=l(a,e);if(1===d[o]||p[o])continue;const r=[],i=[o];p[o]=1,r.push(o);let s=!1;0!==a&&a!==t-1&&0!==e&&e!==n-1||(s=!0);let c=0;for(;c<i.length;){const e=i[c++],a=e%t,o=Math.floor(e/t),u=[{x:a+1,y:o},{x:a-1,y:o},{x:a,y:o+1},{x:a,y:o-1}];for(const e of u)if(e.x>=0&&e.x<t&&e.y>=0&&e.y<n){const a=l(e.x,e.y);p[a]||0!==d[a]||(p[a]=1,i.push(a),r.push(a),0!==e.x&&e.x!==t-1&&0!==e.y&&e.y!==n-1||(s=!0))}}if(!s)for(const e of r)d[e]=1}for(let e=0;e<t*n;e++)1===d[e]?(o[4*e]=a[4*e],o[4*e+1]=a[4*e+1],o[4*e+2]=a[4*e+2],o[4*e+3]=255):(o[4*e]=255,o[4*e+1]=255,o[4*e+2]=255,o[4*e+3]=255);return new ImageData(o,t,n)}const u=new Set(["the","be","to","of","and","a","in","that","have","i","it","for","not","on","with","he","as","you","do","at","this","but","his","by","from","they","we","say","her","she","or","an","will","my","one","all","would","there","their","what","so","up","out","if","about","who","get","which","go","me","when","make","can","like","time","no","just","him","know","take","people","into","year","your","good","some","could","them","see","other","than","then","now","look","only","come","its","over","think","also","back","after","use","two","how","our","work","first","well","way","even","new","want","because","any","these","give","day","most","us","is","was","are","were","been","has","had","did","does","said","made","went","got","took","came","gave","thought","saw","knew","told","asked","found","left","ran","sat","stood","fell","kept","held","let","hello","world"]),g=new class{constructor(){this.dictionaries=new Map,this.loaded=!1}async load(e="eng"){this.dictionaries.has(e)||(this.dictionaries.set("eng",new Set(u)),this.loaded=!0)}has(e,t="eng"){const n=this.dictionaries.get(t);return!!n&&n.has(e.toLowerCase())}get(e="eng"){return this.dictionaries.get(e)}};function h(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let a=1;a<=t.length;a++)for(let o=1;o<=e.length;o++)t.charAt(a-1)===e.charAt(o-1)?n[a][o]=n[a-1][o-1]:n[a][o]=Math.min(n[a-1][o-1]+1,n[a][o-1]+1,n[a-1][o]+1);return n[t.length][e.length]}function m(e){return"string"!=typeof e?"":e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(e,t={}){if(!e)return e;let n=e;return!1!==t.noiseCleaning&&(n=function(e,t={}){if(!e)return e;const n=t.noiseAggression||"medium";let a=e.split("\n");return a=a.map(e=>{let t=e.trim();return t=t.replace(/^[|_=\u2014\-]+/,""),t=t.replace(/[|_=\u2014\-]+$/,""),/^[^a-zA-Z0-9]+$/.test(t)?/^[.?!]+$/.test(t)||t.includes("~")||"low"===n&&t.includes("-")?t:"":(t=t.split(" ").map(e=>1===e.length?/[a-zA-Z0-9]/.test(e)||/[.,;?!'"~]/.test(e)?e:/[|\\/=_\-]/.test(e)?"":"low"===n&&/[$â‚¬Â£%&+]/.test(e)?e:"":/^[|\\/=_\-]+$/.test(e)?"":e).join(" "),t.trim())}),a.filter(e=>e.length>0).join("\n")}(n,{noiseAggression:t.noiseAggression})),!1!==t.normalizeText&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/[ \t]+/g," "),t=t.replace(/\s+([.,!?:;)}\]])/g,"$1"),t=t.replace(/([({[])\s+/g,"$1"),t=t.replace(/([.,!?:;])([a-zA-Z])/g,"$1 $2"),t=t.trim(),t}(n)),!0===t.manhwaMode&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/\b[A-Z](?: [A-Z])+\b/g,e=>e.replace(/ /g,"")),t.split(/\n\s*\n/).map(e=>{let t=e;return t=t.replace(/-\n/g,""),t=t.replace(/\n/g," "),t=t.replace(/\s+/g," ").trim(),t=t.replace(/\s+([.,;?!])/g,"$1"),t}).join("\n\n")}(n)),!1!==t.regexCorrection&&(n=function(e){if(!e)return e;let t=e;return t=t.replace(/[ \t]+/g," "),t=t.replace(/ ([.,;:!?])/g,"$1"),t=t.replace(/\( /g,"(").replace(/ \)/g,")"),t=t.replace(/\b[l1]\b(?= am| have| don't| will)/g,"I"),t=t.replace(/^\|\s*/gm,"").replace(/\s*\|$/gm,""),t.trim()}(n)),!0===t.dictionaryCorrection&&(n=function(e,t={}){if(!e)return e;const n=!1!==t.ignoreAllCaps,a=t.dictionaryStrength||1;if(!g.loaded)return e;const o=g.get("eng");return e.replace(/[a-zA-Z]+/g,e=>{if(e.length<3)return e;const t=/^[A-Z]+$/.test(e);if(n&&t)return e;if(g.has(e))return e;const r=function(e,t,n=2){let a=null,o=1/0;const r=(Set,t);for(const t of r){if(Math.abs(t.length-e.length)>n)continue;if(t===e)return e;const r=h(e,t);r<=n&&r<o&&(o=r,a=t)}return a}(e.toLowerCase(),o,a);return r?function(e,t){return e===e.toUpperCase()?t.toUpperCase():e[0]===e[0].toUpperCase()?t.charAt(0).toUpperCase()+t.slice(1):t}(e,r):e})}(n,{ignoreAllCaps:t.dictionaryIgnoreCaps,dictionaryStrength:t.dictionaryStrength})),!1!==t.userRules&&(n=function(e,t={}){if(!e)return e;let n=e;const a=Array.isArray(t.deletions)?t.deletions:[],o=Array.isArray(t.replacements)?t.replacements:[];return a.length>0&&a.forEach(e=>{let t,a,o,r;if("object"==typeof e&&null!==e){if(t=e.char,!t)return;a=!0===e.ignoreBetweenLetters,o=!0===e.ignoreBetweenNumbers,r=!0===e.ignoreInsideWords}else{if("string"!=typeof e)return;t=e,a=!1,o=!1,r=!1}if(!a&&!o&&!r)return void(n=n.split(t).join(""));const i=m(t),s=new RegExp(i,"g");n=n.replace(s,(e,t,n)=>{const i=n[t-1]||"",s=n[t+e.length]||"",l=/[a-zA-Z\u00C0-\u00FF]/.test(i),c=/[a-zA-Z\u00C0-\u00FF]/.test(s),d=/[0-9]/.test(i),p=/[0-9]/.test(s);return a&&l&&c||o&&d&&p||r&&(l||d)&&(c||p)?e:""})}),o.length>0&&o.forEach(e=>{if(!1!==e.enabled&&e.find)try{let t,a=e.find,o="g";if(e.caseSensitive||(o+="i"),e.isRegex)t=new RegExp(a,o);else{let n=m(a);if(e.wholeWord){const e=/\w/.test(a[0]),t=/\w/.test(a[a.length-1]);e&&(n=`\\b${n}`),t&&(n=`${n}\\b`)}t=new RegExp(n,o)}const r=e.replace||"";n=n.replace(t,r)}catch(t){console.warn(`Text Processing: Invalid regex rule "${e.find}"`,t)}}),n}(n,{deletions:t.deletions,replacements:t.replacements})),!1!==t.textReconstruction&&(n=function(e,t={}){if(!e)return e;let n=e;if(!1!==t.mergeLines){const e=n.split(/\n\s*\n/);n=e.map(e=>e.replace(/\n/g," ")).join("\n\n")}return!1!==t.stabilizeSentences&&(n=n.replace(/(\w+)-\s+(\w+)/g,"$1$2")),n}(n,{mergeLines:t.reconstructMergeLines,stabilizeSentences:t.reconstructStabilize})),n}var y=n(651);const b={tess_psm:"3",tess_oem:"1",tess_whitelist:"",tess_lang:"eng",auto_psm:!1},w=new class{constructor(){this.cache={...b},this.listeners=[],this.loaded=!1}async load(){const e=Object.keys(b),t=await(0,y.mt)(e);return this.cache={...b,...t},this.loaded=!0,this.cache}get(e){return this.cache[e]}async set(e,t){this.cache[e]=t,await(0,y.saveSettings)({[e]:t}),this.notifyListeners()}async setConfig(e){this.cache={...this.cache,...e},await(0,y.saveSettings)(e),this.notifyListeners()}onChange(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>e(this.cache))}getOptimalPSM(e,t){if(!this.cache.auto_psm)return this.cache.tess_psm;const n=e/t;return n>3?"7":n<.2?"5":"6"}},x={container:null,show(){this.container||this.create(),this.container.style.display="block"},hide(){this.container&&(this.container.style.display="none")},clear(){if(this.container){const e=this.container.querySelector(".debug-list");e&&(e.innerHTML="")}},create(){const e=document.createElement("div");e.id="ocr-debug-viewer",e.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            right: 20px;\n            width: 350px;\n            max-height: 80vh;\n            background: rgba(30, 30, 30, 0.95);\n            border: 1px solid #444;\n            border-radius: 8px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n            z-index: 1000000;\n            display: flex;\n            flex-direction: column;\n            color: #eee;\n            font-family: sans-serif;\n            overflow: hidden;\n        ";const t=document.createElement("div");t.style.cssText="\n            padding: 10px;\n            background: #252526;\n            border-bottom: 1px solid #444;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        ",t.innerHTML="<strong>Preprocessing Debug</strong>";const n=document.createElement("button");n.textContent="Ã—",n.style.cssText="\n            background: none;\n            border: none;\n            color: #aaa;\n            font-size: 18px;\n            cursor: pointer;\n        ",n.onclick=()=>this.hide(),t.appendChild(n),e.appendChild(t);const a=document.createElement("div");a.className="debug-list",a.style.cssText="\n            flex: 1;\n            overflow-y: auto;\n            padding: 10px;\n        ",e.appendChild(a),document.body.appendChild(e),this.container=e},addStep(e,t){if(!this.container)return;const n=this.container.querySelector(".debug-list"),a=document.createElement("div");a.style.marginBottom="15px";const o=document.createElement("div");let r;if(o.textContent=e,o.style.fontSize="12px",o.style.marginBottom="5px",o.style.color="#ccc",a.appendChild(o),t instanceof HTMLCanvasElement){r=t;const e=document.createElement("canvas");e.width=r.width,e.height=r.height,e.getContext("2d").drawImage(r,0,0),r=e}else if(t instanceof ImageData){r=document.createElement("canvas"),r.width=t.width,r.height=t.height;try{r.getContext("2d").putImageData(t,0,0)}catch(e){const n=r.getContext("2d"),a=n.createImageData(t.width,t.height);a.data.set(new Uint8ClampedArray(t.data)),n.putImageData(a,0,0)}}r&&(r.style.maxWidth="100%",r.style.height="auto",r.style.border="1px solid #555",a.appendChild(r)),n.appendChild(a),n.scrollTop=n.scrollHeight}};async function v(e,t={}){try{const n=e.getContext("2d"),u=e.width,g=e.height;let h;try{h=r(n.getImageData(0,0,u,g))}catch(e){if("SecurityError"===e.name||e.message.includes("insecure"))throw console.warn("Canvas tainted. Attempting workaround via data URL."),new Error("Canvas tainted. Cannot extract image data for OCR.");throw e}await w.load();const m=await(0,y.mt)(["tess_lang","preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","preprocess_borders","debug_mode","clean_noise","noise_aggression","clean_normalize","clean_regex","clean_dict","dict_strength","dict_ignore_caps","clean_user","manhwa_mode","reconstruct_text","reconstruct_merge","reconstruct_stabilize"]),b=!0===m.debug_mode;b&&(x.show(),x.clear(),x.addStep("Original",e));const v={resize:!1!==m.preprocess_resize,grayscale:!1!==m.preprocess_grayscale,contrast:!1!==m.preprocess_contrast,medianBlur:!1!==m.preprocess_blur,adaptiveThreshold:!1!==m.preprocess_threshold,morphology:!1!==m.preprocess_morphology,removeBorders:!1!==m.preprocess_borders,debug:b,onStep:(e,t)=>x.addStep(e,t),...t.image},_=await async function(e,t={}){const n=function(e){const t=[],n=(t,n)=>{e.debug&&e.onStep&&e.onStep(t,n)};return!1!==e.resize&&t.push({stage:o,options:{scale:e.scale||2},name:"resize",onComplete:n}),e.grayscale&&t.push({stage:s,name:"grayscale",onComplete:n}),e.medianBlur&&t.push({stage:l,name:"blur",onComplete:n}),e.contrast&&t.push({stage:i,options:{val:e.contrastVal||50},name:"contrast",onComplete:n}),e.adaptiveThreshold&&t.push({stage:c,options:{blockSize:15,constant:10},name:"threshold",onComplete:n}),e.morphology&&t.push({stage:d,options:{type:"open",kernelSize:1},name:"morphology",onComplete:n}),e.removeBorders&&t.push({stage:p,name:"region",onComplete:n}),t}(t);let a=await async function(e,t){let n=e;const a=e=>(ImageData,e);for(const e of t)try{"function"==typeof e?n=await e(n):e&&"function"==typeof e.stage&&(n=await e.stage(n,e.options||{}),e.onComplete&&e.onComplete(e.name||"Stage",a(n)))}catch(t){throw console.error(`Pipeline stage failed: ${e.name||("function"==typeof e?e.name:"unknown")}`,t),t}return n}(e,n);if(a instanceof HTMLCanvasElement){const e=a.getContext("2d");a=e.getImageData(0,0,a.width,a.height)}return a}(h,v),C=document.createElement("canvas");if(_ instanceof ImageData){C.width=_.width,C.height=_.height;const e=C.getContext("2d");try{e.putImageData(_,0,0)}catch(t){try{const t=r(_);e.putImageData(t,0,0)}catch(e){throw console.error("Critical: Failed to process image data config for OCR engine",e),e}}}else if(_ instanceof HTMLCanvasElement){C.width=_.width,C.height=_.height;const e=C.getContext("2d");try{e.drawImage(_,0,0)}catch(e){throw console.error("Critical: Failed to draw processed canvas to Tesseract input",e),e}}else{console.warn("Pipeline returned unknown object.");try{C.width=u,C.height=g,C.getContext("2d").putImageData(h,0,0)}catch(e){throw console.error("Critical: Failed to fallback to original image",e),e}}const E=t.lang||m.tess_lang||"eng",S=await(0,a.createWorker)(E);let k=3;try{w&&w.getOptimalPSM&&(k=w.getOptimalPSM(u,g))}catch(e){console.warn("Config PSM failed",e)}await S.setParameters({tessedit_pageseg_mode:k});let L={data:{text:"",confidence:0}};try{L=await S.recognize(C)}catch(e){throw console.error("Tesseract recognition failed",e),e}finally{await S.terminate()}const{data:{text:I,confidence:A}}=L,O=I?I.trim():"";let T="global";try{const e=window.location.origin;e&&"null"!==e&&(T=`site:${e}`)}catch(e){console.warn("Could not determine origin for rules scope")}const R=await(0,y.rM)(T);return{text:f(O,{noiseCleaning:!1!==m.clean_noise,noiseAggression:m.noise_aggression||"medium",normalizeText:!1!==m.clean_normalize,textReconstruction:!0===m.reconstruct_text,reconstructMergeLines:!1!==m.reconstruct_merge,reconstructStabilize:!1!==m.reconstruct_stabilize,regexCorrection:!1!==m.clean_regex,dictionaryCorrection:!0===m.clean_dict,dictionaryStrength:void 0!==m.dict_strength?m.dict_strength:1,dictionaryIgnoreCaps:!1!==m.dict_ignore_caps,userRules:!1!==m.clean_user,replacements:R.replacements,deletions:R.deletions,manhwaMode:!0===m.manhwa_mode,...t}),originalText:O,confidence:A}}catch(e){throw console.error("OCR/Pipeline processing failed:",e),e}}},456(e,t,n){"use strict";const a=n(886);e.exports={recognize:async(e,t,n)=>{const o=await a(t,1,n);return o.recognize(e).finally(async()=>{await o.terminate()})},detect:async(e,t)=>{const n=await a("osd",0,t);return n.detect(e).finally(async()=>{await n.terminate()})}}},473(e){var t=function(e){"use strict";var t,n=Object.prototype,a=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",s=r.asyncIterator||"@@asyncIterator",l=r.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function d(e,t,n,a){var r=t&&t.prototype instanceof y?t:y,i=Object.create(r.prototype),s=new O(a||[]);return o(i,"_invoke",{value:k(e,n,s)}),i}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=d;var u="suspendedStart",g="suspendedYield",h="executing",m="completed",f={};function y(){}function b(){}function w(){}var x={};c(x,i,function(){return this});var v=Object.getPrototypeOf,_=v&&v(v(T([])));_&&_!==n&&a.call(_,i)&&(x=_);var C=w.prototype=y.prototype=Object.create(x);function E(e){["next","throw","return"].forEach(function(t){c(e,t,function(e){return this._invoke(t,e)})})}function S(e,t){function n(o,r,i,s){var l=p(e[o],e,r);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==typeof d&&a.call(d,"__await")?t.resolve(d.__await).then(function(e){n("next",e,i,s)},function(e){n("throw",e,i,s)}):t.resolve(d).then(function(e){c.value=e,i(c)},function(e){return n("throw",e,i,s)})}s(l.arg)}var r;o(this,"_invoke",{value:function(e,a){function o(){return new t(function(t,o){n(e,a,t,o)})}return r=r?r.then(o,o):o()}})}function k(e,t,n){var a=u;return function(o,r){if(a===h)throw new Error("Generator is already running");if(a===m){if("throw"===o)throw r;return R()}for(n.method=o,n.arg=r;;){var i=n.delegate;if(i){var s=L(i,n);if(s){if(s===f)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(a===u)throw a=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=h;var l=p(e,t,n);if("normal"===l.type){if(a=n.done?m:g,l.arg===f)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(a=m,n.method="throw",n.arg=l.arg)}}}function L(e,n){var a=n.method,o=e.iterator[a];if(o===t)return n.delegate=null,"throw"===a&&e.iterator.return&&(n.method="return",n.arg=t,L(e,n),"throw"===n.method)||"return"!==a&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+a+"' method")),f;var r=p(o,e.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,f;var i=r.arg;return i?i.done?(n[e.resultName]=i.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,f):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function T(e){if(e){var n=e[i];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,r=function n(){for(;++o<e.length;)if(a.call(e,o))return n.value=e[o],n.done=!1,n;return n.value=t,n.done=!0,n};return r.next=r}}return{next:R}}function R(){return{value:t,done:!0}}return b.prototype=w,o(C,"constructor",{value:w,configurable:!0}),o(w,"constructor",{value:b,configurable:!0}),b.displayName=c(w,l,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,c(e,l,"GeneratorFunction")),e.prototype=Object.create(C),e},e.awrap=function(e){return{__await:e}},E(S.prototype),c(S.prototype,s,function(){return this}),e.AsyncIterator=S,e.async=function(t,n,a,o,r){void 0===r&&(r=Promise);var i=new S(d(t,n,a,o),r);return e.isGeneratorFunction(n)?i:i.next().then(function(e){return e.done?e.value:i.next()})},E(C),c(C,l,"Generator"),c(C,i,function(){return this}),c(C,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),n=[];for(var a in t)n.push(a);return n.reverse(),function e(){for(;n.length;){var a=n.pop();if(a in t)return e.value=a,e.done=!1,e}return e.done=!0,e}},e.values=T,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(A),!e)for(var n in this)"t"===n.charAt(0)&&a.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function o(a,o){return s.type="throw",s.arg=e,n.next=a,o&&(n.method="next",n.arg=t),!!o}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var l=a.call(i,"catchLoc"),c=a.call(i,"finallyLoc");if(l&&c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&a.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var r=o;break}}r&&("break"===e||"continue"===e)&&r.tryLoc<=t&&t<=r.finallyLoc&&(r=null);var i=r?r.completion:{};return i.type=e,i.arg=t,r?(this.method="next",this.next=r.finallyLoc,f):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var o=a.arg;A(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,a){return this.delegate={iterator:T(e),resultName:n,nextLoc:a},"next"===this.method&&(this.arg=t),f}},e}(e.exports);try{regeneratorRuntime=t}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=t:Function("r","regeneratorRuntime = r")(t)}},502(e,t,n){"use strict";const a=n(561),o=n(243),r=n(403),i=n(362),s=n(82),l=n(835);e.exports={defaultOptions:a,spawnWorker:o,terminateWorker:r,onMessage:i,send:s,loadImage:l}},539(e){"use strict";e.exports={rE:"7.0.0"}},561(e,t,n){"use strict";const a=n(539).rE,o=n(119);e.exports={...o,workerPath:`https://cdn.jsdelivr.net/npm/tesseract.js@v${a}/dist/worker.min.js`}},633(e,t,n){"use strict";const a=n(397);let o=0;e.exports=({id:e,action:t,payload:n={}})=>{let r=e;return void 0===r&&(r=a("Job",o),o+=1),{id:r,action:t,payload:n}}},639(e){"use strict";e.exports={AFR:"afr",AMH:"amh",ARA:"ara",ASM:"asm",AZE:"aze",AZE_CYRL:"aze_cyrl",BEL:"bel",BEN:"ben",BOD:"bod",BOS:"bos",BUL:"bul",CAT:"cat",CEB:"ceb",CES:"ces",CHI_SIM:"chi_sim",CHI_TRA:"chi_tra",CHR:"chr",CYM:"cym",DAN:"dan",DEU:"deu",DZO:"dzo",ELL:"ell",ENG:"eng",ENM:"enm",EPO:"epo",EST:"est",EUS:"eus",FAS:"fas",FIN:"fin",FRA:"fra",FRK:"frk",FRM:"frm",GLE:"gle",GLG:"glg",GRC:"grc",GUJ:"guj",HAT:"hat",HEB:"heb",HIN:"hin",HRV:"hrv",HUN:"hun",IKU:"iku",IND:"ind",ISL:"isl",ITA:"ita",ITA_OLD:"ita_old",JAV:"jav",JPN:"jpn",KAN:"kan",KAT:"kat",KAT_OLD:"kat_old",KAZ:"kaz",KHM:"khm",KIR:"kir",KOR:"kor",KUR:"kur",LAO:"lao",LAT:"lat",LAV:"lav",LIT:"lit",MAL:"mal",MAR:"mar",MKD:"mkd",MLT:"mlt",MSA:"msa",MYA:"mya",NEP:"nep",NLD:"nld",NOR:"nor",ORI:"ori",PAN:"pan",POL:"pol",POR:"por",PUS:"pus",RON:"ron",RUS:"rus",SAN:"san",SIN:"sin",SLK:"slk",SLV:"slv",SPA:"spa",SPA_OLD:"spa_old",SQI:"sqi",SRP:"srp",SRP_LATN:"srp_latn",SWA:"swa",SWE:"swe",SYR:"syr",TAM:"tam",TEL:"tel",TGK:"tgk",TGL:"tgl",THA:"tha",TIR:"tir",TUR:"tur",UIG:"uig",UKR:"ukr",URD:"urd",UZB:"uzb",UZB_CYRL:"uzb_cyrl",VIE:"vie",YID:"yid"}},651(e,t,n){"use strict";n.d(t,{A7:()=>y,Df:()=>m,SH:()=>d,e6:()=>c,gn:()=>p,kS:()=>g,lp:()=>u,mt:()=>s,rM:()=>b,saveSettings:()=>l,uX:()=>h,vv:()=>f});const a="ocr_settings_data_v3",o={name:"Default",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,preprocess_morphology:!1,preprocess_borders:!1,tess_psm:"3",tess_oem:"1",tess_lang:"eng",tess_whitelist:"",auto_psm:!1,clean_noise:!0,noise_aggression:"medium",clean_normalize:!0,clean_regex:!0,clean_dict:!1,dict_strength:1,dict_ignore_caps:!0,clean_user:!0,manhwa_mode:!1,reconstruct_text:!0,reconstruct_merge:!0,reconstruct_stabilize:!0,trans_src:"auto",trans_target:"en",trans_auto:!1,trans_style:"below",debug_mode:!1,popup_hidden_buttons:[],user_replacements:[],user_deletions:[]},r={...o,name:"Manhwa Mode",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,clean_dict:!1,manhwa_mode:!0,reconstruct_merge:!0,reconstruct_stabilize:!0},i={active_profile_id:"default",floating_button_enabled:!0,floating_button_mode:"blacklist",floating_button_blacklist:[],floating_button_whitelist:[],profiles:{},enable_multiselect:!1,floating_visible_preprocess:!0,floating_visible_cleaning:!0,floating_visible_findreplace:!0,floating_visible_chardel:!0,floating_visible_profiles:!0,floating_visible_language:!0,floating_visible_translation:!0,floating_visible_ui:!0};async function s(e=null){const t=await w(),n=t.global&&t.global.active_profile_id?t.global.active_profile_id:"default";t.profiles||(t.profiles={default:{...o}});let a=t.profiles[n];a||(a=t.profiles.default||{...o});const r={...t.global,...a,_profileId:n};return Array.isArray(e)?e.reduce((e,t)=>(e[t]=r[t],e),{}):r}async function l(e){const t=await w(),n=t.global.active_profile_id,r=Object.keys(i);let s=!1,l=!1;for(const[a,i]of Object.entries(e))r.includes(a)||"active_profile_id"===a?(t.global[a]=i,l=!0):(t.profiles[n]||(t.profiles[n]={...o}),t.profiles[n][a]=i,s=!0);return await browser.storage.local.set({[a]:t}),t}async function c(){const e=await w(),t=[],n=[];return Object.entries(e.profiles).forEach(([e,a])=>{const o={id:e,name:a.name||"Unnamed"};"default"===e?t.unshift(o):"manhwa"===e?t.push(o):n.push(o)}),n.sort((e,t)=>e.name.localeCompare(t.name)),[...t,...n]}async function d(e,t=null){const n=await w(),r=`profile_${Date.now()}`;let i=o;return t&&n.profiles[t]&&(i=n.profiles[t]),n.profiles[r]={...i,name:e},await browser.storage.local.set({[a]:n}),r}async function p(e,t){const n=await w();return!!n.profiles[e]&&(n.profiles[e].name=t,await browser.storage.local.set({[a]:n}),!0)}async function u(e){const t=await w();return"default"!==e&&"manhwa"!==e&&(delete t.profiles[e],t.global.active_profile_id===e&&(t.global.active_profile_id="default"),await browser.storage.local.set({[a]:t}),!0)}async function g(e){const t=await w();return!!t.profiles[e]&&(t.global.active_profile_id=e,await browser.storage.local.set({[a]:t}),!0)}async function h(e="full",t={}){const n=await w();if("full"===e){const e={version:1,timestamp:Date.now(),type:"full_backup",data:n,site_replacements:{},site_deletions:{}},t=await browser.storage.local.get(null);return Object.keys(t).forEach(n=>{n.startsWith("user_replacements_site:")&&(e.site_replacements[n]=t[n]),n.startsWith("user_deletions_site:")&&(e.site_deletions[n]=t[n])}),JSON.stringify(e,null,2)}if("profile"===e){const e=t.id||n.global.active_profile_id,a=n.profiles[e];if(!a)throw new Error("Profile not found");const o={version:1,timestamp:Date.now(),type:"profile_export",name:a.name,data:a};return JSON.stringify(o,null,2)}}async function m(e,t="merge"){let n;try{n=JSON.parse(e)}catch(e){throw new Error("Invalid JSON format")}if(!n.version||!n.type)throw new Error("Invalid settings file (missing metadata)");const r=await w();if("profile_export"===n.type){const e=`profile_${Date.now()}_imp`,i=n.name+("merge"===t?" (Imported)":"");return r.profiles[e]={...o,...n.data},r.profiles[e].name=i,await browser.storage.local.set({[a]:r}),{success:!0,message:`Imported profile "${i}"`}}if("full_backup"===n.type){const e=n.data;if("replace"===t)return await browser.storage.local.set({[a]:e}),n.site_replacements&&await browser.storage.local.set(n.site_replacements),n.site_deletions&&await browser.storage.local.set(n.site_deletions),{success:!0,message:"Settings fully restored."};if("merge"===t){let t=0;for(const[n,a]of Object.entries(e.profiles))if(r.profiles[n]){const e=`${n}_merge_${Date.now()}`;r.profiles[e]={...a,name:a.name+" (Imported)"},t++}else r.profiles[n]=a,t++;return await browser.storage.local.set({[a]:r}),{success:!0,message:`Merged ${t} profiles.`}}}throw new Error("Unknown import type")}async function f(e,t){const n=await w();if("profile"===e){const e=n.global.active_profile_id,t=n.profiles[e].name;return n.profiles[e]={...o,name:t},await browser.storage.local.set({[a]:n}),!0}if("full"===e){await browser.storage.local.clear();const e={global:{...i},profiles:{default:{...o}}};return await browser.storage.local.set({[a]:e}),!0}if("section"===e){if(!Array.isArray(t))return!1;const e=n.global.active_profile_id;return t.forEach(t=>{o.hasOwnProperty(t)&&(n.profiles[e][t]=o[t])}),await browser.storage.local.set({[a]:n}),!0}}async function y(e){if("global"===e){const e=await s(["user_replacements","user_deletions"]);return{replacements:e.user_replacements||[],deletions:e.user_deletions||[]}}{const t=`user_replacements_${e}`,n=`user_deletions_${e}`,a=await browser.storage.local.get([t,n]);return{replacements:a[t]||[],deletions:a[n]||[]}}}async function b(e){const t=await y("global");if(!e||"global"===e)return t;const n=await y(e);return{replacements:[...t.replacements,...n.replacements],deletions:[...t.deletions,...n.deletions]}}async function w(){let e=(await browser.storage.local.get(a))[a];return e&&e.profiles||(e={global:{...i},profiles:{default:{...o},manhwa:{...r}}},await browser.storage.local.set({[a]:e})),e.profiles.manhwa||e.profiles.manhwa_v1||(e.profiles.manhwa={...r},await browser.storage.local.set({[a]:e})),e}},811(e,t,n){"use strict";const a=n(633),{log:o}=n(866),r=n(397);let i=0;e.exports=()=>{const e=r("Scheduler",i),t={},n={};let s=[];i+=1;const l=()=>Object.keys(t).length,c=()=>{if(0!==s.length){const e=Object.keys(t);for(let a=0;a<e.length;a+=1)if(void 0===n[e[a]]){s[0](t[e[a]]);break}}},d=(t,r)=>new Promise((i,l)=>{const d=a({action:t,payload:r});s.push(async e=>{s.shift(),n[e.id]=d;try{i(await e[t].apply(this,[...r,d.id]))}catch(e){l(e)}finally{delete n[e.id],c()}}),o(`[${e}]: Add ${d.id} to JobQueue`),o(`[${e}]: JobQueue length=${s.length}`),c()});return{addWorker:n=>(t[n.id]=n,o(`[${e}]: Add ${n.id}`),o(`[${e}]: Number of workers=${l()}`),c(),n.id),addJob:async(t,...n)=>{if(0===l())throw Error(`[${e}]: You need to have at least one worker before adding jobs`);return d(t,n)},terminate:async()=>{Object.keys(t).forEach(async e=>{await t[e].terminate()}),s=[]},getQueueLen:()=>s.length,getNumWorkers:l}}},835(e){"use strict";const t=e=>new Promise((t,n)=>{const a=new FileReader;a.onload=()=>{t(a.result)},a.onerror=({target:{error:{code:e}}})=>{n(Error(`File could not be read! Code=${e}`))},a.readAsArrayBuffer(e)}),n=async e=>{let a=e;if(void 0===e)return"undefined";if("string"==typeof e)if(/data:image\/([a-zA-Z]*);base64,([^"]*)/.test(e))a=atob(e.split(",")[1]).split("").map(e=>e.charCodeAt(0));else{const t=await fetch(e);a=await t.arrayBuffer()}else if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)"IMG"===e.tagName&&(a=await n(e.src)),"VIDEO"===e.tagName&&(a=await n(e.poster)),"CANVAS"===e.tagName&&await new Promise(n=>{e.toBlob(async e=>{a=await t(e),n()})});else if("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){const n=await e.convertToBlob();a=await t(n)}else(e instanceof File||e instanceof Blob)&&(a=await t(e));return new Uint8Array(a)};e.exports=n},866(e,t){"use strict";let n=!1;t.logging=n,t.setLogging=e=>{n=e},t.log=(...e)=>n?console.log.apply(this,e):null},886(e,t,n){"use strict";const a=n(294),o=n(633),{log:r}=n(866),i=n(397),s=n(171),{defaultOptions:l,spawnWorker:c,terminateWorker:d,onMessage:p,loadImage:u,send:g}=n(502);let h=0;e.exports=async(e="eng",t=s.LSTM_ONLY,n={},m={})=>{const f=i("Worker",h),{logger:y,errorHandler:b,...w}=a({...l,...n}),x={},v="string"==typeof e?e.split("+"):e;let _=t,C=m;const E=[s.DEFAULT,s.LSTM_ONLY].includes(t)&&!w.legacyCore;let S,k;const L=new Promise((e,t)=>{k=e,S=t});let I=c(w);I.onerror=e=>{S(e.message)},h+=1;const A=({id:e,action:t,payload:n})=>new Promise((a,o)=>{r(`[${f}]: Start ${e}, action=${t}`),x[`${t}-${e}`]={resolve:a,reject:o},g(I,{workerId:f,jobId:e,action:t,payload:n})}),O=(e,t)=>A(o({id:t,action:"loadLanguage",payload:{langs:e,options:{langPath:w.langPath,dataPath:w.dataPath,cachePath:w.cachePath,cacheMethod:w.cacheMethod,gzip:w.gzip,lstmOnly:[s.DEFAULT,s.LSTM_ONLY].includes(_)&&!w.legacyLang}}})),T=(e,t,n,a)=>A(o({id:a,action:"initialize",payload:{langs:e,oem:t,config:n}}));p(I,({workerId:e,jobId:t,status:n,action:a,data:o})=>{const i=`${a}-${t}`;if("resolve"===n)r(`[${e}]: Complete ${t}`),x[i].resolve({jobId:t,data:o}),delete x[i];else if("reject"===n){if(x[i].reject(o),delete x[i],"load"===a&&S(o),!b)throw Error(o);b(o)}else"progress"===n&&y({...o,userJobId:t})});const R={id:f,worker:I,load:()=>console.warn("`load` is depreciated and should be removed from code (workers now come pre-loaded)"),writeText:(e,t,n)=>A(o({id:n,action:"FS",payload:{method:"writeFile",args:[e,t]}})),readText:(e,t)=>A(o({id:t,action:"FS",payload:{method:"readFile",args:[e,{encoding:"utf8"}]}})),removeFile:(e,t)=>A(o({id:t,action:"FS",payload:{method:"unlink",args:[e]}})),FS:(e,t,n)=>A(o({id:n,action:"FS",payload:{method:e,args:t}})),reinitialize:(e="eng",t,n,a)=>{if(E&&[s.TESSERACT_ONLY,s.TESSERACT_LSTM_COMBINED].includes(t))throw Error("Legacy model requested but code missing.");const o=t||_;_=o;const r=n||C;C=r;const i=("string"==typeof e?e.split("+"):e).filter(e=>!v.includes(e));return v.push(...i),i.length>0?O(i,a).then(()=>T(e,o,r,a)):T(e,o,r,a)},setParameters:(e={},t)=>A(o({id:t,action:"setParameters",payload:{params:e}})),recognize:async(e,t={},n={text:!0},a)=>A(o({id:a,action:"recognize",payload:{image:await u(e),options:t,output:n}})),detect:async(e,t)=>{if(E)throw Error("`worker.detect` requires Legacy model, which was not loaded.");return A(o({id:t,action:"detect",payload:{image:await u(e)}}))},terminate:async()=>(null!==I&&(d(I),I=null),Promise.resolve())};return A(o({id:undefined,action:"load",payload:{options:{lstmOnly:E,corePath:w.corePath,logging:w.logging}}})).then(()=>O(e)).then(()=>T(e,t,m)).then(()=>k(R)).catch(()=>{}),L}},928(e){"use strict";e.exports={OSD_ONLY:"0",AUTO_OSD:"1",AUTO_ONLY:"2",AUTO:"3",SINGLE_COLUMN:"4",SINGLE_BLOCK_VERT_TEXT:"5",SINGLE_BLOCK:"6",SINGLE_LINE:"7",SINGLE_WORD:"8",CIRCLE_WORD:"9",SINGLE_CHAR:"10",SPARSE_TEXT:"11",SPARSE_TEXT_OSD:"12",RAW_LINE:"13"}}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var r=t[a]={exports:{}};return e[a].call(r.exports,r,r.exports,n),r.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=n(432);function t(e,t="110px",n="32px",a=null){const o=document.createElement("button");return o.textContent=e,o.style.width=t,o.style.height=n,o.style.padding="4px 8px",o.style.backgroundColor="#374151",o.style.color="#f9fafb",o.style.border="1px solid #4b5563",o.style.borderRadius="6px",o.style.cursor="pointer",o.style.fontSize="14px",o.style.fontWeight="600",o.style.fontFamily="Inter, sans-serif",o.style.transition="all 0.2s ease",o.style.whiteSpace="nowrap",o.style.overflow="hidden",o.style.textOverflow="ellipsis",o.dataset.origBg=o.style.backgroundColor,o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#4b5563",o.style.transform="translateY(-1px)",o.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor=o.dataset.origBg||o.style.backgroundColor,o.style.transform="translateY(0)",o.style.boxShadow="none"}),o.addEventListener("mousedown",()=>{o.style.transform="translateY(1px) scale(0.98)"}),o.addEventListener("mouseup",()=>{o.style.transform="translateY(-1px)"}),a&&o.addEventListener("click",a),o}function a(e){return e.replace(/1/g,"I").replace(/5/g,"S").replace(/0/g,"O").replace(/2/g,"Z").replace(/3/g,"E").replace(/4/g,"A").replace(/6/g,"G").replace(/7/g,"T").replace(/8/g,"B").replace(/9/g,"g")}var o=n(651);const r=[{code:"afr",name:"Afrikaans"},{code:"amh",name:"Amharic"},{code:"ara",name:"Arabic"},{code:"asm",name:"Assamese"},{code:"aze",name:"Azerbaijani"},{code:"aze_cyrl",name:"Azerbaijani (Cyrillic)"},{code:"bel",name:"Belarusian"},{code:"ben",name:"Bengali"},{code:"bod",name:"Tibetan"},{code:"bos",name:"Bosnian"},{code:"bul",name:"Bulgarian"},{code:"cat",name:"Catalan"},{code:"ceb",name:"Cebuano"},{code:"ces",name:"Czech"},{code:"chi_sim",name:"Chinese (Simplified)"},{code:"chi_tra",name:"Chinese (Traditional)"},{code:"chr",name:"Cherokee"},{code:"cym",name:"Welsh"},{code:"dan",name:"Danish"},{code:"deu",name:"German"},{code:"dzo",name:"Dzongkha"},{code:"ell",name:"Greek"},{code:"eng",name:"English"},{code:"enm",name:"English (Middle)"},{code:"epo",name:"Esperanto"},{code:"est",name:"Estonian"},{code:"eus",name:"Basque"},{code:"fas",name:"Persian"},{code:"fin",name:"Finnish"},{code:"fra",name:"French"},{code:"frk",name:"Frankish"},{code:"frm",name:"French (Middle)"},{code:"gle",name:"Irish"},{code:"glg",name:"Galician"},{code:"grc",name:"Greek (Ancient)"},{code:"guj",name:"Gujarati"},{code:"hat",name:"Haitian"},{code:"heb",name:"Hebrew"},{code:"hin",name:"Hindi"},{code:"hrv",name:"Croatian"},{code:"hun",name:"Hungarian"},{code:"iku",name:"Inuktitut"},{code:"ind",name:"Indonesian"},{code:"isl",name:"Icelandic"},{code:"ita",name:"Italian"},{code:"ita_old",name:"Italian (Old)"},{code:"jav",name:"Javanese"},{code:"jpn",name:"Japanese"},{code:"kan",name:"Kannada"},{code:"kat",name:"Georgian"},{code:"kat_old",name:"Georgian (Old)"},{code:"kaz",name:"Kazakh"},{code:"khm",name:"Khmer"},{code:"kir",name:"Kirghiz"},{code:"kor",name:"Korean"},{code:"kur",name:"Kurdish"},{code:"lao",name:"Lao"},{code:"lat",name:"Latin"},{code:"lav",name:"Latvian"},{code:"lit",name:"Lithuanian"},{code:"mal",name:"Malayalam"},{code:"mar",name:"Marathi"},{code:"mkd",name:"Macedonian"},{code:"mlt",name:"Maltese"},{code:"msa",name:"Malay"},{code:"mya",name:"Burmese"},{code:"nep",name:"Nepali"},{code:"nld",name:"Dutch"},{code:"nor",name:"Norwegian"},{code:"ori",name:"Oriya"},{code:"pan",name:"Punjabi"},{code:"pol",name:"Polish"},{code:"por",name:"Portuguese"},{code:"pus",name:"Pashto"},{code:"ron",name:"Romanian"},{code:"rus",name:"Russian"},{code:"san",name:"Sanskrit"},{code:"sin",name:"Sinhala"},{code:"slk",name:"Slovak"},{code:"slv",name:"Slovenian"},{code:"spa",name:"Spanish"},{code:"spa_old",name:"Spanish (Old)"},{code:"sqi",name:"Albanian"},{code:"srp",name:"Serbian"},{code:"srp_latn",name:"Serbian (Latin)"},{code:"swan",name:"Swahili"},{code:"swe",name:"Swedish"},{code:"syr",name:"Syriac"},{code:"tam",name:"Tamil"},{code:"tel",name:"Telugu"},{code:"tgk",name:"Tajik"},{code:"tgl",name:"Tagalog"},{code:"tha",name:"Thai"},{code:"tir",name:"Tigrinya"},{code:"tur",name:"Turkish"},{code:"uig",name:"Uighur"},{code:"ukr",name:"Ukrainian"},{code:"urd",name:"Urdu"},{code:"uzb",name:"Uzbek"},{code:"uzb_cyrl",name:"Uzbek (Cyrillic)"},{code:"vie",name:"Vietnamese"},{code:"yid",name:"Yiddish"}],i=[{code:"auto",name:"Auto Detect"},{code:"af",name:"Afrikaans"},{code:"sq",name:"Albanian"},{code:"am",name:"Amharic"},{code:"ar",name:"Arabic"},{code:"hy",name:"Armenian"},{code:"az",name:"Azerbaijani"},{code:"bn",name:"Bangla"},{code:"bs",name:"Bosnian"},{code:"bg",name:"Bulgarian"},{code:"ca",name:"Catalan"},{code:"zh-Hans",name:"Chinese (Simplified)"},{code:"zh-Hant",name:"Chinese (Traditional)"},{code:"hr",name:"Croatian"},{code:"cs",name:"Czech"},{code:"da",name:"Danish"},{code:"nl",name:"Dutch"},{code:"en",name:"English"},{code:"et",name:"Estonian"},{code:"fi",name:"Finnish"},{code:"fr",name:"French"},{code:"de",name:"German"},{code:"el",name:"Greek"},{code:"gu",name:"Gujarati"},{code:"ht",name:"Haitian Creole"},{code:"he",name:"Hebrew"},{code:"hi",name:"Hindi"},{code:"mww",name:"Hmong Daw"},{code:"hu",name:"Hungarian"},{code:"is",name:"Icelandic"},{code:"id",name:"Indonesian"},{code:"ga",name:"Irish"},{code:"it",name:"Italian"},{code:"ja",name:"Japanese"},{code:"kn",name:"Kannada"},{code:"kk",name:"Kazakh"},{code:"km",name:"Khmer"},{code:"ko",name:"Korean"},{code:"lo",name:"Lao"},{code:"lv",name:"Latvian"},{code:"lt",name:"Lithuanian"},{code:"ms",name:"Malay"},{code:"ml",name:"Malayalam"},{code:"mt",name:"Maltese"},{code:"mr",name:"Marathi"},{code:"my",name:"Myanmar (Burmese)"},{code:"ne",name:"Nepali"},{code:"nb",name:"Norwegian"},{code:"ps",name:"Pashto"},{code:"fa",name:"Persian"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"pa",name:"Punjabi"},{code:"ro",name:"Romanian"},{code:"ru",name:"Russian"},{code:"sm",name:"Samoan"},{code:"sr-Cyrl",name:"Serbian (Cyrillic)"},{code:"sr-Latn",name:"Serbian (Latin)"},{code:"sk",name:"Slovak"},{code:"sl",name:"Slovenian"},{code:"es",name:"Spanish"},{code:"sw",name:"Swahili"},{code:"sv",name:"Swedish"},{code:"ta",name:"Tamil"},{code:"te",name:"Telugu"},{code:"th",name:"Thai"},{code:"tr",name:"Turkish"},{code:"uk",name:"Ukrainian"},{code:"ur",name:"Urdu"},{code:"uz",name:"Uzbek"},{code:"vi",name:"Vietnamese"},{code:"cy",name:"Welsh"}];let s={activeTab:"general",scope:"global",isFloating:!1,restartRequired:!1};const l=[{id:"general",label:"General",icon:"âš™ï¸"},{id:"image",label:"Image Processing",icon:"ðŸ–¼ï¸"},{id:"text",label:"Text Cleaning",icon:"ðŸ“"},{id:"translation",label:"Translation",icon:"ðŸŒ"},{id:"rules",label:"Find & Replace",icon:"ðŸ”"},{id:"ui",label:"Interface",icon:"ðŸ–¥ï¸"},{id:"data",label:"Data",icon:"ðŸ’¾"}];async function c(){if(document.getElementById("ocr-settings-panel"))return;s.isFloating=!0,s.activeTab="general";try{window.location.origin&&"null"!==window.location.origin&&(s.scope=`site:${window.location.origin}`)}catch(e){s.scope="global"}const e=document.createElement("div");e.id="ocr-settings-backdrop",Object.assign(e.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",backgroundColor:"rgba(0,0,0,0.5)",zIndex:"2147483646",opacity:"0",transition:"opacity 0.2s ease",backdropFilter:"blur(2px)"});const t=document.createElement("aside");t.id="ocr-settings-panel",Object.assign(t.style,{position:"fixed",top:"0",right:"0",height:"100vh",width:"min(500px, 90vw)",backgroundColor:"#111827",color:"#f9fafb",boxShadow:"-5px 0 25px rgba(0,0,0,0.5)",zIndex:"2147483647",transform:"translateX(100%)",transition:"transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)",display:"flex",flexDirection:"column",fontFamily:"'Segoe UI', Inter, sans-serif"}),t.addEventListener("keydown",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown","Space"].includes(e.code)&&e.stopPropagation()});const n=()=>{t.style.transform="translateX(100%)",e.style.opacity="0",setTimeout(()=>{t.remove(),e.remove(),s.restartRequired&&confirm("Some settings require a page refresh to take effect. Refresh now?")&&location.reload()},300)};e.onclick=n;const a=document.createElement("div");Object.assign(a.style,{padding:"20px 20px 10px 20px",flexShrink:"0"});const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.style.marginBottom="15px";const i=document.createElement("h2");i.textContent="Settings",Object.assign(i.style,{margin:0,fontSize:"20px",fontWeight:"600"});const c=document.createElement("button");c.innerHTML="âœ•",Object.assign(c.style,{background:"transparent",border:"none",color:"#9ca3af",fontSize:"20px",cursor:"pointer",padding:"5px"}),c.onclick=n,r.appendChild(i),r.appendChild(c),a.appendChild(r);const p=document.createElement("div");Object.assign(p.style,{display:"flex",gap:"5px",overflowX:"auto",paddingBottom:"5px",borderBottom:"1px solid #374151"});const u=document.createElement("div");Object.assign(u.style,{flex:"1",overflowY:"auto",padding:"20px"});const g=async()=>{p.innerHTML="",await(0,o.mt)(["floating_visible_preprocess","floating_visible_cleaning","floating_visible_findreplace","floating_visible_ui","floating_visible_profiles"]),l.forEach(e=>{if("data"===e.id)return;const t=document.createElement("button"),n=s.activeTab===e.id;t.textContent=e.label,Object.assign(t.style,{padding:"8px 12px",borderRadius:"6px",border:"none",background:n?"#374151":"transparent",color:n?"#fff":"#9ca3af",cursor:"pointer",fontSize:"13px",whiteSpace:"nowrap",transition:"all 0.2s"}),t.onclick=()=>{s.activeTab=e.id,g()},p.appendChild(t)}),await d(u)};a.appendChild(p),t.appendChild(a),t.appendChild(u),document.body.appendChild(e),document.body.appendChild(t),requestAnimationFrame(()=>{e.style.opacity="1",t.style.transform="translateX(0)"}),await g()}async function d(e){if(e.innerHTML="",e.scrollTop=0,!["data","general"].includes(s.activeTab)){const t=document.createElement("div");Object.assign(t.style,{marginBottom:"20px",paddingBottom:"15px",borderBottom:"1px solid #374151"}),await async function(e,t){const n=["global"];s.scope.startsWith("site:")&&!n.includes(s.scope)&&n.push(s.scope);const a=document.createElement("div");Object.assign(a.style,{display:"flex",alignItems:"center",justifyContent:"space-between"});const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.gap="10px";const r=document.createElement("span");r.textContent="Configuring Scope:",r.style.fontSize="12px",r.style.color="#9ca3af";const i=document.createElement("select");Object.assign(i.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",width:"auto",padding:"6px 12px"}),n.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent="global"===e?"Global Defaults":"This Site Only ("+e.replace("site:","")+")",i.appendChild(t)}),i.value=s.scope,i.onchange=()=>{s.scope=i.value,t()},o.appendChild(r),o.appendChild(i);const l=document.createElement("div");if("global"===s.scope&&window.location.origin){const e=f("+ Add Site Scope",()=>{const e=`site:${window.location.origin}`;s.scope=e,t()});l.appendChild(e)}else if("global"!==s.scope){const e=f("Delete Scope",async()=>{confirm("Delete all rules for this site?")&&(await b(s.scope,[]),await w(s.scope,[]),s.scope="global",t())},"danger");l.appendChild(e)}a.appendChild(o),a.appendChild(l),e.appendChild(a)}(t,()=>d(e)),e.appendChild(t)}const t=s.scope;switch(s.activeTab){case"general":await async function(e){u(e,"Profile Management");const t=document.createElement("div");await p(t),e.appendChild(t)}(e);break;case"image":await async function(e){u(e,"Preprocessing Pipeline");const t=await(0,o.mt)(["preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","tess_lang"]),n=g("OCR Language","Language model to use for recognition."),a=document.createElement("select");if(Object.assign(a.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),r.forEach(e=>{const t=document.createElement("option");t.value=e.code,t.textContent=`${e.name} (${e.code})`,a.appendChild(t)}),!r.some(e=>e.code===t.tess_lang)){const e=document.createElement("option");e.value=t.tess_lang,e.textContent=t.tess_lang,a.appendChild(e)}a.value=t.tess_lang||"eng",a.onchange=async()=>await(0,o.saveSettings)({tess_lang:a.value}),n.appendChild(a),e.appendChild(n),e.appendChild(h("Resize 2x","Upscale image for better accuracy",!1!==t.preprocess_resize,e=>(0,o.saveSettings)({preprocess_resize:e}))),e.appendChild(h("Grayscale","Convert to B&W",!1!==t.preprocess_grayscale,e=>(0,o.saveSettings)({preprocess_grayscale:e}))),e.appendChild(h("Contrast","Enhance text contrast",!1!==t.preprocess_contrast,e=>(0,o.saveSettings)({preprocess_contrast:e}))),e.appendChild(h("Median Blur","Reduce noise (Slower)",!0===t.preprocess_blur,e=>(0,o.saveSettings)({preprocess_blur:e}))),e.appendChild(h("Adaptive Threshold","Binarize image (Good for bad lighting)",!0===t.preprocess_threshold,e=>(0,o.saveSettings)({preprocess_threshold:e})))}(e);break;case"text":await async function(e){u(e,"Text Cleaning");const t=await(0,o.mt)(["clean_noise","noise_aggression","clean_normalize","clean_dict","dict_strength","dict_ignore_caps","manhwa_mode","reconstruct_text","reconstruct_merge","reconstruct_stabilize"]);e.appendChild(h("Noise Cleaning","Remove non-text artifacts",!1!==t.clean_noise,e=>(0,o.saveSettings)({clean_noise:e})));const n=g("Noise Aggression","How aggressively to remove small dots."),a=document.createElement("select");Object.assign(a.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),["low","medium","high"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e.charAt(0).toUpperCase()+e.slice(1),a.appendChild(t)}),a.value=t.noise_aggression||"medium",a.onchange=async()=>(0,o.saveSettings)({noise_aggression:a.value}),n.appendChild(a),e.appendChild(n),e.appendChild(h("Normalize Whitespace","Fix spacing and line breaks",!1!==t.clean_normalize,e=>(0,o.saveSettings)({clean_normalize:e}))),e.appendChild(y()),e.appendChild(h("Dictionary Correction","Fix spelling using vocabulary",!0===t.clean_dict,e=>(0,o.saveSettings)({clean_dict:e}))),e.appendChild(h("Ignore ALL CAPS","Skip dictionary for UPPERCASE words",!1!==t.dict_ignore_caps,e=>(0,o.saveSettings)({dict_ignore_caps:e}))),e.appendChild(y()),u(e,"Reconstruction"),e.appendChild(h("Enable Reconstruction","Rebuild sentences from lines",!1!==t.reconstruct_text,e=>(0,o.saveSettings)({reconstruct_text:e}))),e.appendChild(h("Broken Line Merge","Join lines split by hyphens",!1!==t.reconstruct_merge,e=>(0,o.saveSettings)({reconstruct_merge:e}))),e.appendChild(h("Manhwa Mode","Optimize for vertical text bubbles",!0===t.manhwa_mode,e=>(0,o.saveSettings)({manhwa_mode:e})))}(e);break;case"translation":await async function(e){u(e,"Translation Settings");const t=await(0,o.mt)(["trans_src","trans_target","trans_auto","trans_style"]),n=g("Source Language","Language of the text in image."),a=document.createElement("select");Object.assign(a.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"});const r=document.createElement("option");r.value="auto",r.textContent="Detect Language (Auto)",a.appendChild(r),i.forEach(e=>{const t=document.createElement("option");t.value=e.code,t.textContent=e.name,a.appendChild(t)}),a.value=t.trans_src||"auto",a.onchange=async()=>await(0,o.saveSettings)({trans_src:a.value}),n.appendChild(a),e.appendChild(n),e.appendChild(h("Auto-Detect Source","Always try to detect source language first",!1!==t.trans_auto,e=>(0,o.saveSettings)({trans_auto:e})));const s=g("Target Language","Language to translate into."),l=document.createElement("select");Object.assign(l.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),i.forEach(e=>{const t=document.createElement("option");t.value=e.code,t.textContent=e.name,l.appendChild(t)}),l.value=t.trans_target||"en",l.onchange=async()=>await(0,o.saveSettings)({trans_target:l.value}),s.appendChild(l),e.appendChild(s),e.appendChild(y());const c=g("Display Style","How translation results are shown."),d=document.createElement("select");Object.assign(d.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),[{v:"replace",t:"Replace Original Text"},{v:"below",t:"Show Below Original"},{v:"side",t:"Show Side-by-Side (Tooltip)"}].forEach(e=>{const t=document.createElement("option");t.value=e.v,t.textContent=e.t,d.appendChild(t)}),d.value=t.trans_style||"replace",d.onchange=async()=>await(0,o.saveSettings)({trans_style:d.value}),c.appendChild(d),e.appendChild(c)}(e);break;case"rules":await async function(e,t){const n=await(0,o.A7)(t);u(e,"Find & Replace Rules"),await async function(e,t,n){const a=document.createElement("div");Object.assign(a.style,{display:"flex",flexDirection:"column",gap:"8px",marginBottom:"15px"});const o=document.createElement("div");o.style.display="flex",o.style.gap="10px",o.style.marginBottom="15px";const r=document.createElement("input");r.placeholder="Find",Object.assign(r.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",flex:"1"});const i=document.createElement("input");i.placeholder="Replace",Object.assign(i.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",flex:"1"});const s=document.createElement("button");s.textContent="Add",Object.assign(s.style,{background:"#4f46e5",color:"white",border:"none",borderRadius:"6px",padding:"0 15px",cursor:"pointer"});const l=document.createElement("div");l.style.display="flex",l.style.gap="15px",l.style.marginBottom="10px",l.style.fontSize="13px";const c=m("Regex"),d=m("Match Case"),p=m("Whole Word");l.appendChild(c),l.appendChild(d),l.appendChild(p),s.onclick=async()=>{r.value&&(t.push({find:r.value,replace:i.value,isRegex:c.querySelector("input").checked,caseSensitive:d.querySelector("input").checked,wholeWord:p.querySelector("input").checked,enabled:!0}),await w(n,t),u(),r.value="",i.value="")},o.appendChild(r),o.appendChild(i),o.appendChild(s),e.appendChild(o),e.appendChild(l);const u=()=>{a.innerHTML="",t.forEach((e,o)=>{const r=document.createElement("div");Object.assign(r.style,{display:"flex",alignItems:"center",background:"#111827",padding:"8px 12px",borderRadius:"6px",gap:"10px"});const i=document.createElement("div");i.innerHTML=`<span style="color:#d1d5db">${e.find}</span> <span style="color:#6b7280">âžž</span> <span style="color:#93c5fd">${e.replace}</span>`,Object.assign(i.style,{flex:"1",fontSize:"14px",fontFamily:"monospace"}),e.enabled||(i.style.opacity="0.5");const s=document.createElement("button");s.textContent="âœ•",Object.assign(s.style,{background:"transparent",border:"none",color:"#ef4444",cursor:"pointer"}),s.onclick=async()=>{t.splice(o,1),await w(n,t),u()},r.appendChild(i),r.appendChild(s),a.appendChild(r)})};u(),e.appendChild(a)}(e,n.replacements,t),u(e,"Character Deletion",!0),await async function(e,t,n){const a=document.createElement("div"),o=document.createElement("input");o.placeholder="Add char...",Object.assign(o.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",width:"120px",fontSize:"13px"}),o.onkeydown=async e=>{"Enter"===e.key&&o.value&&(t.push({char:o.value}),await b(n,t),o.value="",i())};const r=document.createElement("div");Object.assign(r.style,{display:"flex",flexWrap:"wrap",gap:"8px",marginTop:"10px"});const i=()=>{r.innerHTML="",t.forEach((e,a)=>{const o="string"==typeof e?e:e.char,s=document.createElement("div");Object.assign(s.style,{background:"#374151",padding:"4px 8px",borderRadius:"4px",fontSize:"13px",display:"flex",alignItems:"center",gap:"6px"}),s.innerHTML=`<span>${o}</span>`;const l=document.createElement("span");l.textContent="Ã—",l.style.cursor="pointer",l.style.color="#ef4444",l.onclick=async()=>{t.splice(a,1),await b(n,t),i()},s.appendChild(l),r.appendChild(s)})};i(),a.appendChild(o),a.appendChild(r),e.appendChild(a)}(e,n.deletions,t)}(e,t);break;case"ui":await async function(e){const t=await(0,o.mt)(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist","popup_hidden_buttons","debug_mode","floating_visible_preprocess","floating_visible_cleaning","floating_visible_findreplace","floating_visible_profiles","floating_visible_ui","floating_visible_translation"]);u(e,"Floating Button"),e.appendChild(h("Show Floating Button","Enable the OCR button on pages",!1!==t.floating_button_enabled,async e=>{await(0,o.saveSettings)({floating_button_enabled:e}),s.restartRequired=!0}));const n=g("Filter Rules","Where should the button appear?"),a=document.createElement("select");Object.assign(a.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),a.innerHTML='<option value="blacklist">Show Everywhere (Except...)</option><option value="whitelist">Hide Everywhere (Except...)</option>',a.value=t.floating_button_mode||"blacklist";const r=document.createElement("textarea");Object.assign(r.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",height:"100px",marginTop:"10px",fontFamily:"monospace"});const i=()=>{const e="whitelist"===t.floating_button_mode?t.floating_button_whitelist||[]:t.floating_button_blacklist||[];r.value=e.join("\n")};i(),a.onchange=async()=>{await(0,o.saveSettings)({floating_button_mode:a.value}),t.floating_button_mode=a.value,i()},r.onchange=async()=>{const e="whitelist"===t.floating_button_mode?"floating_button_whitelist":"floating_button_blacklist",n=r.value.split("\n").map(e=>e.trim()).filter(Boolean);await(0,o.saveSettings)({[e]:n}),t[e]=n},n.appendChild(a),n.appendChild(r),e.appendChild(n),u(e,"Popup Configuration",!0);const l=document.createElement("div");l.style.display="grid",l.style.gridTemplateColumns="repeat(auto-fill, minmax(140px, 1fr))",l.style.gap="10px";const c=t.popup_hidden_buttons||[];["Lowercase","Uppercase","Single Line","Manhwa Mode","Copy","Translate"].forEach(e=>{const t=!c.includes(e),n=m(e,t,async t=>{let n=await(0,o.mt)(["popup_hidden_buttons"]).then(e=>e.popup_hidden_buttons||[]);t?n=n.filter(t=>t!==e):n.includes(e)||n.push(e),await(0,o.saveSettings)({popup_hidden_buttons:n})});l.appendChild(n)}),e.appendChild(l),u(e,"System",!0),e.appendChild(h("Debug Mode","Log detailed info to console",!0===t.debug_mode,e=>(0,o.saveSettings)({debug_mode:e}))),s.isFloating||(u(e,"Floating Settings Panel",!0),[{k:"floating_visible_profiles",l:"Show Profiles Tab"},{k:"floating_visible_preprocess",l:"Show Image Tab"},{k:"floating_visible_cleaning",l:"Show Text Tab"},{k:"floating_visible_translation",l:"Show Translation Tab"},{k:"floating_visible_findreplace",l:"Show Rules Tab"},{k:"floating_visible_ui",l:"Show UI Tab"}].forEach(n=>{const a=!1!==t[n.k];e.appendChild(h(n.l,"",a,e=>(0,o.saveSettings)({[n.k]:e})))}))}(e);break;case"data":await async function(e){u(e,"Data Management");const t=document.createElement("p");t.textContent="Import/Export your configuration and profiles.",t.style.color="#9ca3af",t.style.fontSize="14px",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",n.style.gap="10px",n.style.marginTop="20px";const a={padding:"10px 16px",borderRadius:"6px",border:"none",cursor:"pointer",fontWeight:"500"},r=document.createElement("button");r.textContent="Import JSON",Object.assign(r.style,{...a,background:"#374151",color:"white"});const i=document.createElement("button");i.textContent="Export JSON",Object.assign(i.style,{...a,background:"#4f46e5",color:"white"});const s=document.createElement("button");s.textContent="Factory Reset",Object.assign(s.style,{...a,background:"rgba(239, 68, 68, 0.2)",color:"#ef4444"}),i.onclick=()=>{(0,o.uX)("full").then(e=>{const t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="ocr-settings.json",a.click()})},r.onclick=()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files[0];t&&confirm("Import settings? Previous data will be overwritten.")&&(await(0,o.Df)(await t.text(),"merge"),location.reload())},e.click()},s.onclick=()=>{confirm("DANGER: This will delete ALL profiles and settings. Continue?")&&(0,o.vv)("full").then(()=>location.reload())},n.appendChild(r),n.appendChild(i),n.appendChild(s),e.appendChild(n)}(e)}}async function p(e){const t=await(0,o.mt)(["active_profile_id"]),n=await(0,o.e6)(),a=t.active_profile_id,r=document.createElement("div");Object.assign(r.style,{display:"flex",flexDirection:"column",gap:"8px",marginBottom:"15px"}),n.forEach(t=>{const n=document.createElement("div"),i=t.id===a;Object.assign(n.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px",background:i?"rgba(79, 70, 229, 0.1)":"#111827",border:i?"1px solid #4f46e5":"1px solid transparent",borderRadius:"8px"});const s=document.createElement("span");s.textContent=t.name,i&&(s.style.fontWeight="bold"),i&&(s.style.color="#818cf8");const l=document.createElement("div");if(l.style.display="flex",l.style.gap="8px",!i){const n=f("Load",async()=>{await(0,o.kS)(t.id),p(e)});l.appendChild(n)}if(!["default","manhwa"].includes(t.id)){const n=f("Rename",async()=>{const n=prompt("Rename:",t.name);n&&(await(0,o.gn)(t.id,n),p(e))}),a=f("Delete",async()=>{confirm(`Delete ${t.name}?`)&&(await(0,o.lp)(t.id),p(e))},"danger");l.appendChild(n),l.appendChild(a)}n.appendChild(s),n.appendChild(l),r.appendChild(n)});const i=document.createElement("button");i.textContent="+ Create New Profil",Object.assign(i.style,{width:"100%",padding:"10px",background:"#374151",color:"#9ca3af",border:"2px dashed #4b5563",borderRadius:"8px",cursor:"pointer"}),i.onclick=async()=>{const t=prompt("Profile Name:");t&&(await(0,o.SH)(t),p(e))},e.innerHTML="",e.appendChild(r),e.appendChild(i)}function u(e,t,n=!1){const a=document.createElement(n?"h4":"h3");a.textContent=t,Object.assign(a.style,{margin:n?"20px 0 10px 0":"0 0 20px 0",fontSize:n?"16px":"22px",color:"#f3f4f6",fontWeight:"600"}),e.appendChild(a)}function g(e,t){const n=document.createElement("div");Object.assign(n.style,{marginBottom:"15px"});const a=document.createElement("label");a.textContent=e,Object.assign(a.style,{display:"block",fontSize:"14px",fontWeight:"500",marginBottom:"4px"});const o=document.createElement("div");return o.textContent=t,Object.assign(o.style,{fontSize:"12px",color:"#9ca3af",marginBottom:"8px"}),n.appendChild(a),n.appendChild(o),n}function h(e,t,n,a){const o=document.createElement("div");Object.assign(o.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px",background:"#111827",borderRadius:"8px",marginBottom:"10px"});const r=document.createElement("div"),i=document.createElement("div");i.textContent=e,i.style.fontSize="14px",i.style.fontWeight="500";const s=document.createElement("div");s.textContent=t,s.style.fontSize="12px",s.style.color="#9ca3af",r.appendChild(i),t&&r.appendChild(s);const l=document.createElement("div");Object.assign(l.style,{width:"44px",height:"24px",borderRadius:"12px",background:n?"#4f46e5":"#374151",position:"relative",cursor:"pointer",transition:"background 0.2s"});const c=document.createElement("div");return Object.assign(c.style,{width:"18px",height:"18px",borderRadius:"50%",background:"white",position:"absolute",top:"3px",left:n?"23px":"3px",transition:"left 0.2s"}),l.appendChild(c),l.onclick=()=>{const e=!n;a(e),l.style.background=e?"#4f46e5":"#374151",c.style.left=e?"23px":"3px",n=e},o.appendChild(r),o.appendChild(l),o}function m(e,t=!1,n=null){const a=document.createElement("label");Object.assign(a.style,{display:"flex",gap:"8px",alignItems:"center",cursor:"pointer",fontSize:"13px"});const o=document.createElement("input");return o.type="checkbox",o.checked=t,n&&(o.onchange=e=>n(e.target.checked)),a.appendChild(o),a.appendChild(document.createTextNode(e)),a}function f(e,t,n="normal"){const a=document.createElement("button");return a.textContent=e,Object.assign(a.style,{padding:"4px 8px",fontSize:"11px",borderRadius:"4px",border:"none",cursor:"pointer",background:"danger"===n?"rgba(239, 68, 68, 0.2)":"#374151",color:"danger"===n?"#ef4444":"#e5e7eb"}),a.onclick=t,a}function y(){const e=document.createElement("div");return e.style.borderTop="1px solid #374151",e.style.margin="15px 0",e}async function b(e,t){const n="global"===e?"user_deletions":`user_deletions_${e}`;"global"===e?await(0,o.saveSettings)({user_deletions:t}):await browser.storage.local.set({[n]:t})}async function w(e,t){const n="global"===e?"user_replacements":`user_replacements_${e}`;"global"===e?await(0,o.saveSettings)({user_replacements:t}):await browser.storage.local.set({[n]:t})}function x(){const e=function(e,t="32px",n="32px",a=null){const o=document.createElement("button");return o.textContent=e,o.style.width=t,o.style.height=n,o.style.padding="4px",o.style.backgroundColor="#374151",o.style.color="#9ca3af",o.style.border="1px solid #4b5563",o.style.borderRadius="6px",o.style.cursor="pointer",o.style.fontSize="16px",o.style.fontFamily="Inter, sans-serif",o.style.transition="all 0.2s ease",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.addEventListener("mouseenter",()=>{o.style.backgroundColor="#4b5563",o.style.transform="translateY(-1px)",o.style.boxShadow="0 4px 6px rgba(0,0,0,0.1)"}),o.addEventListener("mouseleave",()=>{o.style.backgroundColor="#374151",o.style.transform="translateY(0)",o.style.boxShadow="none"}),o.addEventListener("mousedown",()=>{o.style.transform="translateY(1px) scale(0.98)"}),o.addEventListener("mouseup",()=>{o.style.transform="translateY(-1px)"}),a&&o.addEventListener("click",a),o}("âš™","32px","32px");return e.title="Settings",e.addEventListener("click",()=>{try{return void c()}catch(e){}try{if("undefined"!=typeof chrome&&chrome.tabs&&"function"==typeof chrome.tabs.create)return void chrome.tabs.create({url:chrome.runtime.getURL("settings.html"),active:!0})}catch(e){}window.dispatchEvent(new CustomEvent("ocr:openSettings"))}),e}function v(){if(document.getElementById("ocr-settings-fab"))return document.getElementById("ocr-settings-fab");const e=x();return e.id="ocr-settings-fab",e.style.position="fixed",e.style.left="12px",e.style.bottom="12px",e.style.zIndex="1000002",e.style.boxShadow="0 8px 24px rgba(0,0,0,0.3)",e.style.borderRadius="8px",document.body.appendChild(e),e}function _(e,r){console.log("Showing popup with state:",e,"text:",r),document.querySelectorAll('div[style*="position: fixed"][style*="bottom: 10px"][style*="right: 10px"]').forEach(e=>{document.body.contains(e)&&document.body.removeChild(e)});const i=document.createElement("div");i.style.position="fixed",i.style.bottom="10px",i.style.right="10px",i.style.width="min(450px, 90vw)",i.style.backgroundColor="#1f2937",i.style.color="#f9fafb",i.style.border="1px solid #374151",i.style.borderRadius="12px",i.style.boxShadow="0 10px 25px rgba(0,0,0,0.3)",i.style.zIndex="1000000",i.style.fontFamily="Inter, sans-serif",i.style.padding="20px",i.style.maxHeight="min(500px, 80vh)",i.style.overflowY="auto";const s=document.createElement("div");s.className="progress-container",s.style.marginBottom="20px";const l=document.createElement("div");l.style.display="flex",l.style.alignItems="center";const c=document.createElement("label");c.textContent="Recognizing",c.style.width="100px",c.style.fontSize="14px",c.style.color="#9ca3af",l.appendChild(c);const d=document.createElement("div");d.style.flex="1",d.style.height="8px",d.style.backgroundColor="#374151",d.style.borderRadius="4px",d.style.overflow="hidden";const p=document.createElement("div");p.style.height="100%",p.style.backgroundColor="#4f46e5",p.style.width="0%",d.appendChild(p),l.appendChild(d),s.appendChild(l),i.appendChild(s);const u=document.createElement("div");u.style.position="relative",u.style.marginBottom="18px";const g=document.createElement("textarea");g.value=r,g.style.width="100%",g.style.height="120px",g.style.padding="12px",g.style.backgroundColor="#374151",g.style.color="#f9fafb",g.style.border="1px solid #4b5563",g.style.borderRadius="8px",g.style.resize="vertical",g.style.fontFamily="Inter, sans-serif",g.style.minHeight="32px",g.style.maxHeight="200px",g.addEventListener("keydown",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","PageUp","PageDown"].includes(e.code)&&e.stopPropagation()}),u.appendChild(g);const h=document.createElement("div");h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center",h.style.marginBottom="8px";const m=document.createElement("select"),f={English:"eng",Turkish:"tur",Korean:"kor",Chinese:"chi_sim",Japanese:"jpn",Spanish:"spa",French:"fra",German:"deu",Italian:"ita",Portuguese:"por",Russian:"rus",Arabic:"ara"};Object.keys(f).forEach(e=>{const t=document.createElement("option");t.value=f[e],t.textContent=e,m.appendChild(t)}),Object.assign(m.style,{background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",padding:"6px",fontSize:"12px"}),(0,o.mt)(["tess_lang"]).then(e=>{e.tess_lang&&(m.value=e.tess_lang)}),m.addEventListener("change",async()=>{const{saveSettings:e}=await Promise.resolve().then(n.bind(n,651));if(await e({tess_lang:m.value}),i._ocrData){const{performOCR:e}=await Promise.resolve().then(n.bind(n,432)),{img:t,selections:a,dpr:o}=i._ocrData;g.disabled=!0,g.value="Re-analyzing with new language...";try{let n="",r="";for(const i of a){const a=Math.round(i.x*o),s=Math.round(i.y*o),l=Math.round(i.width*o),c=Math.round(i.height*o);if(a+l>t.width||s+c>t.height)continue;const d=document.createElement("canvas");d.width=l,d.height=c,d.getContext("2d").drawImage(t,a,s,l,c,0,0,d.width,d.height);const{text:p,originalText:u}=await e(d);n&&(n+="\n\n"),n+=p,r&&(r+="\n\n"),r+=u}g.value=n,g.disabled=!1}catch(e){console.error("Re-OCR failed:",e),g.value="Error re-analyzing: "+e.message,g.disabled=!1}}});const y=x();Object.assign(y.style,{width:"34px",height:"34px",padding:"6px",borderRadius:"6px",background:"#374151"}),y.title="Settings",h.appendChild(m),h.appendChild(y),u.appendChild(h),u.appendChild(g),i.appendChild(u);const b=document.createElement("div");b.className="popup-footer",b.style.display="flex",b.style.justifyContent="center",b.style.alignItems="center",b.style.gap="0",b.style.padding="0",b.style.margin="0",b.style.width="100%";const w=document.createElement("div");w.style.display="flex",w.style.justifyContent="center",w.style.gap="8px",w.style.flexWrap="wrap",w.style.margin="0",w.style.padding="0",w.style.width="100%",w.style.boxSizing="border-box";const v=function(e){return t("Lower Case","120px","32px",()=>{const t=a(e.value);e.value=t.toLowerCase()})}(g);w.appendChild(v);const _=function(e){return t("Upper Case","120px","32px",()=>{e.value=e.value.toUpperCase()})}(g);w.appendChild(_);const E=function(e){return t("Single Line","120px","32px",()=>{const t=a(e.value);e.value=t.replace(/\n/g," ")})}(g);w.appendChild(E);const S=function(e){return t("Manhwa Mode","120px","32px",()=>{let t=e.value||"",n=[];try{window.manhwaDeleteChars&&Array.isArray(window.manhwaDeleteChars)&&(n=window.manhwaDeleteChars.slice())}catch(e){}if(0===n.length){const e=localStorage.getItem("charsToDelete")||"";try{const t=JSON.parse(e);n=Array.isArray(t)?t.slice():(e||"").split("")}catch{n=(e||"").split("")}}n.forEach(e=>{e&&(t=t.split(e).join(""))});let a=[];try{window.manhwaRules&&Array.isArray(window.manhwaRules)&&(a=window.manhwaRules.map(e=>({find:e.find+"",replace:e.replace+""})))}catch(e){}if(0===a.length){try{const e=window.location&&window.location.origin?window.location.origin:null;if(e){const t="manhwa_rules::"+encodeURIComponent("site:"+e),n=localStorage.getItem(t);if(n){const e=JSON.parse(n);Array.isArray(e)&&(a=e.map(e=>({find:String(e.find||""),replace:String(e.replace||"")})))}}}catch(e){}if(0===a.length){const e=localStorage.getItem("replacementsText")||"";try{const t=JSON.parse(e);if(Array.isArray(t))a=t.map(e=>({find:String(e.find||""),replace:String(e.replace||"")}));else{const t=String(e||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),n=[];t.forEach(e=>{const t=e.indexOf("â†’")>=0?"â†’":e.indexOf("=>")>=0?"=>":null;if(t){const a=e.split(t);n.push({find:a[0],replace:a.slice(1).join(t)})}}),a=n}}catch(t){const n=String(e||"").split(/\r?\n/).map(e=>e.trim()).filter(Boolean),o=[];n.forEach(e=>{const t=e.indexOf("â†’")>=0?"â†’":e.indexOf("=>")>=0?"=>":null;if(t){const n=e.split(t);o.push({find:n[0],replace:n.slice(1).join(t)})}}),a=o}}}a.forEach(e=>{if(e&&e.find)try{const n=`(?<!\\w)${e.find.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(?!\\w)`,a=new RegExp(n,"gi");t=t.replace(a,e.replace||"")}catch(n){try{t=t.split(e.find).join(e.replace||"")}catch(e){}}}),e.value=t.replace(/\n/g," ").toLowerCase()})}(g);w.appendChild(S);const k=function(e,n){const a=t("Copy","120px","32px");return a.handler=async()=>(await n(e.value),!0),a.addEventListener("click",function(e){return async()=>{await e.handler()&&(e.textContent="Copied!",setTimeout(()=>e.textContent="Copy",2e3))}}(a)),a}(g,C);w.appendChild(k);const L=function(e){const n=t("Translate","120px","32px");return n.handler=async()=>{const t=e.value;if(!t.trim())return!1;const n=await(0,o.mt)(["trans_src","trans_target","trans_style","trans_auto"]),a=n.trans_auto||"auto"===n.trans_src?null:n.trans_src,r=n.trans_target||"en";n.trans_style;try{console.log("[Content] Sending translation request to background...");const n=await browser.runtime.sendMessage({action:"translate",text:t,from:a,to:r});if(console.log("[Content] Received response from background:",n),!n)throw new Error("No response from background script");if(n.error)throw new Error(n.error+(n.details?": "+n.details:""));if(!n.translatedText)throw new Error("No translation text in response");const o=n.translatedText;return e.value=o,!0}catch(e){return console.error("Translation error:",e),alert("Translation failed: "+e.message),!1}},n.addEventListener("click",async()=>{n.disabled=!0,n.textContent="...";try{const e=await n.handler();n.textContent=e?"Done!":"Failed"}catch(e){n.textContent="Error"}finally{setTimeout(()=>{n.textContent="Translate",n.disabled=!1},1500)}}),n}(g);w.appendChild(L),(0,o.mt)(["popup_hidden_buttons"]).then(e=>{const t=e.popup_hidden_buttons||[];t.includes("Lowercase")&&(v.style.display="none"),t.includes("Uppercase")&&(_.style.display="none"),t.includes("Single Line")&&(E.style.display="none"),t.includes("Manhwa Mode")&&(S.style.display="none"),t.includes("Copy")&&(k.style.display="none"),t.includes("Translate")&&(L.style.display="none")});const I=function(e){return function(e,n="110px",a="32px",o=null){const r=t("Close",n,a,o);return r.style.backgroundColor="#4f46e5",r.style.border="none",r.style.color="#ffffff",r.dataset.origBg=r.style.backgroundColor,r}(0,"120px","32px",()=>{document.body.removeChild(e)})}(i);function A(e){const t=`copy_${e.replace(/\s+/g,"_").toLowerCase()}`,n=document.getElementById(t);if(n)return!!n.checked;try{return!!JSON.parse(localStorage.getItem("copyConfig")||"{}")[t]}catch(e){return!1}}function O(){const e=document.createElement("div");e.textContent="Copied!",Object.assign(e.style,{position:"absolute",bottom:"100%",left:"50%",transform:"translateX(-50%)",background:"#0b1220",color:"#e6eef8",padding:"6px 10px",borderRadius:"6px",border:"1px solid #25303a",zIndex:1000002,opacity:"0",transition:"opacity 160ms ease"}),i.appendChild(e),requestAnimationFrame(()=>e.style.opacity="1"),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>e.remove(),220)},900)}return w.appendChild(I),v.addEventListener("click",async()=>{A("Lowercase")&&await C(g.value)&&O()}),_.addEventListener("click",async()=>{A("Uppercase")&&await C(g.value)&&O()}),E.addEventListener("click",async()=>{A("Single Line")&&await C(g.value)&&O()}),S.addEventListener("click",async()=>{A("Manhwa Mode")&&await C(g.value)&&O()}),L.addEventListener("click",async()=>{A("Translate")&&await C(g.value)&&O()}),b.appendChild(w),i.appendChild(b),"processing"===e?(s.style.display="block",g.style.display="none",b.style.display="none",i.intervalId=setInterval(()=>{let e=parseFloat(p.style.width)||0;e+=10,e>90&&(e=90),p.style.width=e+"%"},300)):(s.style.display="none",g.style.display="block",b.style.display="flex"),document.body.appendChild(i),i}async function C(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0}catch(e){console.warn("Modern clipboard API failed, falling back to execCommand")}try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();const n=document.execCommand("copy");return document.body.removeChild(t),n}catch(e){return console.error("Clipboard copy failed:",e),!1}}let E=null,S=null;function k(e,t=[]){if(S&&E&&(S.clearRect(0,0,E.width,E.height),S.fillStyle="rgba(0, 0, 0, 0.35)",S.fillRect(0,0,E.width,E.height),t.forEach(e=>{S.clearRect(e.x,e.y,e.width,e.height),S.strokeStyle="#3b82f6",S.lineWidth=2,S.strokeRect(e.x,e.y,e.width,e.height)}),e)){const{x:t,y:n,width:a,height:o}=e;S.clearRect(t,n,a,o),S.strokeStyle="#ef4444",S.lineWidth=2,S.strokeRect(t,n,a,o)}}function L(){E&&document.body.contains(E)&&document.body.removeChild(E),E=null,S=null}async function I(){const e=await(0,o.mt)(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist"]),t=!1!==e.floating_button_enabled,n=e.floating_button_mode||"blacklist",a=e.floating_button_blacklist||[],r=e.floating_button_whitelist||[],i=window.location.href,s=e=>{try{return e.startsWith("/")&&e.endsWith("/")?new RegExp(e.slice(1,-1)).test(i):i.includes(e)}catch(e){return!1}};let l=t;t&&("blacklist"===n?a.some(s)&&(l=!1):(l=!1,r.some(s)&&(l=!0)));const c=l,d=document.getElementById("ocr-settings-fab");if(c)if(d)d.style.display="flex";else try{document.body?v():document.addEventListener("DOMContentLoaded",()=>v())}catch(e){console.warn("Button creation failed",e)}else d&&(d.style.display="none")}console.log("Content script loaded"),I(),browser.storage.onChanged.addListener((e,t)=>{"local"===t&&(e.floating_button_enabled||e.floating_button_blacklist)&&I()}),document.addEventListener("click",e=>{try{const t=e.target.closest&&e.target.closest("button");if(!t)return;if("ocr-settings-fab"!==t.id&&"Settings"!==t.title&&"âš™"!==t.textContent.trim())return;return e.stopImmediatePropagation(),e.preventDefault(),void c()}catch(e){console.warn("Settings click interceptor error",e)}},!0);let A,O,T,R,z=!1,M=!1,j=!1,D=[],P=null;function N(){const e=P.querySelector("#toolbar-actions");if(e.innerHTML="",j){const t=document.createElement("button");t.textContent=`Process (${D.length})`,Object.assign(t.style,{padding:"6px 12px",background:"#4f46e5",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),t.onclick=()=>G();const n=document.createElement("button");n.textContent="Clear",Object.assign(n.style,{padding:"6px 12px",background:"#ef4444",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),n.onclick=()=>{D=[],k(null,[]),N()},e.appendChild(t),e.appendChild(n)}const t=document.createElement("button");t.textContent="Cancel",Object.assign(t.style,{padding:"6px 12px",background:"#374151",color:"#9ca3af",border:"1px solid #4b5563",borderRadius:"4px",cursor:"pointer",fontSize:"13px"}),t.onclick=H,e.appendChild(t)}function U(e){P&&P.contains(e.target)||(M=!0,A=e.clientX,O=e.clientY,T=A,R=O)}function B(e){if(!M)return;T=e.clientX,R=e.clientY;const t=Math.abs(T-A),n=Math.abs(R-O);k({x:Math.min(A,T),y:Math.min(O,R),width:t,height:n},D)}function $(e){if(!M)return;if(M=!1,P&&P.contains(e.target))return;const t=Math.abs(T-A),n=Math.abs(R-O);if(t<5||n<5)return void k(null,D);const a={x:Math.min(A,T),y:Math.min(O,R),width:t,height:n};j?(D.push(a),k(null,D),N()):(D=[a],G())}function F(e){"Escape"===e.key&&H(),"Enter"===e.key&&j&&D.length>0&&G()}function H(){z=!1,M=!1;try{browser.runtime.sendMessage({action:"selectionExited"})}catch(e){}document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",$),document.removeEventListener("keydown",F),P&&P.remove(),P=null,L()}async function G(){if(0===D.length)return;const t=[...D];H();const n=_("processing","");try{await new Promise(e=>setTimeout(e,100));const a=await browser.runtime.sendMessage({action:"captureViewport"});if(!a||!a.dataUrl)throw new Error("No capture data received");const o=new Image;o.src=a.dataUrl,await new Promise((e,t)=>{o.onload=e,o.onerror=t});const r=await fetch(a.dataUrl).then(e=>e.blob()),i=URL.createObjectURL(r);o.src=i,await new Promise((e,t)=>{o.onload=e,o.onerror=t});let s="",l="";const c=window.devicePixelRatio||1;let d=0;for(const n of t){d++;const a=Math.round(n.x*c),r=Math.round(n.y*c),i=Math.round(n.width*c),p=Math.round(n.height*c);if(a+i>o.width)continue;if(r+p>o.height)continue;const u=document.createElement("canvas");u.width=i,u.height=p,u.getContext("2d").drawImage(o,a,r,i,p,0,0,u.width,u.height),console.log(`Processing selection ${d}/${t.length}`);const{text:g,originalText:h}=await(0,e.performOCR)(u);s&&(s+="\n\n"),s+=g,l&&(l+="\n\n"),l+=h}!function(e,t,n){if(e.intervalId){clearInterval(e.intervalId);const t=e.querySelector('div[style*="backgroundColor: rgb(79, 70, 229)"]');t&&(t.style.width="100%")}const a=e.querySelector("textarea"),o=e.querySelector(".progress-container"),r=e.querySelector(".popup-footer");e.dataset.finalText=t,e.dataset.originalText=n||t,a&&(a.value=t),o&&(o.style.display="none"),a&&(a.style.display="block"),r&&(r.style.display="flex");const i=e.querySelector('div[style*="justify-content: space-between"]');if(i&&!e.querySelector("#btn-diff")){const t=document.createElement("button");t.id="btn-diff",t.textContent="Original",t.title="Show Original Text for Restoration",Object.assign(t.style,{border:"1px solid #374151",background:"#1f2937",color:"#9ca3af",borderRadius:"6px",padding:"6px 10px",fontSize:"12px",cursor:"pointer",marginLeft:"auto",marginRight:"8px"});const n=i.lastElementChild;i.insertBefore(t,n);let o=!1;const r=document.createElement("div");r.style.display="none",r.style.marginBottom="10px",r.style.padding="8px",r.style.background="#111827",r.style.border="1px dashed #6366f1",r.style.borderRadius="6px",r.style.fontSize="12px",r.style.color="#9ca3af",r.style.maxHeight="80px",r.style.overflowY="auto",a.parentElement.insertBefore(r,a),t.addEventListener("click",()=>{o=!o,o?(t.style.background="#4f46e5",t.style.color="#fff",r.innerHTML="",r.style.display="block",(e.dataset.originalText||"").split(/(\s+)/).forEach(e=>{const t=document.createElement("span");t.textContent=e,e.trim().length>0&&(t.style.cursor="pointer",t.style.borderBottom="1px dotted #6366f1",t.title="Click to insert into text",t.onmouseover=()=>t.style.color="white",t.onmouseout=()=>t.style.color="#9ca3af",t.onclick=()=>{const t=a.selectionStart,n=a.selectionEnd,o=a.value,r=o.substring(0,t),i=o.substring(n);a.value=r+e+i,a.selectionStart=a.selectionEnd=t+e.length,a.focus()}),r.appendChild(t)}),a.style.height="80px"):(t.style.background="#1f2937",t.style.color="#9ca3af",r.style.display="none",a.style.height="120px")})}}(n,s,l),n._ocrData={img:o,selections:t,dpr:c}}catch(e){console.error("OCR Batch failed:",e),_("done","Error processing: "+e.message)}}browser.runtime.onMessage.addListener(async e=>{var t;console.log("Content script received message:",e),"startSelection"===e.action&&(t=!0===(await(0,o.mt)(["enable_multiselect"])).enable_multiselect,z||(z=!0,D=[],(L(),E=document.createElement("canvas"),E.style.position="fixed",E.style.top="0",E.style.left="0",E.style.width="100vw",E.style.height="100vh",E.style.zIndex="999998",E.style.cursor="crosshair",document.body.appendChild(E),E.width=window.innerWidth,E.height=window.innerHeight,S=E.getContext("2d"),S&&(S.fillStyle="rgba(0, 0, 0, 0.35)",S.fillRect(0,0,E.width,E.height)),E).addEventListener("mousedown",U),document.addEventListener("mousemove",B),document.addEventListener("mouseup",$),window.addEventListener("keydown",F),function(e){if(P&&P.remove(),P=document.createElement("div"),Object.assign(P.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#1f2937",padding:"10px 16px",borderRadius:"8px",display:"flex",gap:"12px",alignItems:"center",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",zIndex:"1000002",color:"#f9fafb",fontFamily:"Inter, sans-serif"}),e){const e=document.createElement("label");e.style.display="flex",e.style.alignItems="center",e.style.cursor="pointer",e.style.gap="6px";const t=document.createElement("input");t.type="checkbox",t.checked=j,Object.assign(t.style,{cursor:"pointer",accentColor:"#4f46e5"}),t.onchange=e=>{j=e.target.checked,N()},e.appendChild(t);const n=document.createElement("span");n.textContent="Multi-Select",n.style.fontSize="14px",e.appendChild(n),P.appendChild(e)}const t=document.createElement("div");t.id="toolbar-actions",Object.assign(t.style,{display:"flex",gap:"8px",alignItems:"center"}),P.appendChild(t),document.body.appendChild(P),N()}(t)))})})()})();