(()=>{"use strict";const e="ocr_settings_data_v3",n={name:"Default",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,preprocess_morphology:!1,preprocess_borders:!1,tess_psm:"3",tess_oem:"1",tess_lang:"eng",tess_whitelist:"",auto_psm:!1,clean_noise:!0,noise_aggression:"medium",clean_normalize:!0,clean_regex:!0,clean_dict:!1,dict_strength:1,dict_ignore_caps:!0,clean_user:!0,manhwa_mode:!1,reconstruct_text:!0,reconstruct_merge:!0,reconstruct_stabilize:!0,trans_src:"auto",trans_target:"en",trans_auto:!1,trans_style:"below",debug_mode:!1,popup_hidden_buttons:[],user_replacements:[],user_deletions:[]},a={...n,name:"Manhwa Mode",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,clean_dict:!1,manhwa_mode:!0,reconstruct_merge:!0,reconstruct_stabilize:!0},t={active_profile_id:"default",floating_button_enabled:!0,floating_button_mode:"blacklist",floating_button_blacklist:[],floating_button_whitelist:[],enable_multiselect:!1,floating_visible_preprocess:!0,floating_visible_cleaning:!0,floating_visible_findreplace:!0,floating_visible_chardel:!0,floating_visible_profiles:!0,floating_visible_language:!0,floating_visible_translation:!0,floating_visible_ui:!0};async function o(e=null){const a=await l(),t=a.global.active_profile_id;let o=a.profiles[t];o||(o=a.profiles.default||{...n});const i={...a.global,...o,_profileId:t};return Array.isArray(e)?e.reduce((e,n)=>(e[n]=i[n],e),{}):i}async function i(a){const o=await l(),i=o.global.active_profile_id,s=Object.keys(t);let c=!1,r=!1;for(const[e,t]of Object.entries(a))s.includes(e)||"active_profile_id"===e?(o.global[e]=t,r=!0):(o.profiles[i]||(o.profiles[i]={...n}),o.profiles[i][e]=t,c=!0);return await browser.storage.local.set({[e]:o}),o}async function s(){const e=await l(),n=[],a=[];return Object.entries(e.profiles).forEach(([e,t])=>{const o={id:e,name:t.name||"Unnamed"};"default"===e?n.unshift(o):"manhwa"===e?n.push(o):a.push(o)}),a.sort((e,n)=>e.name.localeCompare(n.name)),[...n,...a]}async function c(n){const a=await l();return!!a.profiles[n]&&(a.global.active_profile_id=n,await browser.storage.local.set({[e]:a}),!0)}async function l(){let o=(await browser.storage.local.get(e))[e];return o.profiles||(o={global:{...t},profiles:{default:{...n},manhwa:{...a}}}),o.profiles.manhwa||o.profiles.manhwa_v1||(o.profiles.manhwa={...a},await browser.storage.local.set({[e]:o})),o}const r=[{code:"afr",name:"Afrikaans"},{code:"amh",name:"Amharic"},{code:"ara",name:"Arabic"},{code:"asm",name:"Assamese"},{code:"aze",name:"Azerbaijani"},{code:"aze_cyrl",name:"Azerbaijani (Cyrillic)"},{code:"bel",name:"Belarusian"},{code:"ben",name:"Bengali"},{code:"bod",name:"Tibetan"},{code:"bos",name:"Bosnian"},{code:"bul",name:"Bulgarian"},{code:"cat",name:"Catalan"},{code:"ceb",name:"Cebuano"},{code:"ces",name:"Czech"},{code:"chi_sim",name:"Chinese (Simplified)"},{code:"chi_tra",name:"Chinese (Traditional)"},{code:"chr",name:"Cherokee"},{code:"cym",name:"Welsh"},{code:"dan",name:"Danish"},{code:"deu",name:"German"},{code:"dzo",name:"Dzongkha"},{code:"ell",name:"Greek"},{code:"eng",name:"English"},{code:"enm",name:"English (Middle)"},{code:"epo",name:"Esperanto"},{code:"est",name:"Estonian"},{code:"eus",name:"Basque"},{code:"fas",name:"Persian"},{code:"fin",name:"Finnish"},{code:"fra",name:"French"},{code:"frk",name:"Frankish"},{code:"frm",name:"French (Middle)"},{code:"gle",name:"Irish"},{code:"glg",name:"Galician"},{code:"grc",name:"Greek (Ancient)"},{code:"guj",name:"Gujarati"},{code:"hat",name:"Haitian"},{code:"heb",name:"Hebrew"},{code:"hin",name:"Hindi"},{code:"hrv",name:"Croatian"},{code:"hun",name:"Hungarian"},{code:"iku",name:"Inuktitut"},{code:"ind",name:"Indonesian"},{code:"isl",name:"Icelandic"},{code:"ita",name:"Italian"},{code:"ita_old",name:"Italian (Old)"},{code:"jav",name:"Javanese"},{code:"jpn",name:"Japanese"},{code:"kan",name:"Kannada"},{code:"kat",name:"Georgian"},{code:"kat_old",name:"Georgian (Old)"},{code:"kaz",name:"Kazakh"},{code:"khm",name:"Khmer"},{code:"kir",name:"Kirghiz"},{code:"kor",name:"Korean"},{code:"kur",name:"Kurdish"},{code:"lao",name:"Lao"},{code:"lat",name:"Latin"},{code:"lav",name:"Latvian"},{code:"lit",name:"Lithuanian"},{code:"mal",name:"Malayalam"},{code:"mar",name:"Marathi"},{code:"mkd",name:"Macedonian"},{code:"mlt",name:"Maltese"},{code:"msa",name:"Malay"},{code:"mya",name:"Burmese"},{code:"nep",name:"Nepali"},{code:"nld",name:"Dutch"},{code:"nor",name:"Norwegian"},{code:"ori",name:"Oriya"},{code:"pan",name:"Punjabi"},{code:"pol",name:"Polish"},{code:"por",name:"Portuguese"},{code:"pus",name:"Pashto"},{code:"ron",name:"Romanian"},{code:"rus",name:"Russian"},{code:"san",name:"Sanskrit"},{code:"sin",name:"Sinhala"},{code:"slk",name:"Slovak"},{code:"slv",name:"Slovenian"},{code:"spa",name:"Spanish"},{code:"spa_old",name:"Spanish (Old)"},{code:"sqi",name:"Albanian"},{code:"srp",name:"Serbian"},{code:"srp_latn",name:"Serbian (Latin)"},{code:"swan",name:"Swahili"},{code:"swe",name:"Swedish"},{code:"syr",name:"Syriac"},{code:"tam",name:"Tamil"},{code:"tel",name:"Telugu"},{code:"tgk",name:"Tajik"},{code:"tgl",name:"Tagalog"},{code:"tha",name:"Thai"},{code:"tir",name:"Tigrinya"},{code:"tur",name:"Turkish"},{code:"uig",name:"Uighur"},{code:"ukr",name:"Ukrainian"},{code:"urd",name:"Urdu"},{code:"uzb",name:"Uzbek"},{code:"uzb_cyrl",name:"Uzbek (Cyrillic)"},{code:"vie",name:"Vietnamese"},{code:"yid",name:"Yiddish"}],d=[{code:"auto",name:"Auto Detect"},{code:"af",name:"Afrikaans"},{code:"sq",name:"Albanian"},{code:"am",name:"Amharic"},{code:"ar",name:"Arabic"},{code:"hy",name:"Armenian"},{code:"az",name:"Azerbaijani"},{code:"bn",name:"Bangla"},{code:"bs",name:"Bosnian"},{code:"bg",name:"Bulgarian"},{code:"ca",name:"Catalan"},{code:"zh-Hans",name:"Chinese (Simplified)"},{code:"zh-Hant",name:"Chinese (Traditional)"},{code:"hr",name:"Croatian"},{code:"cs",name:"Czech"},{code:"da",name:"Danish"},{code:"nl",name:"Dutch"},{code:"en",name:"English"},{code:"et",name:"Estonian"},{code:"fi",name:"Finnish"},{code:"fr",name:"French"},{code:"de",name:"German"},{code:"el",name:"Greek"},{code:"gu",name:"Gujarati"},{code:"ht",name:"Haitian Creole"},{code:"he",name:"Hebrew"},{code:"hi",name:"Hindi"},{code:"mww",name:"Hmong Daw"},{code:"hu",name:"Hungarian"},{code:"is",name:"Icelandic"},{code:"id",name:"Indonesian"},{code:"ga",name:"Irish"},{code:"it",name:"Italian"},{code:"ja",name:"Japanese"},{code:"kn",name:"Kannada"},{code:"kk",name:"Kazakh"},{code:"km",name:"Khmer"},{code:"ko",name:"Korean"},{code:"lo",name:"Lao"},{code:"lv",name:"Latvian"},{code:"lt",name:"Lithuanian"},{code:"ms",name:"Malay"},{code:"ml",name:"Malayalam"},{code:"mt",name:"Maltese"},{code:"mr",name:"Marathi"},{code:"my",name:"Myanmar (Burmese)"},{code:"ne",name:"Nepali"},{code:"nb",name:"Norwegian"},{code:"ps",name:"Pashto"},{code:"fa",name:"Persian"},{code:"pl",name:"Polish"},{code:"pt",name:"Portuguese"},{code:"pa",name:"Punjabi"},{code:"ro",name:"Romanian"},{code:"ru",name:"Russian"},{code:"sm",name:"Samoan"},{code:"sr-Cyrl",name:"Serbian (Cyrillic)"},{code:"sr-Latn",name:"Serbian (Latin)"},{code:"sk",name:"Slovak"},{code:"sl",name:"Slovenian"},{code:"es",name:"Spanish"},{code:"sw",name:"Swahili"},{code:"sv",name:"Swedish"},{code:"ta",name:"Tamil"},{code:"te",name:"Telugu"},{code:"th",name:"Thai"},{code:"tr",name:"Turkish"},{code:"uk",name:"Ukrainian"},{code:"ur",name:"Urdu"},{code:"uz",name:"Uzbek"},{code:"vi",name:"Vietnamese"},{code:"cy",name:"Welsh"}];let p={activeTab:"general",scope:"global",isFloating:!1,restartRequired:!1};const m=[{id:"general",label:"General",icon:"âš™ï¸"},{id:"image",label:"Image Processing",icon:"ðŸ–¼ï¸"},{id:"text",label:"Text Cleaning",icon:"ðŸ“"},{id:"translation",label:"Translation",icon:"ðŸŒ"},{id:"rules",label:"Find & Replace",icon:"ðŸ”"},{id:"ui",label:"Interface",icon:"ðŸ–¥ï¸"},{id:"data",label:"Data",icon:"ðŸ’¾"}];async function u(){p.isFloating=!1,document.body.innerHTML="";const e=document.createElement("div");Object.assign(e.style,{fontFamily:"'Segoe UI', Inter, sans-serif",backgroundColor:"#0f1724",color:"#f9fafb",minHeight:"100vh",display:"flex",flexDirection:"column"});const n=document.createElement("div");Object.assign(n.style,{flex:"1",display:"flex",maxWidth:"1200px",width:"100%",margin:"0 auto",padding:"20px",gap:"20px",boxSizing:"border-box"});const a=document.createElement("aside");Object.assign(a.style,{width:"260px",flexShrink:"0",display:"flex",flexDirection:"column",gap:"20px"});const t=document.createElement("main");async function o(){g(a,o),await b(t)}Object.assign(t.style,{flex:"1",backgroundColor:"#1f2937",borderRadius:"12px",padding:"30px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)"}),await g(a,o),n.appendChild(a),n.appendChild(t),e.appendChild(n),document.body.appendChild(e),await o()}async function g(e,n){e.innerHTML="";const a=document.createElement("div");Object.assign(a.style,{background:"#1f2937",padding:"15px",borderRadius:"8px",marginBottom:"10px"}),await async function(e,n){const a=await o(["active_profile_id"]),t=await s(),i=a.active_profile_id,l=document.createElement("div");l.textContent="Active Profile",l.style.fontSize="12px",l.style.color="#9ca3af",l.style.marginBottom="8px",e.appendChild(l);const r=document.createElement("select");Object.assign(r.style,{width:"100%",padding:"8px",background:"#374151",color:"white",border:"1px solid #4b5563",borderRadius:"6px"}),t.forEach(e=>{const n=document.createElement("option");n.value=e.id,n.textContent=e.name,r.appendChild(n)}),r.value=i,r.onchange=async()=>{await c(r.value),n&&n()},e.appendChild(r);const d=document.createElement("button");d.textContent="Manage Profiles",Object.assign(d.style,{background:"none",border:"none",color:"#60a5fa",fontSize:"12px",cursor:"pointer",padding:"0",marginTop:"8px"}),d.onclick=()=>{p.activeTab="general",n&&n()},e.appendChild(d)}(a,n),e.appendChild(a);const t=document.createElement("nav");Object.assign(t.style,{display:"flex",flexDirection:"column",gap:"5px"}),m.forEach(e=>{const a=document.createElement("button"),o=p.activeTab===e.id;a.innerHTML=`<span style="margin-right:10px">${e.icon}</span> ${e.label}`,Object.assign(a.style,{textAlign:"left",padding:"12px 15px",borderRadius:"8px",border:"none",cursor:"pointer",background:o?"#4f46e5":"transparent",color:o?"#fff":"#d1d5db",fontSize:"14px",transition:"background 0.2s"}),a.onclick=()=>{p.activeTab=e.id,n()},t.appendChild(a)}),e.appendChild(t)}async function b(a){if(a.innerHTML="",a.scrollTop=0,!["data","general"].includes(p.activeTab)){const e=document.createElement("div");Object.assign(e.style,{marginBottom:"20px",paddingBottom:"15px",borderBottom:"1px solid #374151"}),await async function(e,n){const a=["global"];p.scope.startsWith("site:")&&!a.includes(p.scope)&&a.push(p.scope);const t=document.createElement("div");Object.assign(t.style,{display:"flex",alignItems:"center",justifyContent:"space-between"});const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.gap="10px";const i=document.createElement("span");i.textContent="Configuring Scope:",i.style.fontSize="12px",i.style.color="#9ca3af";const s=document.createElement("select");Object.assign(s.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",width:"auto",padding:"6px 12px"}),a.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent="global"===e?"Global Defaults":"This Site Only ("+e.replace("site:","")+")",s.appendChild(n)}),s.value=p.scope,s.onchange=()=>{p.scope=s.value,n()},o.appendChild(i),o.appendChild(s);const c=document.createElement("div");if("global"===p.scope&&window.location.origin){const e=w("+ Add Site Scope",()=>{const e=`site:${window.location.origin}`;p.scope=e,n()});c.appendChild(e)}else if("global"!==p.scope){const e=w("Delete Scope",async()=>{confirm("Delete all rules for this site?")&&(await v(p.scope,[]),await k(p.scope,[]),p.scope="global",n())},"danger");c.appendChild(e)}t.appendChild(o),t.appendChild(c),e.appendChild(t)}(e,()=>b(a)),a.appendChild(e)}const s=p.scope;switch(p.activeTab){case"general":await async function(e){f(e,"Profile Management");const n=document.createElement("div");await h(n),e.appendChild(n)}(a);break;case"image":await async function(e){f(e,"Preprocessing Pipeline");const n=await o(["preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","tess_lang"]),a=x("OCR Language","Language model to use for recognition."),t=document.createElement("select");if(Object.assign(t.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),r.forEach(e=>{const n=document.createElement("option");n.value=e.code,n.textContent=`${e.name} (${e.code})`,t.appendChild(n)}),!r.some(e=>e.code===n.tess_lang)){const e=document.createElement("option");e.value=n.tess_lang,e.textContent=n.tess_lang,t.appendChild(e)}t.value=n.tess_lang||"eng",t.onchange=async()=>await i({tess_lang:t.value}),a.appendChild(t),e.appendChild(a),e.appendChild(_("Resize 2x","Upscale image for better accuracy",!1!==n.preprocess_resize,e=>i({preprocess_resize:e}))),e.appendChild(_("Grayscale","Convert to B&W",!1!==n.preprocess_grayscale,e=>i({preprocess_grayscale:e}))),e.appendChild(_("Contrast","Enhance text contrast",!1!==n.preprocess_contrast,e=>i({preprocess_contrast:e}))),e.appendChild(_("Median Blur","Reduce noise (Slower)",!0===n.preprocess_blur,e=>i({preprocess_blur:e}))),e.appendChild(_("Adaptive Threshold","Binarize image (Good for bad lighting)",!0===n.preprocess_threshold,e=>i({preprocess_threshold:e})))}(a);break;case"text":await async function(e){f(e,"Text Cleaning");const n=await o(["clean_noise","noise_aggression","clean_normalize","clean_dict","dict_strength","dict_ignore_caps","manhwa_mode","reconstruct_text","reconstruct_merge","reconstruct_stabilize"]);e.appendChild(_("Noise Cleaning","Remove non-text artifacts",!1!==n.clean_noise,e=>i({clean_noise:e})));const a=x("Noise Aggression","How aggressively to remove small dots."),t=document.createElement("select");Object.assign(t.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),["low","medium","high"].forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e.charAt(0).toUpperCase()+e.slice(1),t.appendChild(n)}),t.value=n.noise_aggression||"medium",t.onchange=async()=>i({noise_aggression:t.value}),a.appendChild(t),e.appendChild(a),e.appendChild(_("Normalize Whitespace","Fix spacing and line breaks",!1!==n.clean_normalize,e=>i({clean_normalize:e}))),e.appendChild(C()),e.appendChild(_("Dictionary Correction","Fix spelling using vocabulary",!0===n.clean_dict,e=>i({clean_dict:e}))),e.appendChild(_("Ignore ALL CAPS","Skip dictionary for UPPERCASE words",!1!==n.dict_ignore_caps,e=>i({dict_ignore_caps:e}))),e.appendChild(C()),f(e,"Reconstruction"),e.appendChild(_("Enable Reconstruction","Rebuild sentences from lines",!1!==n.reconstruct_text,e=>i({reconstruct_text:e}))),e.appendChild(_("Broken Line Merge","Join lines split by hyphens",!1!==n.reconstruct_merge,e=>i({reconstruct_merge:e}))),e.appendChild(_("Manhwa Mode","Optimize for vertical text bubbles",!0===n.manhwa_mode,e=>i({manhwa_mode:e})))}(a);break;case"translation":await async function(e){f(e,"Translation Settings");const n=await o(["trans_src","trans_target","trans_auto","trans_style"]),a=x("Source Language","Language of the text in image."),t=document.createElement("select");Object.assign(t.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"});const s=document.createElement("option");s.value="auto",s.textContent="Detect Language (Auto)",t.appendChild(s),d.forEach(e=>{const n=document.createElement("option");n.value=e.code,n.textContent=e.name,t.appendChild(n)}),t.value=n.trans_src||"auto",t.onchange=async()=>await i({trans_src:t.value}),a.appendChild(t),e.appendChild(a),e.appendChild(_("Auto-Detect Source","Always try to detect source language first",!1!==n.trans_auto,e=>i({trans_auto:e})));const c=x("Target Language","Language to translate into."),l=document.createElement("select");Object.assign(l.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),d.forEach(e=>{const n=document.createElement("option");n.value=e.code,n.textContent=e.name,l.appendChild(n)}),l.value=n.trans_target||"en",l.onchange=async()=>await i({trans_target:l.value}),c.appendChild(l),e.appendChild(c),e.appendChild(C());const r=x("Display Style","How translation results are shown."),p=document.createElement("select");Object.assign(p.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),[{v:"replace",t:"Replace Original Text"},{v:"below",t:"Show Below Original"},{v:"side",t:"Show Side-by-Side (Tooltip)"}].forEach(e=>{const n=document.createElement("option");n.value=e.v,n.textContent=e.t,p.appendChild(n)}),p.value=n.trans_style||"replace",p.onchange=async()=>await i({trans_style:p.value}),r.appendChild(p),e.appendChild(r)}(a);break;case"rules":await async function(e,n){const a=await async function(e){if("global"===e){const e=await o(["user_replacements","user_deletions"]);return{replacements:e.user_replacements||[],deletions:e.user_deletions||[]}}{const n=`user_replacements_${e}`,a=`user_deletions_${e}`,t=await browser.storage.local.get([n,a]);return{replacements:t[n]||[],deletions:t[a]||[]}}}(n);f(e,"Find & Replace Rules"),await async function(e,n,a){const t=document.createElement("div");Object.assign(t.style,{display:"flex",flexDirection:"column",gap:"8px",marginBottom:"15px"});const o=document.createElement("div");o.style.display="flex",o.style.gap="10px",o.style.marginBottom="15px";const i=document.createElement("input");i.placeholder="Find",Object.assign(i.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",flex:"1"});const s=document.createElement("input");s.placeholder="Replace",Object.assign(s.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",flex:"1"});const c=document.createElement("button");c.textContent="Add",Object.assign(c.style,{background:"#4f46e5",color:"white",border:"none",borderRadius:"6px",padding:"0 15px",cursor:"pointer"});const l=document.createElement("div");l.style.display="flex",l.style.gap="15px",l.style.marginBottom="10px",l.style.fontSize="13px";const r=y("Regex"),d=y("Match Case"),p=y("Whole Word");l.appendChild(r),l.appendChild(d),l.appendChild(p),c.onclick=async()=>{i.value&&(n.push({find:i.value,replace:s.value,isRegex:r.querySelector("input").checked,caseSensitive:d.querySelector("input").checked,wholeWord:p.querySelector("input").checked,enabled:!0}),await k(a,n),m(),i.value="",s.value="")},o.appendChild(i),o.appendChild(s),o.appendChild(c),e.appendChild(o),e.appendChild(l);const m=()=>{t.innerHTML="",n.forEach((e,o)=>{const i=document.createElement("div");Object.assign(i.style,{display:"flex",alignItems:"center",background:"#111827",padding:"8px 12px",borderRadius:"6px",gap:"10px"});const s=document.createElement("div");s.innerHTML=`<span style="color:#d1d5db">${e.find}</span> <span style="color:#6b7280">âžž</span> <span style="color:#93c5fd">${e.replace}</span>`,Object.assign(s.style,{flex:"1",fontSize:"14px",fontFamily:"monospace"}),e.enabled||(s.style.opacity="0.5");const c=document.createElement("button");c.textContent="âœ•",Object.assign(c.style,{background:"transparent",border:"none",color:"#ef4444",cursor:"pointer"}),c.onclick=async()=>{n.splice(o,1),await k(a,n),m()},i.appendChild(s),i.appendChild(c),t.appendChild(i)})};m(),e.appendChild(t)}(e,a.replacements,n),f(e,"Character Deletion",!0),await async function(e,n,a){const t=document.createElement("div"),o=document.createElement("input");o.placeholder="Add char...",Object.assign(o.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",width:"120px",fontSize:"13px"}),o.onkeydown=async e=>{"Enter"===e.key&&o.value&&(n.push({char:o.value}),await v(a,n),o.value="",s())};const i=document.createElement("div");Object.assign(i.style,{display:"flex",flexWrap:"wrap",gap:"8px",marginTop:"10px"});const s=()=>{i.innerHTML="",n.forEach((e,t)=>{const o="string"==typeof e?e:e.char,c=document.createElement("div");Object.assign(c.style,{background:"#374151",padding:"4px 8px",borderRadius:"4px",fontSize:"13px",display:"flex",alignItems:"center",gap:"6px"}),c.innerHTML=`<span>${o}</span>`;const l=document.createElement("span");l.textContent="Ã—",l.style.cursor="pointer",l.style.color="#ef4444",l.onclick=async()=>{n.splice(t,1),await v(a,n),s()},c.appendChild(l),i.appendChild(c)})};s(),t.appendChild(o),t.appendChild(i),e.appendChild(t)}(e,a.deletions,n)}(a,s);break;case"ui":await async function(e){const n=await o(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist","popup_hidden_buttons","debug_mode","floating_visible_preprocess","floating_visible_cleaning","floating_visible_findreplace","floating_visible_profiles","floating_visible_ui","floating_visible_translation"]);f(e,"Floating Button"),e.appendChild(_("Show Floating Button","Enable the OCR button on pages",!1!==n.floating_button_enabled,async e=>{await i({floating_button_enabled:e}),p.restartRequired=!0}));const a=x("Filter Rules","Where should the button appear?"),t=document.createElement("select");Object.assign(t.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box"}),t.innerHTML='<option value="blacklist">Show Everywhere (Except...)</option><option value="whitelist">Hide Everywhere (Except...)</option>',t.value=n.floating_button_mode||"blacklist";const s=document.createElement("textarea");Object.assign(s.style,{background:"#111827",border:"1px solid #374151",color:"white",padding:"8px 12px",borderRadius:"6px",fontSize:"14px",outline:"none",width:"100%",boxSizing:"border-box",height:"100px",marginTop:"10px",fontFamily:"monospace"});const c=()=>{const e="whitelist"===n.floating_button_mode?n.floating_button_whitelist||[]:n.floating_button_blacklist||[];s.value=e.join("\n")};c(),t.onchange=async()=>{await i({floating_button_mode:t.value}),n.floating_button_mode=t.value,c()},s.onchange=async()=>{const e="whitelist"===n.floating_button_mode?"floating_button_whitelist":"floating_button_blacklist",a=s.value.split("\n").map(e=>e.trim()).filter(Boolean);await i({[e]:a}),n[e]=a},a.appendChild(t),a.appendChild(s),e.appendChild(a),f(e,"Popup Configuration",!0);const l=document.createElement("div");l.style.display="grid",l.style.gridTemplateColumns="repeat(auto-fill, minmax(140px, 1fr))",l.style.gap="10px";const r=n.popup_hidden_buttons||[];["Lowercase","Uppercase","Single Line","Manhwa Mode","Copy","Translate"].forEach(e=>{const n=!r.includes(e),a=y(e,n,async n=>{let a=await o(["popup_hidden_buttons"]).then(e=>e.popup_hidden_buttons||[]);n?a=a.filter(n=>n!==e):a.includes(e)||a.push(e),await i({popup_hidden_buttons:a})});l.appendChild(a)}),e.appendChild(l),f(e,"System",!0),e.appendChild(_("Debug Mode","Log detailed info to console",!0===n.debug_mode,e=>i({debug_mode:e}))),p.isFloating||(f(e,"Floating Settings Panel",!0),[{k:"floating_visible_profiles",l:"Show Profiles Tab"},{k:"floating_visible_preprocess",l:"Show Image Tab"},{k:"floating_visible_cleaning",l:"Show Text Tab"},{k:"floating_visible_translation",l:"Show Translation Tab"},{k:"floating_visible_findreplace",l:"Show Rules Tab"},{k:"floating_visible_ui",l:"Show UI Tab"}].forEach(a=>{const t=!1!==n[a.k];e.appendChild(_(a.l,"",t,e=>i({[a.k]:e})))}))}(a);break;case"data":await async function(a){f(a,"Data Management");const o=document.createElement("p");o.textContent="Import/Export your configuration and profiles.",o.style.color="#9ca3af",o.style.fontSize="14px",a.appendChild(o);const i=document.createElement("div");i.style.display="flex",i.style.gap="10px",i.style.marginTop="20px";const s={padding:"10px 16px",borderRadius:"6px",border:"none",cursor:"pointer",fontWeight:"500"},c=document.createElement("button");c.textContent="Import JSON",Object.assign(c.style,{...s,background:"#374151",color:"white"});const r=document.createElement("button");r.textContent="Export JSON",Object.assign(r.style,{...s,background:"#4f46e5",color:"white"});const d=document.createElement("button");d.textContent="Factory Reset",Object.assign(d.style,{...s,background:"rgba(239, 68, 68, 0.2)",color:"#ef4444"}),r.onclick=()=>{(async function(e="full",n={}){const a=await l();if("full"===e){const e={version:1,timestamp:Date.now(),type:"full_backup",data:a,site_replacements:{},site_deletions:{}},n=await browser.storage.local.get(null);return Object.keys(n).forEach(a=>{a.startsWith("user_replacements_site:")&&(e.site_replacements[a]=n[a]),a.startsWith("user_deletions_site:")&&(e.site_deletions[a]=n[a])}),JSON.stringify(e,null,2)}if("profile"===e){const e=n.id||a.global.active_profile_id,t=a.profiles[e];if(!t)throw new Error("Profile not found");const o={version:1,timestamp:Date.now(),type:"profile_export",name:t.name,data:t};return JSON.stringify(o,null,2)}})("full").then(e=>{const n=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(n),t=document.createElement("a");t.href=a,t.download="ocr-settings.json",t.click()})},c.onclick=()=>{const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async a=>{const t=a.target.files[0];t&&confirm("Import settings? Previous data will be overwritten.")&&(await async function(a,t="merge"){let o;try{o=JSON.parse(a)}catch(e){throw new Error("Invalid JSON format")}if(!o.version||!o.type)throw new Error("Invalid settings file (missing metadata)");const i=await l();if("profile_export"===o.type){const a=`profile_${Date.now()}_imp`,s=o.name+("merge"===t?" (Imported)":"");return i.profiles[a]={...n,...o.data},i.profiles[a].name=s,await browser.storage.local.set({[e]:i}),{success:!0,message:`Imported profile "${s}"`}}if("full_backup"===o.type){const n=o.data;if("replace"===t)return await browser.storage.local.set({[e]:n}),o.site_replacements&&await browser.storage.local.set(o.site_replacements),o.site_deletions&&await browser.storage.local.set(o.site_deletions),{success:!0,message:"Settings fully restored."};if("merge"===t){let a=0;for(const[e,t]of Object.entries(n.profiles))if(i.profiles[e]){const n=`${e}_merge_${Date.now()}`;i.profiles[n]={...t,name:t.name+" (Imported)"},a++}else i.profiles[e]=t,a++;return await browser.storage.local.set({[e]:i}),{success:!0,message:`Merged ${a} profiles.`}}}throw new Error("Unknown import type")}(await t.text(),"merge"),location.reload())},a.click()},d.onclick=()=>{confirm("DANGER: This will delete ALL profiles and settings. Continue?")&&async function(){await l();{await browser.storage.local.clear();const a={global:{...t},profiles:{default:{...n}}};return await browser.storage.local.set({[e]:a}),!0}}().then(()=>location.reload())},i.appendChild(c),i.appendChild(r),i.appendChild(d),a.appendChild(i)}(a)}}async function h(a){const t=await o(["active_profile_id"]),i=await s(),r=t.active_profile_id,d=document.createElement("div");Object.assign(d.style,{display:"flex",flexDirection:"column",gap:"8px",marginBottom:"15px"}),i.forEach(n=>{const t=document.createElement("div"),o=n.id===r;Object.assign(t.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px",background:o?"rgba(79, 70, 229, 0.1)":"#111827",border:o?"1px solid #4f46e5":"1px solid transparent",borderRadius:"8px"});const i=document.createElement("span");i.textContent=n.name,o&&(i.style.fontWeight="bold"),o&&(i.style.color="#818cf8");const s=document.createElement("div");if(s.style.display="flex",s.style.gap="8px",!o){const e=w("Load",async()=>{await c(n.id),h(a)});s.appendChild(e)}if(!["default","manhwa"].includes(n.id)){const t=w("Rename",async()=>{const t=prompt("Rename:",n.name);t&&(await async function(n,a){const t=await l();return!!t.profiles[n]&&(t.profiles[n].name=a,await browser.storage.local.set({[e]:t}),!0)}(n.id,t),h(a))}),o=w("Delete",async()=>{confirm(`Delete ${n.name}?`)&&(await async function(n){const a=await l();return"default"!==n&&"manhwa"!==n&&(delete a.profiles[n],a.global.active_profile_id===n&&(a.global.active_profile_id="default"),await browser.storage.local.set({[e]:a}),!0)}(n.id),h(a))},"danger");s.appendChild(t),s.appendChild(o)}t.appendChild(i),t.appendChild(s),d.appendChild(t)});const p=document.createElement("button");p.textContent="+ Create New Profil",Object.assign(p.style,{width:"100%",padding:"10px",background:"#374151",color:"#9ca3af",border:"2px dashed #4b5563",borderRadius:"8px",cursor:"pointer"}),p.onclick=async()=>{const t=prompt("Profile Name:");t&&(await async function(a,t=null){const o=await l(),i=`profile_${Date.now()}`;let s=n;return t&&o.profiles[t]&&(s=o.profiles[t]),o.profiles[i]={...s,name:a},await browser.storage.local.set({[e]:o}),i}(t),h(a))},a.innerHTML="",a.appendChild(d),a.appendChild(p)}function f(e,n,a=!1){const t=document.createElement(a?"h4":"h3");t.textContent=n,Object.assign(t.style,{margin:a?"20px 0 10px 0":"0 0 20px 0",fontSize:a?"16px":"22px",color:"#f3f4f6",fontWeight:"600"}),e.appendChild(t)}function x(e,n){const a=document.createElement("div");Object.assign(a.style,{marginBottom:"15px"});const t=document.createElement("label");t.textContent=e,Object.assign(t.style,{display:"block",fontSize:"14px",fontWeight:"500",marginBottom:"4px"});const o=document.createElement("div");return o.textContent=n,Object.assign(o.style,{fontSize:"12px",color:"#9ca3af",marginBottom:"8px"}),a.appendChild(t),a.appendChild(o),a}function _(e,n,a,t){const o=document.createElement("div");Object.assign(o.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px",background:"#111827",borderRadius:"8px",marginBottom:"10px"});const i=document.createElement("div"),s=document.createElement("div");s.textContent=e,s.style.fontSize="14px",s.style.fontWeight="500";const c=document.createElement("div");c.textContent=n,c.style.fontSize="12px",c.style.color="#9ca3af",i.appendChild(s),n&&i.appendChild(c);const l=document.createElement("div");Object.assign(l.style,{width:"44px",height:"24px",borderRadius:"12px",background:a?"#4f46e5":"#374151",position:"relative",cursor:"pointer",transition:"background 0.2s"});const r=document.createElement("div");return Object.assign(r.style,{width:"18px",height:"18px",borderRadius:"50%",background:"white",position:"absolute",top:"3px",left:a?"23px":"3px",transition:"left 0.2s"}),l.appendChild(r),l.onclick=()=>{const e=!a;t(e),l.style.background=e?"#4f46e5":"#374151",r.style.left=e?"23px":"3px",a=e},o.appendChild(i),o.appendChild(l),o}function y(e,n=!1,a=null){const t=document.createElement("label");Object.assign(t.style,{display:"flex",gap:"8px",alignItems:"center",cursor:"pointer",fontSize:"13px"});const o=document.createElement("input");return o.type="checkbox",o.checked=n,a&&(o.onchange=e=>a(e.target.checked)),t.appendChild(o),t.appendChild(document.createTextNode(e)),t}function w(e,n,a="normal"){const t=document.createElement("button");return t.textContent=e,Object.assign(t.style,{padding:"4px 8px",fontSize:"11px",borderRadius:"4px",border:"none",cursor:"pointer",background:"danger"===a?"rgba(239, 68, 68, 0.2)":"#374151",color:"danger"===a?"#ef4444":"#e5e7eb"}),t.onclick=n,t}function C(){const e=document.createElement("div");return e.style.borderTop="1px solid #374151",e.style.margin="15px 0",e}async function v(e,n){const a="global"===e?"user_deletions":`user_deletions_${e}`;"global"===e?await i({user_deletions:n}):await browser.storage.local.set({[a]:n})}async function k(e,n){const a="global"===e?"user_replacements":`user_replacements_${e}`;"global"===e?await i({user_replacements:n}):await browser.storage.local.set({[a]:n})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u):u()})();