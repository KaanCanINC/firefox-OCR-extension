(()=>{"use strict";const e="ocr_settings_data_v3",t={name:"Default",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,preprocess_morphology:!1,preprocess_borders:!1,tess_psm:"3",tess_oem:"1",tess_lang:"eng",tess_whitelist:"",auto_psm:!1,clean_noise:!0,noise_aggression:"medium",clean_normalize:!0,clean_regex:!0,clean_dict:!1,dict_strength:1,dict_ignore_caps:!0,clean_user:!0,manhwa_mode:!1,reconstruct_text:!0,reconstruct_merge:!0,reconstruct_stabilize:!0,debug_mode:!1,popup_hidden_buttons:[],user_replacements:[],user_deletions:[]},n={...t,name:"Manhwa Mode",preprocess_resize:!0,preprocess_grayscale:!0,preprocess_contrast:!0,preprocess_blur:!1,preprocess_threshold:!1,clean_dict:!1,manhwa_mode:!0,reconstruct_merge:!0,reconstruct_stabilize:!0},o={active_profile_id:"default",floating_button_enabled:!0,floating_button_mode:"blacklist",floating_button_blacklist:[],floating_button_whitelist:[],enable_multiselect:!1};async function a(e=null){const n=await r(),o=n.global.active_profile_id;let a=n.profiles[o];a||(a=n.profiles.default||{...t});const l={...n.global,...a,_profileId:o};return Array.isArray(e)?e.reduce((e,t)=>(e[t]=l[t],e),{}):l}async function l(n){const a=await r(),l=a.global.active_profile_id,s=Object.keys(o);let i=!1,c=!1;for(const[e,o]of Object.entries(n))s.includes(e)||"active_profile_id"===e?(a.global[e]=o,c=!0):(a.profiles[l]||(a.profiles[l]={...t}),a.profiles[l][e]=o,i=!0);return await browser.storage.local.set({[e]:a}),a}async function s(n,o=null){const a=await r(),l=`profile_${Date.now()}`;let s=t;return o&&a.profiles[o]&&(s=a.profiles[o]),a.profiles[l]={...s,name:n},await browser.storage.local.set({[e]:a}),l}async function i(t){const n=await r();return!!n.profiles[t]&&(n.global.active_profile_id=t,await browser.storage.local.set({[e]:n}),!0)}async function r(){let a=(await browser.storage.local.get(e))[e];return a.profiles||(a={global:{...o},profiles:{default:{...t},manhwa:{...n}}}),a.profiles.manhwa||a.profiles.manhwa_v1||(a.profiles.manhwa={...n},await browser.storage.local.set({[e]:a})),a}async function c(){document.body.innerHTML="";const n=document.createElement("div");Object.assign(n.style,{fontFamily:"Inter, sans-serif",backgroundColor:"#0f1724",color:"#f9fafb",minHeight:"100vh",padding:"40px",boxSizing:"border-box"});const c=document.createElement("div");Object.assign(c.style,{maxWidth:"900px",margin:"0 auto 30px auto",display:"flex",justifyContent:"space-between",alignItems:"center"});const f=document.createElement("div"),g=document.createElement("h1");g.textContent="OCR Settings",Object.assign(g.style,{fontSize:"28px",margin:"0 0 5px 0"});const b=document.createElement("div");b.textContent="Configure extension behavior and profiles",Object.assign(b.style,{fontSize:"14px",color:"#9ca3af"}),f.appendChild(g),f.appendChild(b);const y=document.createElement("div");Object.assign(y.style,{display:"flex",gap:"10px"});const x=function(e,t,n="primary"){const o=document.createElement("button");o.textContent=e;const a="danger"===n?"transparent":"secondary"===n?"#4b5563":"#4f46e5",l="danger"===n?"#ef4444":"white",s="danger"===n?"1px solid #ef4444":"none";return Object.assign(o.style,{padding:"8px 16px",background:a,border:s,color:l,borderRadius:"6px",cursor:"pointer",fontSize:"13px"}),o.onclick=t,o}("Reload UI",async()=>location.reload(),"secondary");y.appendChild(x),c.appendChild(f),c.appendChild(y);const h=document.createElement("div");Object.assign(h.style,{maxWidth:"900px",margin:"0 auto",backgroundColor:"#374151",padding:"30px",borderRadius:"12px",boxShadow:"0 10px 25px rgba(0,0,0,0.3)"}),n.appendChild(c),n.appendChild(h),document.body.appendChild(n),await async function(n,c,f){const g=document.createElement("div");g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.gap="8px",g.style.margin="8px 0 12px 0";const b=document.createElement("div");b.style.display="flex",b.style.margin="8px 0 0 ",b.style.alignItems="center",b.style.gap="6px",b.style.flex="1";const y=document.createElement("label");y.textContent="Rule Scope",y.style.color="#e6eef8",y.style.fontSize="13px";const x=document.createElement("select");x.id="rule_scope",Object.assign(x.style,{padding:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",minWidth:"160px",margin:"0 auto"});const h=["global"];let _=null;try{window.location.origin&&"null"!==window.location.origin&&(_=`site:${window.location.origin}`)}catch(e){}_&&!h.includes(_)&&h.push(_);const w=()=>{x.innerHTML="",h.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent="global"===e?"Global Rules":e.replace("site:","")+" (This Site)",x.appendChild(t)}),x.value=c};w(),b.appendChild(y),b.appendChild(x);const C=document.createElement("div");C.style.display="flex",C.style.alignItems="center",C.style.gap="8px";const E=document.createElement("button");E.textContent="+",Object.assign(E.style,{padding:"6px 8px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"});const v=document.createElement("button");v.textContent="ðŸ—‘ï¸",Object.assign(v.style,{padding:"6px 8px",borderRadius:"6px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer"}),C.appendChild(E),C.appendChild(v),g.appendChild(b),g.appendChild(C),n.appendChild(g),x.onchange=()=>j(x.value),E.onclick=()=>{_&&!h.includes(_)?(h.push(_),w(),x.value=_,j(_)):alert("You are already on the current site scope or it is invalid.")},v.onclick=async()=>{const e=x.value;if("global"===e)return alert("Cannot delete Global scope.");if(confirm(`Delete rules for "${e}"?`)){await u(e,[]),await m(e,[]);const t=h.indexOf(e);t>-1&&h.splice(t,1),w(),x.value="global",j("global")}};const k=document.createElement("div");k.style.display="flex",k.style.flexDirection="column",k.style.gap="14px",n.appendChild(k);const j=async n=>{if(k.innerHTML="","global"===n){const n=d("Profile Management");await async function(n){const o=await a(["active_profile_id"]),l=await async function(){const e=await r(),t=[],n=[];return Object.entries(e.profiles).forEach(([e,o])=>{const a={id:e,name:o.name||"Unnamed"};"default"===e?t.unshift(a):"manhwa"===e?t.push(a):n.push(a)}),n.sort((e,t)=>e.name.localeCompare(t.name)),[...t,...n]}(),c=o.active_profile_id;Object.assign(n.style,{display:"flex",flexDirection:"column",gap:"10px"});const d=document.createElement("div");Object.assign(d.style,{display:"flex",gap:"8px",flexWrap:"wrap",alignItems:"center"});const p=document.createElement("select");Object.assign(p.style,{padding:"8px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"6px",minWidth:"180px",flex:"1"}),l.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name+(e.id===c?" (Active)":"")+(["default","manhwa"].includes(e.id)?" [System]":""),p.appendChild(t)}),p.value=c,p.onchange=async()=>{await i(p.value),location.reload()},d.appendChild(p);const u=document.createElement("div");Object.assign(u.style,{display:"flex",gap:"6px"});const m=(e,t,n,o="primary")=>{const a=document.createElement("button");return a.textContent=e,a.title=t,Object.assign(a.style,{padding:"8px 12px",borderRadius:"6px",border:"none",cursor:"pointer",background:"danger"===o?"#7f1d1d":"#374151",color:"white"}),a.onclick=n,a};u.appendChild(m("ðŸ“‹","Duplicate Profile",async()=>{const e=prompt("New profile name (copy of current):",l.find(e=>e.id===c).name+" Copy");if(e){const t=await s(e,c);await i(t),location.reload()}})),u.appendChild(m("âž•","New Empty Profile",async()=>{const e=prompt("New profile name:");if(e){const t=await s(e);await i(t),location.reload()}}));const f=["default","manhwa"].includes(c);f||u.appendChild(m("âœï¸","Rename Profile",async()=>{const t=l.find(e=>e.id===c).name,n=prompt("Rename profile:",t);n&&n!==t&&(await async function(t,n){const o=await r();return!!o.profiles[t]&&(o.profiles[t].name=n,await browser.storage.local.set({[e]:o}),!0)}(c,n),location.reload())})),u.appendChild(m("â†º","Reset Profile to Defaults",async()=>{confirm(`Reset "${l.find(e=>e.id===c).name}" to factory defaults?`)&&(await async function(n){const o=await r();if(!o.profiles[n])return!1;const a=o.profiles[n].name;return o.profiles[n]={...t,name:a},await browser.storage.local.set({[e]:o}),!0}(c),location.reload())},"danger"));const g=m("ðŸ—‘ï¸","Delete Profile",async()=>{confirm("Delete this profile permanently?")&&(await async function(t){const n=await r();return"default"!==t&&"manhwa"!==t&&(delete n.profiles[t],n.global.active_profile_id===t&&(n.global.active_profile_id="default"),await browser.storage.local.set({[e]:n}),!0)}(c),location.reload())},"danger");f&&(g.disabled=!0),f&&(g.style.opacity="0.5"),u.appendChild(g),d.appendChild(u),n.appendChild(d)}(n),k.appendChild(n)}const c=d("Find & Replace Rules"),g=document.createElement("div");g.textContent="Characters/words to replace in the OCR text",g.style.color="#9ca3af",g.style.fontSize="13px",g.style.marginBottom="10px",c.insertBefore(g,c.children[1]);const b=await async function(e){if("global"===e){const e=await a(["user_replacements","user_deletions"]);return{replacements:e.user_replacements||[],deletions:e.user_deletions||[]}}{const t=`user_replacements_${e}`,n=`user_deletions_${e}`,o=await browser.storage.local.get([t,n]);return{replacements:o[t]||[],deletions:o[n]||[]}}}(n);if(function(e,t,n){const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.gap="8px";const a=document.createElement("div");a.style.display="flex",a.style.gap="12px",a.style.alignItems="center",a.style.flexWrap="wrap",a.style.margin="0 auto";const l=document.createElement("input");l.placeholder="Character to Find",Object.assign(l.style,{width:"150px",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const s=document.createElement("input");s.placeholder="Replace With",Object.assign(s.style,{width:"150px",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const i=document.createElement("div");i.textContent="â†’",i.style.color="#9ca3af",i.style.fontSize="18px",i.style.display="flex",i.style.alignItems="center",i.style.padding="0 4px",a.appendChild(l),a.appendChild(i),a.appendChild(s);const r=document.createElement("div");r.style.display="flex",r.style.gap="10px",r.style.justifyContent="center",r.style.fontSize="12px",r.innerHTML='\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_rgx"> Regex</label>\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_case"> Case</label>\n        <label style="color:#d1d5db; display:flex; gap:4px; align-items:center; cursor:pointer"><input type="checkbox" id="adv_word"> Word</label>\n    ';const c=document.createElement("button");c.textContent="Add",Object.assign(c.style,{padding:"8px 10px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer",width:"72px",alignSelf:"center"}),o.appendChild(a),o.appendChild(r),o.appendChild(c),e.appendChild(o);const d=document.createElement("div");d.style.marginTop="12px",d.style.display="grid",d.style.gridTemplateColumns="1fr 1fr",d.style.gap="8px";const p=()=>{d.innerHTML="",t.forEach((e,o)=>{const a=document.createElement("div");Object.assign(a.style,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",padding:"6px 8px",background:"#071022",borderRadius:"8px",minHeight:"36px",boxSizing:"border-box"});const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="2px",l.style.marginRight="6px";const s=document.createElement("button");s.textContent="â–²",s.onclick=()=>u(o,o-1);const i=document.createElement("button");i.textContent="â–¼",i.onclick=()=>u(o,o+1),[s,i].forEach(e=>{Object.assign(e.style,{fontSize:"8px",padding:"0",background:"transparent",border:"none",color:"#6b7280",cursor:"pointer"})}),o>0&&l.appendChild(s),o<t.length-1&&l.appendChild(i),a.appendChild(l);const r=document.createElement("div"),c=[];e.isRegex&&c.push("R"),e.caseSensitive&&c.push("C"),e.wholeWord&&c.push("W");const f=c.length?`<sup style="color:#f59e0b; margin-left:2px">${c.join("")}</sup>`:"";r.innerHTML=`<span style="color:#e6eef8">${e.find}</span> <span style="color:#6b7280">â†’</span> <span style="color:#a5f3fc">${e.replace}</span> ${f}`,Object.assign(r.style,{fontSize:"13px",flex:"1",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",userSelect:"none"}),r.style.cursor="pointer",r.style.opacity=!1!==e.enabled?"1":"0.5",r.onclick=async()=>{t[o].enabled=!(!1!==t[o].enabled),await m(n,t),p()},a.appendChild(r);const g=document.createElement("button");g.textContent="âœ•",Object.assign(g.style,{padding:"4px",borderRadius:"4px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer",marginLeft:"8px",fontSize:"12px",width:"24px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center"}),g.onclick=async e=>{e.preventDefault(),t.splice(o,1),await m(n,t),p()},a.appendChild(g),d.appendChild(a)})},u=async(e,o)=>{if(o<0||o>=t.length)return;const a=t.splice(e,1)[0];t.splice(o,0,a),await m(n,t),p()};p(),e.appendChild(d),c.onclick=async()=>{const e=l.value,o=s.value;if(!e)return;const a={find:e,replace:o,isRegex:document.getElementById("adv_rgx").checked,caseSensitive:document.getElementById("adv_case").checked,wholeWord:document.getElementById("adv_word").checked,enabled:!0};t.push(a),await m(n,t),p(),l.value="",s.value=""}}(c,b.replacements,n),function(e,t,n){const o=document.createElement("h4");o.textContent="Characters to Delete",o.style.margin="12px 0 6px 0",o.style.fontSize="15px",e.appendChild(o);const a=document.createElement("div");a.textContent="These characters will be removed from the OCR text",a.style.color="#9ca3af",a.style.fontSize="13px",e.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.gap="8px",l.style.alignItems="center",l.style.marginTop="8px";const s=document.createElement("input");s.placeholder="Character to Delete",Object.assign(s.style,{flex:"1",padding:"8px",borderRadius:"6px",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a"});const i=document.createElement("button");i.textContent="Add",Object.assign(i.style,{padding:"8px 10px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer",width:"72px",flex:"0 0 auto"}),l.appendChild(s),l.appendChild(i),e.appendChild(l);const r=document.createElement("div");r.style.display="flex",r.style.gap="10px",r.style.marginTop="6px",r.style.fontSize="11px",r.style.color="#9ca3af",r.innerHTML='\n        <span>Safe if between: </span>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_let">Letters</label>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_num">Numbers</label>\n        <label style="display:flex;gap:4px;cursor:pointer"><input type="checkbox" id="del_wrd">Inside Words</label>\n    ',e.appendChild(r);const c=document.createElement("div");c.style.marginTop="8px",c.style.display="flex",c.style.flexWrap="wrap",c.style.gap="6px";const d=()=>{c.innerHTML="",t.forEach((e,o)=>{const a="string"==typeof e?e:e.char,l=document.createElement("div");Object.assign(l.style,{display:"inline-flex",alignItems:"center",gap:"8px",padding:"6px 8px",background:"#07202a",color:"#e6eef8",borderRadius:"8px",border:"1px solid rgba(255,255,255,0.03)"});let s=a;"string"!=typeof e&&(e.ignoreBetweenLetters||e.ignoreBetweenNumbers||e.ignoreInsideWords)&&(s+="*");const i=document.createElement("span");i.textContent=s,i.style.fontSize="13px",i.style.marginRight="4px",s.endsWith("*")&&(i.title="Has context protection rules");const r=document.createElement("button");r.textContent="âœ•",Object.assign(r.style,{padding:"2px 4px",borderRadius:"4px",border:"none",background:"#ef4444",color:"#fff",cursor:"pointer",fontSize:"10px"}),r.onclick=async()=>{t.splice(o,1),await u(n,t),d()},l.appendChild(i),l.appendChild(r),c.appendChild(l)})};d(),e.appendChild(c),i.onclick=async()=>{const e=s.value;if(!e)return;const o={char:e,ignoreBetweenLetters:document.getElementById("del_let").checked,ignoreBetweenNumbers:document.getElementById("del_num").checked,ignoreInsideWords:document.getElementById("del_wrd").checked};t.push(o),await u(n,t),d(),s.value=""}}(c,b.deletions,n),k.appendChild(c),"global"===n){const e=d("Pipeline Configuration");await async function(e){const t=document.createElement("h3");t.textContent="Image Preprocessing",Object.assign(t.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(t);const n=await a(["preprocess_resize","preprocess_grayscale","preprocess_contrast","preprocess_blur","preprocess_threshold","preprocess_morphology","preprocess_borders"]);[{key:"preprocess_resize",label:"Resize Image (2x)",default:!0},{key:"preprocess_grayscale",label:"Grayscale",default:!0},{key:"preprocess_contrast",label:"Enhance Contrast",default:!0},{key:"preprocess_blur",label:"Median Blur",default:!1},{key:"preprocess_threshold",label:"Adaptive Threshold",default:!1},{key:"preprocess_morphology",label:"Morphology (Clean)",default:!1}].forEach(t=>{e.appendChild(p(t.label,void 0!==n[t.key]?n[t.key]:t.default,async e=>await l({[t.key]:e})))})}(e);const t=document.createElement("div");t.style.borderTop="1px solid #374151",t.style.margin="12px 0",e.appendChild(t),await async function(e,t){if("global"!==t)return;const n=document.createElement("h3");n.textContent="Text Cleaning Pipeline",Object.assign(n.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(n);const o=await a(["clean_noise","noise_aggression","clean_normalize","clean_dict","dict_strength","dict_ignore_caps","manhwa_mode"]);[{key:"clean_noise",label:"Noise Cleaning (Remove Artifacts)",default:!0},{key:"clean_normalize",label:"Normalize Whitespace (Fix spaces)",default:!0},{key:"clean_dict",label:"Dictionary Correction (Levenshtein)",default:!1},{key:"dict_ignore_caps",label:"Dictionary: Ignore ALL CAPS",default:!0},{key:"manhwa_mode",label:"Manhwa Mode (Vertical Text Fixes)",default:!1}].forEach(t=>{e.appendChild(p(t.label,void 0!==o[t.key]?o[t.key]:t.default,async e=>await l({[t.key]:e})))});const s=document.createElement("div");Object.assign(s.style,{display:"flex",alignItems:"center",justifyContent:"space-between",background:"#1f2937",padding:"8px",borderRadius:"6px",marginTop:"8px"}),s.innerHTML='<span style="font-size:14px">Noise Aggression</span>';const i=document.createElement("select");Object.assign(i.style,{background:"#374151",color:"white",border:"none",padding:"4px"}),["low","medium","high"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)}),i.value=o.noise_aggression||"medium",i.onchange=async()=>await l({noise_aggression:i.value}),s.appendChild(i),e.appendChild(s);const r=document.createElement("div");Object.assign(r.style,{display:"flex",alignItems:"center",justifyContent:"space-between",background:"#1f2937",padding:"8px",borderRadius:"6px",marginTop:"8px"}),r.innerHTML='<span style="font-size:14px">Dict Strength (Distance)</span>';const c=document.createElement("select");Object.assign(c.style,{background:"#374151",color:"white",border:"none",padding:"4px"}),["1","2","3"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)}),c.value=o.dict_strength||1,c.onchange=async()=>await l({dict_strength:parseInt(c.value)}),r.appendChild(c),e.appendChild(r)}(e,n);const o=document.createElement("div");o.style.borderTop="1px solid #374151",o.style.margin="12px 0",e.appendChild(o),await async function(e,t){if("global"!==t)return;const n=document.createElement("h3");n.textContent="Text Reconstruction",Object.assign(n.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(n);const o=await a(["reconstruct_text","reconstruct_merge","reconstruct_stabilize"]);e.appendChild(p("Enable Reconstruction",!0===o.reconstruct_text,async e=>await l({reconstruct_text:e})));const s=document.createElement("div");s.style.marginLeft="20px",s.style.marginTop="8px",s.appendChild(p("Merge Broken Lines",!1!==o.reconstruct_merge,async e=>await l({reconstruct_merge:e}))),s.appendChild(p("Stabilize Sentences",!1!==o.reconstruct_stabilize,async e=>await l({reconstruct_stabilize:e}))),e.appendChild(s)}(e,n),k.appendChild(e);const s=d("UI & Behavior");await async function(e){const t=document.createElement("h3");t.textContent="UI Settings",Object.assign(t.style,{fontSize:"18px",borderBottom:"1px solid #4b5563",paddingBottom:"8px"}),e.appendChild(t);const n=await a(["floating_button_enabled","floating_button_mode","floating_button_blacklist","floating_button_whitelist","debug_mode"]);e.appendChild(p("Show Floating Button",!1!==n.floating_button_enabled,async e=>await l({floating_button_enabled:e})));const o=document.createElement("div");o.style.marginLeft="20px",o.style.marginBottom="20px",o.style.display=!1!==n.floating_button_enabled?"block":"none";const s=document.createElement("div");Object.assign(s.style,{display:"flex",alignItems:"center",marginBottom:"10px",gap:"10px"}),s.innerHTML='<span style="font-size:14px; color:#d1d5db">Filter Mode:</span>';const i=document.createElement("select");Object.assign(i.style,{padding:"4px 8px",borderRadius:"4px",background:"#374151",color:"white",border:"none"});const r=document.createElement("option");r.value="blacklist",r.textContent="Show Everywhere (Excluded Sites)";const c=document.createElement("option");c.value="whitelist",c.textContent="Hide Everywhere (Allowed Sites)",i.appendChild(r),i.appendChild(c),i.value=n.floating_button_mode||"blacklist",i.onchange=async()=>{await l({floating_button_mode:i.value}),u(i.value)},s.appendChild(i),o.appendChild(s);const d=document.createElement("div");o.appendChild(d);const u=async e=>{d.innerHTML="";const t=(await a("blacklist"===e?["floating_button_blacklist"]:["floating_button_whitelist"]))["blacklist"===e?"floating_button_blacklist":"floating_button_whitelist"]||[],n=document.createElement("p");n.style.fontSize="12px",n.style.color="#9ca3af",n.style.marginBottom="8px",n.textContent="blacklist"===e?"Button will NOT appear on these URLs (one per line):":"Button WILL appear ONLY on these URLs (one per line):",d.appendChild(n);const o=document.createElement("textarea");o.rows=5,Object.assign(o.style,{width:"100%",background:"#0b1220",color:"#e6eef8",border:"1px solid #25303a",borderRadius:"4px",padding:"8px",fontFamily:"monospace",boxSizing:"border-box"}),o.value=t.join("\n"),o.onchange=async()=>{const t=o.value.split("\n").map(e=>e.trim()).filter(e=>e),n="blacklist"===e?"floating_button_blacklist":"floating_button_whitelist";await l({[n]:t})},d.appendChild(o)};await u(n.floating_button_mode||"blacklist"),e.appendChild(o),e.appendChild(p("Debug Mode",!0===n.debug_mode,async e=>await l({debug_mode:e})));const m=e.querySelector('input[type="checkbox"]');if(m){const e=m.onchange;m.onchange=t=>{o.style.display=t.target.checked?"block":"none",e&&e(t)}}}(s),k.appendChild(s)}if("global"===n){const n=document.createElement("section");Object.assign(n.style,{background:"#111827",padding:"12px",borderRadius:"8px",display:"flex",gap:"8px",justifyContent:"center"}),await async function(n){const a=document.createElement("button");a.textContent="ðŸ“¥ Import Settings";const l=document.createElement("button");l.textContent="ðŸ“¤ Export Settings";const s=document.createElement("button");s.textContent="âš ï¸ Reset",[a,l,s].forEach(e=>Object.assign(e.style,{padding:"8px 12px",borderRadius:"6px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"})),s.style.background="#7f1d1d",l.onclick=()=>{(async function(e="full",t={}){const n=await r();if("full"===e){const e={version:1,timestamp:Date.now(),type:"full_backup",data:n,site_replacements:{},site_deletions:{}},t=await browser.storage.local.get(null);return Object.keys(t).forEach(n=>{n.startsWith("user_replacements_site:")&&(e.site_replacements[n]=t[n]),n.startsWith("user_deletions_site:")&&(e.site_deletions[n]=t[n])}),JSON.stringify(e,null,2)}if("profile"===e){const e=t.id||n.global.active_profile_id,o=n.profiles[e];if(!o)throw new Error("Profile not found");const a={version:1,timestamp:Date.now(),type:"profile_export",name:o.name,data:o};return JSON.stringify(a,null,2)}})("full").then(e=>{const t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="ocr-settings-all.json",o.click()})},a.onclick=()=>{const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=async n=>{const o=n.target.files[0];if(!o)return;const a=await o.text();try{JSON.parse(a),confirm("Import settings? This will overwrite existing configuration.")&&(await async function(n,o="merge"){let a;try{a=JSON.parse(n)}catch(e){throw new Error("Invalid JSON format")}if(!a.version||!a.type)throw new Error("Invalid settings file (missing metadata)");const l=await r();if("profile_export"===a.type){const n=`profile_${Date.now()}_imp`,s=a.name+("merge"===o?" (Imported)":"");return l.profiles[n]={...t,...a.data},l.profiles[n].name=s,await browser.storage.local.set({[e]:l}),{success:!0,message:`Imported profile "${s}"`}}if("full_backup"===a.type){const t=a.data;if("replace"===o)return await browser.storage.local.set({[e]:t}),a.site_replacements&&await browser.storage.local.set(a.site_replacements),a.site_deletions&&await browser.storage.local.set(a.site_deletions),{success:!0,message:"Settings fully restored."};if("merge"===o){let n=0;for(const[e,o]of Object.entries(t.profiles))if(l.profiles[e]){const t=`${e}_merge_${Date.now()}`;l.profiles[t]={...o,name:o.name+" (Imported)"},n++}else l.profiles[e]=o,n++;return await browser.storage.local.set({[e]:l}),{success:!0,message:`Merged ${n} profiles.`}}}throw new Error("Unknown import type")}(a,"merge"),location.reload())}catch(n){alert(" invalid file ")}},n.click()},s.onclick=()=>{confirm("Factory Reset? This cannot be undone.")&&async function(n,a){const l=await r();if("profile"===n){const n=l.global.active_profile_id,o=l.profiles[n].name;return l.profiles[n]={...t,name:o},await browser.storage.local.set({[e]:l}),!0}if("full"===n){await browser.storage.local.clear();const n={global:{...o},profiles:{default:{...t}}};return await browser.storage.local.set({[e]:n}),!0}if("section"===n){if(!Array.isArray(a))return!1;const n=l.global.active_profile_id;return a.forEach(e=>{t.hasOwnProperty(e)&&(l.profiles[n][e]=t[e])}),await browser.storage.local.set({[e]:l}),!0}}("full").then(()=>location.reload())},n.appendChild(a),n.appendChild(l),n.appendChild(s)}(n),k.appendChild(n)}const y=document.createElement("div");y.style.display="flex",y.style.justifyContent="center",y.style.marginTop="6px",y.style.alignItems="center",y.style.gap="8px";const x=document.createElement("div");x.style.display="flex",x.style.justifyContent="center",x.style.alignItems="center",x.style.gap="8px",x.style.marginTop="6px";const h=document.createElement("input");h.type="checkbox",h.checked=!0,h.disabled=!0;const _=document.createElement("label");_.textContent="Auto-save (Always On)",_.style.color="#e6eef8",_.style.fontSize="13px",x.appendChild(h),x.appendChild(_),k.appendChild(x);const w=document.createElement("button");w.textContent="Close",Object.assign(w.style,{padding:"10px 14px",borderRadius:"8px",border:"none",background:"#4f46e5",color:"#fff",cursor:"pointer"}),w.onclick=()=>{f&&f()},y.appendChild(w),k.appendChild(y)};await j(c)}(h,"global")}function d(e){const t=document.createElement("section");if(Object.assign(t.style,{background:"#111827",padding:"12px",borderRadius:"8px"}),e){const n=document.createElement("h3");n.textContent=e,n.style.margin="0 0 8px 0",n.style.fontSize="16px",t.appendChild(n)}return t}function p(e,t,n){const o=document.createElement("label");Object.assign(o.style,{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer",background:"#1f2937",padding:"8px",borderRadius:"6px",marginBottom:"8px"});const a=document.createElement("input");return a.type="checkbox",a.checked=t,a.onchange=e=>n(e.target.checked),o.appendChild(a),o.appendChild(document.createTextNode(e)),o}async function u(e,t){if("global"===e)await l({user_deletions:t});else{const n=`user_deletions_${e}`;await browser.storage.local.set({[n]:t})}}async function m(e,t){if("global"===e)await l({user_replacements:t});else{const n=`user_replacements_${e}`;await browser.storage.local.set({[n]:t})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c()})();